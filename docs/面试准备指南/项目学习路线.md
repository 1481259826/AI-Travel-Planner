# 项目学习路线 - 大模型开发方向

本文档帮助你系统地理解这个项目，为大模型开发方向的实习面试做准备。

## 目录

- [学习优先级](#学习优先级)
- [第一优先级：LangGraph 多智能体系统](#第一优先级langgraph-多智能体系统)
- [第二优先级：LLM-as-Judge 评估系统](#第二优先级llm-as-judge-评估系统)
- [第三优先级：Prompt Engineering](#第三优先级prompt-engineering)
- [第四优先级：MCP 协议](#第四优先级mcp-协议)
- [第五优先级：可观测性](#第五优先级可观测性)
- [不需要深入的部分](#不需要深入的部分)
- [具体学习步骤](#具体学习步骤)
- [面试表达建议](#面试表达建议)

---

## 学习优先级

| 优先级 | 内容 | 重要程度 | 预计时间 |
|--------|------|----------|----------|
| ⭐⭐⭐ | LangGraph 多智能体系统 | 核心，必须掌握 | 4-5 小时 |
| ⭐⭐⭐ | LLM-as-Judge 评估系统 | 核心，必须掌握 | 2-3 小时 |
| ⭐⭐ | Prompt Engineering | 基本功，需要掌握 | 2 小时 |
| ⭐ | MCP 协议 | 加分项，了解即可 | 1 小时 |
| ⭐ | 可观测性 | 加分项，了解即可 | 30 分钟 |

---

## 第一优先级：LangGraph 多智能体系统

这是最核心的部分，也是大模型开发岗位面试最关心的内容。

### 需要掌握的概念

#### 1. 状态图编排（StateGraph）

**核心思想**：
- **节点（Node）** = Agent 函数
- **边（Edge）** = 状态转移
- **状态（State）** = 所有 Agent 共享的数据

**为什么用状态图而不是简单的顺序调用？**
- 原生支持循环（预算超支重试）
- 原生支持并行执行（多个 Agent 同时工作）
- 内置检查点，支持中断恢复
- 状态管理清晰，易于调试

#### 2. Agent 的设计模式

每个 Agent 是一个函数：
```typescript
async function myAgent(state: TripState): Promise<Partial<TripState>> {
  // 1. 从 state 读取需要的数据
  const { userInput, weather } = state

  // 2. 执行业务逻辑（调用 AI、调用 API 等）
  const result = await doSomething()

  // 3. 返回要更新的状态字段
  return { myResult: result }
}
```

**关键点**：
- 输入：完整的状态对象
- 输出：只返回要更新的字段（Partial）
- LangGraph 自动合并更新

#### 3. 三个关键机制

**并行执行（Fan-out/Fan-in）**：
```
Planner
   │
   ├─→ Hotel Agent    ─┐
   ├─→ Transport Agent ├─→ Budget Critic
   └─→ Dining Agent   ─┘
```
从一个节点发出多条边，多个 Agent 并行执行，结果自动汇合。

**条件分支**：
```typescript
workflow.addConditionalEdges(
  "budget_critic",
  (state) => {
    if (state.budgetResult?.isWithinBudget) return "finalize"
    if (state.retryCount >= 3) return "finalize"  // 最大重试次数
    return "retry"
  },
  {
    finalize: "finalize",
    retry: "itinerary_planner",  // 循环回去重新规划
  }
)
```

**状态共享**：
```typescript
const TripStateAnnotation = Annotation.Root({
  weather: Annotation<WeatherOutput | null>({
    default: () => null,
    reducer: (_, newVal) => newVal,  // 新值覆盖旧值
  }),
  retryCount: Annotation<number>({
    default: () => 0,
    reducer: (current, delta) => current + delta,  // 累加
  }),
})
```

### 需要阅读的文件

按这个顺序阅读：

| 顺序 | 文件路径 | 内容说明 | 难度 |
|------|----------|----------|------|
| 1 | `lib/agents/state.ts` | 状态定义，了解有哪些字段 | ⭐ |
| 2 | `lib/agents/workflow.ts` | 工作流定义，节点和边的连接 | ⭐⭐ |
| 3 | `lib/agents/nodes/weather-scout.ts` | 最简单的 Agent 示例 | ⭐ |
| 4 | `lib/agents/nodes/budget-critic.ts` | 有条件判断的 Agent | ⭐⭐ |
| 5 | `lib/agents/nodes/itinerary-planner.ts` | 核心规划 Agent | ⭐⭐⭐ |

### 架构图（必须能画出来）

```
用户输入
    │
    ▼
┌───────────────────┐
│  Weather Scout    │  获取天气 + 生成策略标签
└───────────────────┘
    │
    ▼
┌───────────────────┐
│ Itinerary Planner │  生成行程骨架
└───────────────────┘
    │
    ▼
┌───────────────────┐
│Attraction Enricher│  增强景点详情
└───────────────────┘
    │
    ├──────────────────┬──────────────────┐
    ▼                  ▼                  ▼
┌──────────┐    ┌──────────┐    ┌──────────┐
│  Hotel   │    │Transport │    │  Dining  │   ← 并行执行
│  Agent   │    │  Agent   │    │  Agent   │
└──────────┘    └──────────┘    └──────────┘
    │                  │                  │
    └──────────────────┴──────────────────┘
                       │
                       ▼
              ┌───────────────────┐
              │  Budget Critic    │  预算审计
              └───────────────────┘
                       │
              ┌───────┴───────┐
              │ 超预算?       │
              │ Yes → 重试    │  ← 条件分支 + 循环
              │ No  → 完成    │
              └───────────────┘
                       │
                       ▼
              ┌───────────────────┐
              │  Finalize Agent   │  生成最终行程
              └───────────────────┘
```

### 面试必答题

**Q: 描述一下多智能体协作的流程**
> 用户提交旅行需求后，首先 Weather Scout 获取目的地天气并生成策略标签（如"优先室内"）。然后 Itinerary Planner 根据天气策略生成行程骨架。接着 Attraction Enricher 增强景点详情。之后 Hotel、Transport、Dining 三个 Agent 并行执行，分别推荐住宿、计算交通、推荐餐厅。最后 Budget Critic 审计总预算，如果超支就返回 Planner 重新规划（最多 3 次），通过后由 Finalize Agent 生成最终行程。

**Q: 为什么选择 LangGraph？**
> 1. 原生支持循环，预算重试不需要手写 while 循环
> 2. 原生支持并行执行，提升效率
> 3. 类型安全的状态管理，通过 Annotation 定义
> 4. 内置检查点，支持长任务中断恢复
> 5. 状态图可视化，便于理解和调试

**Q: 预算重试机制怎么实现的？**
> 使用 LangGraph 的条件边（addConditionalEdges）。Budget Critic 计算总成本，如果超过预算的 110%，返回 "retry"，条件边会将流程导向 Itinerary Planner 重新规划。同时 retryCount 累加，超过 3 次强制结束，避免死循环。

**Q: 多个 Agent 怎么共享状态？**
> 通过 Annotation.Root 定义统一的状态 Schema。每个 Agent 接收完整状态，返回 Partial 更新。LangGraph 通过 reducer 函数自动合并，比如 weather 字段用新值覆盖，retryCount 字段累加。

---

## 第二优先级：LLM-as-Judge 评估系统

这是大模型开发的核心能力之一——如何评估 AI 生成质量。

### 核心概念

#### 什么是 LLM-as-Judge？

用 LLM 来评估另一个 LLM 的输出质量，代替人工评估。

**优势**：
- 可扩展：自动化评估，无需人工
- 一致性：同一标准，避免主观差异
- 多维度：可同时评估多个方面

#### 项目中的实现

**5 个评估维度**：

| 维度 | 权重 | 说明 |
|------|------|------|
| 逻辑性 (logical) | 25% | 行程安排是否合理，时间顺序是否正确 |
| 完整性 (completeness) | 20% | 是否包含所有必要信息 |
| 可行性 (feasibility) | 25% | 景点开放时间、交通方式是否可行 |
| 预算符合度 (budget) | 20% | 总花费是否在预算范围内 |
| 格式正确性 (format) | 10% | JSON 格式是否正确，字段是否完整 |

**评分标准**：
- 每个维度 1-5 分
- 加权平均得到总分
- 通过阈值：3.5/5.0

### 需要阅读的文件

| 顺序 | 文件路径 | 内容说明 | 难度 |
|------|----------|----------|------|
| 1 | `evals/README.md` | 评估系统概述 | ⭐ |
| 2 | `evals/prompts/judge.ts` | Judge Prompt 设计 | ⭐⭐ |
| 3 | `evals/lib/evaluator.ts` | 评估执行逻辑 | ⭐⭐ |
| 4 | `evals/lib/types.ts` | 类型定义 | ⭐ |
| 5 | `evals/cases/` | 测试用例 | ⭐ |

### 核心代码示例

**Judge Prompt 结构（`evals/prompts/judge.ts`）**：
```typescript
const JUDGE_PROMPT = `你是一个专业的旅行行程评估专家。
请根据以下维度评估 AI 生成的行程：

1. 逻辑性 (1-5分)：行程安排是否合理
2. 完整性 (1-5分)：信息是否完整
3. 可行性 (1-5分)：是否实际可执行
4. 预算符合度 (1-5分)：是否在预算内
5. 格式正确性 (1-5分)：结构是否正确

用户需求：{userInput}
AI 生成的行程：{generatedItinerary}

请输出 JSON 格式的评分...`
```

**评估执行（`evals/lib/evaluator.ts`）**：
```typescript
async function evaluateItinerary(
  userInput: TripFormData,
  generatedItinerary: Itinerary
): Promise<EvaluationResult> {
  // 1. 构建 Judge Prompt
  const prompt = buildJudgePrompt(userInput, generatedItinerary)

  // 2. 调用 LLM 进行评估
  const response = await callLLM(prompt)

  // 3. 解析评分结果
  const scores = parseScores(response)

  // 4. 计算加权总分
  const totalScore = calculateWeightedScore(scores)

  return { scores, totalScore, passed: totalScore >= 3.5 }
}
```

### 面试必答题

**Q: 为什么用 LLM 来评估而不是规则？**
> 规则只能检查格式和数值范围，无法评估"行程是否合理"这种语义层面的质量。LLM 可以理解上下文，判断"上午去夜市"这种不合理的安排。

**Q: 如何保证评估的一致性？**
> 1. 使用结构化的评分维度和标准
> 2. 要求输出 JSON 格式，便于解析
> 3. 每个维度有明确的评分标准（1-5 分的定义）
> 4. 使用温度参数 0 减少随机性

**Q: 评估系统怎么用于改进生成质量？**
> 1. 识别低分维度，针对性优化 Prompt
> 2. 收集失败案例，作为 Few-shot 示例
> 3. 设置自动重试：低于阈值时触发重新生成
> 4. 统计各维度得分分布，发现系统性问题

**Q: 20 个测试用例覆盖哪些场景？**
> 5 大类：
> - 基础场景：正常的旅行需求
> - 边界条件：极端预算、超长行程
> - 特殊需求：亲子游、无障碍、素食等
> - 异常输入：空字段、非法值
> - 复杂场景：多城市、跨境游

---

## 第三优先级：Prompt Engineering

大模型开发的基本功，需要理解如何设计有效的 Prompt。

### 需要掌握的内容

#### Prompt 的结构

```typescript
// System Prompt：定义 AI 的角色和输出格式
const SYSTEM_PROMPT = `你是专业的旅行规划师...

输出格式要求：
{
  "days": [...],
  "totalAttractions": number
}
`

// User Prompt：提供具体的输入数据
const userPrompt = `
用户需求：${JSON.stringify(userInput)}
天气策略：${JSON.stringify(weather.strategyTags)}
`
```

#### 关键技巧

1. **角色设定**：明确 AI 的身份和专业领域
2. **输出格式约束**：在 Prompt 中明确 JSON Schema
3. **Few-shot 示例**：提供输入输出示例
4. **策略传递**：将上游 Agent 的策略标签传递给下游

### 需要阅读的文件

| 文件路径 | 说明 |
|----------|------|
| `lib/agents/prompts/weather-scout.ts` | 简单的 Prompt 示例 |
| `lib/agents/prompts/itinerary-planner.ts` | 复杂的 Prompt，有格式约束 |
| `lib/agents/prompts/budget-critic.ts` | 纯计算逻辑的 Prompt |

### 面试可能的问题

**Q: 如果 AI 返回的 JSON 格式错误怎么办？**
> 项目中实现了多层容错：
> 1. Prompt 中明确要求输出纯 JSON
> 2. 解析时支持 markdown 代码块包裹的 JSON
> 3. 使用正则提取 JSON 部分
> 4. 解析失败时有默认值兜底

---

## 第四优先级：MCP 协议

MCP（Model Context Protocol）是 Anthropic 提出的标准化工具调用协议，了解这个会加分。

### 核心概念

**什么是 MCP？**
- 让 AI Agent 以统一方式调用外部工具/API
- 定义了工具的输入输出 Schema
- 支持多种连接方式（SSE、stdio）

**为什么需要 MCP？**
- 不同 API 格式不同，MCP 统一封装
- Agent 不需要知道 API 细节，只需要知道工具名称和参数
- 便于测试和 Mock

### 项目中的实现

```typescript
// lib/agents/mcp-client.ts
class MCPClient {
  // 9 个 MCP 工具
  async getWeatherForecast(city: string): Promise<WeatherData>
  async searchPOI(params: POISearchParams): Promise<POI[]>
  async getDrivingRoute(origin, destination): Promise<Route>
  // ...
}
```

### 需要阅读的文件

| 文件路径 | 说明 |
|----------|------|
| `lib/agents/mcp-client.ts` | MCP 客户端封装 |
| `mcp-servers/amap/src/tools/` | MCP 工具实现（可选） |

---

## 第五优先级：可观测性

体现生产级思维，快速了解即可。

### 三个组成部分

1. **追踪（Tracing）**：记录每个 Agent 的执行过程
   - 文件：`lib/agents/tracer.ts`
   - 支持 Console、JSON、LangSmith 三种后端

2. **指标（Metrics）**：Prometheus 格式的监控数据
   - 文件：`lib/agents/metrics.ts`
   - 端点：`/api/metrics`

3. **调试页面**：可视化工作流执行状态
   - 页面：`/dashboard/debug`（开发环境）

### 面试简单提一下

> "项目还实现了可观测性体系，包括追踪、指标收集和调试页面，方便监控 Agent 的执行情况和排查问题。"

---

## 不需要深入的部分

以下内容和大模型开发关系不大，面试时一句话带过即可：

| 内容 | 面试时怎么说 |
|------|--------------|
| PWA / 离线缓存 | "支持离线访问，用 IndexedDB 缓存数据" |
| Supabase / 数据库 | "使用 Supabase 做认证和数据存储" |
| 组件重构 | "做了组件层的优化，提高复用性" |
| 地图集成 | "集成了高德地图显示景点和路线" |

---

## 具体学习步骤

### 第一步：跑通一次完整流程（1-2 小时）

```bash
# 1. 启动项目
npm run dev

# 2. 访问 http://localhost:3008

# 3. 登录后创建一个行程
#    - 填写：北京 → 杭州，3天，预算 5000

# 4. 观察控制台输出
#    - 看每个 Agent 的执行顺序
#    - 看执行耗时
#    - 看状态变化
```

### 第二步：读懂核心代码（4-5 小时）

**LangGraph 阅读顺序**：

```
1. lib/agents/state.ts
   └─ 理解：TripState 有哪些字段？每个字段什么意思？

2. lib/agents/workflow.ts
   └─ 理解：节点怎么连接？条件边怎么写？

3. lib/agents/nodes/weather-scout.ts
   └─ 理解：最简单的 Agent 长什么样？

4. lib/agents/prompts/weather-scout.ts
   └─ 理解：Prompt 怎么写的？

5. lib/agents/nodes/budget-critic.ts
   └─ 理解：条件判断逻辑在哪里？

6. lib/agents/nodes/itinerary-planner.ts
   └─ 理解：核心规划逻辑是什么？
```

**LLM-as-Judge 阅读顺序**：

```
1. evals/README.md
   └─ 理解：评估系统的整体设计

2. evals/prompts/judge.ts
   └─ 理解：Judge Prompt 怎么设计的？

3. evals/lib/evaluator.ts
   └─ 理解：评估流程是什么？

4. evals/cases/ 目录
   └─ 理解：测试用例怎么组织？
```

**阅读技巧**：
- 先看函数签名（输入输出类型）
- 再看主要逻辑流程
- 跳过错误处理细节

### 第三步：能画出架构图（1 小时）

1. 在纸上画出完整的流程图
2. 标注每个 Agent 的职责
3. 标注并行执行和条件分支
4. 用自己的话解释整个流程

### 第四步：准备面试问答（1-2 小时）

准备以下问题的答案：

| 问题 | 答案要点 |
|------|----------|
| 描述多智能体协作流程 | 8 个 Agent 的职责和执行顺序 |
| 为什么用 LangGraph | 循环、并行、检查点、类型安全 |
| 预算重试怎么实现 | 条件边 + retryCount + 最大次数限制 |
| 状态怎么共享 | Annotation + reducer |
| 什么是 LLM-as-Judge | 用 LLM 评估 LLM 输出质量 |
| 评估了哪些维度 | 逻辑性、完整性、可行性、预算、格式 |
| 如何保证评估一致性 | 结构化 Prompt + JSON 输出 + 温度 0 |
| JSON 格式错误怎么办 | 多层容错（代码块提取、正则、默认值） |
| Prompt 怎么设计 | 角色设定 + 格式约束 + 策略传递 |

---

## 面试表达建议

### 不要说

> "这个项目是 AI 帮我写的，我不太懂细节"

> "我只是按照教程做的"

### 要说

> "这是一个基于 LangGraph 的多智能体旅行规划系统。我设计了 8 个专家 Agent 通过状态图编排协作完成行程生成，核心挑战是处理预算超支时的自动重试，通过条件边实现了最多 3 次的重新规划循环..."

### 被追问时的应对

**如果被问到不懂的细节**：
> "这部分的具体实现我需要再看一下代码，但整体思路是..."

**如果被问到为什么这样设计**：
> "主要考虑是... 另外也对比过其他方案，比如..."

**如果被问到项目的不足**：
> "目前还有一些可以改进的地方，比如... 如果有时间我计划..."

---

## 延伸学习资源

### LangGraph 官方文档
- [LangGraph 快速入门](https://langchain-ai.github.io/langgraph/tutorials/introduction/)
- [LangGraph 概念文档](https://langchain-ai.github.io/langgraph/concepts/)

### 项目内部文档
- [多智能体架构升级计划](../架构设计/多智能体架构升级计划.md)
- [简历&面试准备](./简历&面试准备.md)

---

**最后更新**: 2025-12-01
