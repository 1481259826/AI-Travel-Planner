# 离线使用指南

AI Travel Planner 支持 PWA (Progressive Web App) 和离线功能，让您可以随时随地访问旅行计划，即使在没有网络连接的情况下。

## 功能概览

### 支持的离线功能

✅ **查看已缓存的行程**
浏览所有已访问过的行程详情

✅ **编辑现有行程**
离线状态下修改行程信息，恢复网络后自动同步

✅ **查看费用记录**
访问之前加载过的费用数据

✅ **查看地图**
已加载的地图数据可离线查看（需要事先加载）

### 不支持的离线功能

❌ 创建新行程（需要在线）
❌ 添加新费用记录（需要在线）
❌ 生成 AI 行程规划（需要在线）
❌ 实时地图更新（需要在线）

## 安装 PWA

### 在手机上安装

#### Android (Chrome)

1. 打开 AI Travel Planner 网站
2. 点击顶部的蓝色横幅"安装 AI 旅行规划"
3. 或点击浏览器菜单 (⋮) > "安装应用"
4. 确认安装

安装后，应用图标会出现在主屏幕上，点击即可像原生应用一样使用。

#### iPhone/iPad (Safari)

1. 打开 AI Travel Planner 网站
2. 点击底部的"分享"按钮 (□↑)
3. 向下滚动并点击"添加到主屏幕"
4. 输入名称（或使用默认名称）
5. 点击"添加"

### 在电脑上安装

#### Chrome/Edge

1. 打开 AI Travel Planner 网站
2. 地址栏右侧会出现安装图标 (⊕)
3. 点击图标
4. 在弹出的对话框中点击"安装"

安装后可以：
- 从开始菜单/启动台快速打开
- 拥有独立的窗口（无浏览器地址栏）
- 在任务栏/Dock 固定

## 使用离线功能

### 准备离线使用

在有网络连接时：

1. **登录账号**
   首次使用时登录您的账号

2. **浏览行程**
   访问您想要离线查看的行程
   系统会自动缓存这些数据

3. **查看费用**
   打开行程详情页的"费用追踪"标签
   费用数据会被缓存

4. **等待同步完成**
   右下角的同步状态显示"已同步"

现在您可以离线使用了！

### 离线使用

#### 识别离线状态

应用右上角会显示：
- 🟡 **黄色徽章"离线模式"** - 当前无网络连接
- 🟢 **绿色徽章"已同步"** - 在线且数据已同步
- 🟡 **橙色徽章"离线数据"** - 正在使用缓存数据

Dashboard 页面也会显示数据来源：
- 💾 **"离线数据"** - 使用本地缓存
- ☁️ **"已同步"** - 最新的服务器数据

#### 查看行程

1. 打开应用（即使离线）
2. Dashboard 显示所有已缓存的行程
3. 点击行程查看详情
4. 可以查看：
   - 行程日程
   - 费用记录
   - 地图（如果之前加载过）
   - 预算分析

#### 编辑行程

离线状态下，您可以：

1. 修改行程状态（草稿/已计划/进行中/已完成）
2. 更改行程信息
3. 标记完成的活动

操作步骤：
1. 打开要编辑的行程
2. 进行修改
3. 修改会立即保存到本地
4. 页面顶部显示"离线数据"徽章
5. 右下角显示"X 个待同步更改"

#### 恢复网络后

网络恢复后，应用会：

1. **自动同步**
   5分钟内自动将离线编辑同步到服务器

2. **显示通知**
   右上角显示绿色"已连接"徽章（3秒后消失）

3. **更新状态**
   右下角显示"正在同步..." → "已同步"

您也可以：
- 点击右下角的刷新按钮手动同步
- 点击"详情"查看同步进度

### 同步状态说明

右下角的同步状态卡片显示：

| 状态 | 说明 | 操作 |
|------|------|------|
| **正在同步...** | 正在上传离线编辑 | 等待完成 |
| **已同步** | 所有数据已同步 | 无需操作 |
| **X 个待同步更改** | 有离线编辑待上传 | 恢复网络或手动同步 |
| **同步失败** | 同步出错 | 点击重试 |

点击"详情"按钮可以查看：
- 待同步项数量
- 同步中项数量
- 失败项数量（如有）

### 数据冲突处理

如果您在多个设备上离线编辑同一行程：

**自动处理**
应用使用"最后修改优先"策略：
- 比较本地和服务器的修改时间
- 保留最新的版本
- 自动更新另一端

**示例**：
1. 手机A（离线）：12:00 修改行程状态为"进行中"
2. 手机B（在线）：12:05 修改行程状态为"已完成"
3. 手机A恢复网络：自动采用手机B的"已完成"状态（因为更新时间更晚）

💡 **最佳实践**：重要修改建议在有网络时进行，避免冲突。

## 管理离线数据

### 查看缓存信息

1. 打开 Dashboard
2. 点击顶部的"缓存"按钮
3. 查看缓存统计：
   - 缓存的行程数量
   - 缓存的费用记录数量
   - 待同步项数量

### 清除缓存

如果遇到问题或想释放空间：

1. 打开缓存管理器
2. 点击"清除所有缓存"
3. 确认操作
4. 页面自动刷新

⚠️ **警告**：
- 清除缓存后离线功能将不可用，直到重新访问行程
- 未同步的离线编辑会丢失
- 建议清除前确保已同步所有更改

### 刷新缓存数据

获取最新数据：

1. 确保有网络连接
2. 在 Dashboard 下拉刷新
3. 或点击缓存管理器中的"刷新统计"
4. 系统会从服务器拉取最新数据并更新缓存

## 使用技巧

### 最大化离线体验

**出行前准备**：
1. 连接 WiFi
2. 登录应用
3. 逐个打开所有行程（包括费用和地图）
4. 等待右下角显示"已同步"
5. 现在所有数据已缓存，可以离线使用

**旅行中**：
- 在酒店/机场有 WiFi 时打开应用同步
- 离线时可以随时查看和编辑
- 记录旅行感受（离线编辑行程备注）

**回国后**：
- 连接网络
- 打开应用自动同步所有离线记录
- 数据永久保存到云端

### 节省流量

PWA 应用在首次加载后：
- 静态资源（图片、CSS、JS）从缓存加载
- 仅同步必要的数据变更
- 比普通网页节省 70-90% 流量

### 提升性能

- **首次加载**：从服务器获取，较慢
- **后续访问**：从缓存加载，秒开
- **离线访问**：完全本地，最快

### 多设备同步

1. 在所有设备上安装 PWA
2. 使用同一账号登录
3. 数据自动在所有设备间同步
4. 离线编辑会在下次联网时同步

## 常见问题

### Q: 为什么我的编辑没有同步？

**A**: 检查以下几点：
1. 确保已恢复网络连接
2. 查看右下角同步状态
3. 点击刷新按钮手动同步
4. 如果显示"同步失败"，请重试
5. 检查是否有网络问题（防火墙、代理等）

### Q: 离线时能创建新行程吗？

**A**: 暂不支持。创建新行程需要：
- AI 生成行程规划（需要网络）
- 与服务器通信创建数据库记录

建议在有网络时创建，离线时编辑。

### Q: 应用占用多少存储空间？

**A**: 取决于缓存的数据量：
- 平均每个行程：~50KB
- 10个行程 + 费用：~500KB - 1MB
- 静态资源（应用本身）：~2-3MB

总计通常不超过 5MB，对手机存储影响很小。

### Q: 如何知道数据是否已缓存？

**A**: 有几种方式：
1. 查看 Dashboard 顶部的状态徽章
2. 行程详情页顶部的"离线数据"标识
3. 打开缓存管理器查看统计

### Q: 离线编辑会覆盖服务器数据吗？

**A**: 使用智能冲突处理：
- 如果只有一端修改：使用该修改
- 如果两端都修改：使用最新的修改
- 不会丢失任何数据（除非清除缓存）

### Q: PWA 和原生应用有什么区别？

**A**:
- PWA 优势：无需下载安装、自动更新、跨平台
- 原生应用优势：更深度的系统集成
- 功能上：PWA 可以实现绝大多数功能

对于旅行规划应用，PWA 已经足够强大。

### Q: 如何卸载 PWA？

**Android/Chrome**:
1. 长按应用图标
2. 选择"卸载"或"应用信息" > "卸载"

**iOS/Safari**:
1. 长按应用图标
2. 选择"删除App"

**桌面**:
1. 打开应用
2. 菜单 (⋮) > "卸载"
3. 或从系统应用列表卸载

### Q: 能在飞行模式下使用吗？

**A**: 可以！前提是：
- 之前已经访问并缓存了行程
- 离线功能已准备好

飞行模式下可以：
- 查看所有已缓存的行程
- 编辑行程信息
- 查看费用记录
- 查看地图（已缓存的）

落地后关闭飞行模式，数据自动同步。

## 技术限制

### 浏览器要求

✅ **支持的浏览器**：
- Chrome/Edge (推荐)
- Safari
- Firefox
- Samsung Internet

❌ **不支持**：
- IE11 及以下
- 某些旧版浏览器

### 存储限制

不同浏览器的存储限制：
- Chrome: ~60% 可用磁盘空间
- Safari: ~1GB
- Firefox: ~2GB

超出限制时，旧数据会被自动清理。

### HTTPS 要求

PWA 只能在 HTTPS 网站上工作（本地 localhost 除外）。
确保访问 `https://` 开头的地址。

## 隐私和安全

### 数据存储

- 离线数据存储在浏览器的 IndexedDB 中
- 数据仅存储在您的设备上
- 不会与其他用户或应用共享

### 数据安全

- IndexedDB 受浏览器沙盒保护
- 清除浏览器数据会删除所有离线缓存
- 建议不要在公共设备上保存数据

### 注销时

- 注销不会自动清除离线数据
- 如需清除，请使用缓存管理器
- 或清除浏览器数据

## 获取帮助

遇到问题？

1. **查看文档**：docs/PWA_IMPLEMENTATION.md（技术文档）
2. **检查状态**：右下角同步状态卡片
3. **清除缓存重试**：缓存管理器 > 清除所有缓存
4. **联系支持**：提交 GitHub Issue

## 更新日志

### v1.0.0 (当前版本)

✨ 新增功能：
- PWA 支持
- 离线查看行程
- 离线编辑行程
- 自动同步
- 冲突解决
- 缓存管理

🔜 计划中：
- 离线创建行程
- 离线添加费用
- 推送通知
- 后台同步

---

享受随时随地的旅行规划体验！ ✈️
