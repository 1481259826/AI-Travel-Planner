# å¯¹è¯å¼è¡Œç¨‹å†å²è®°å½•åŠŸèƒ½å®ç°è®¡åˆ’

> ç‰ˆæœ¬: v1.0
> åˆ›å»ºæ—¥æœŸ: 2025-12-08
> çŠ¶æ€: **å®æ–½ä¸­ - Phase 6 å·²å®Œæˆ**
> å‰ç½®ä¾èµ–: å¯¹è¯å¼è¡Œç¨‹ç”ŸæˆåŠŸèƒ½ (å·²å®Œæˆ)

---

## ä¸€ã€éœ€æ±‚æ¦‚è¿°

### 1.1 ç›®æ ‡

ä¸ºå¯¹è¯å¼è¡Œç¨‹ç”ŸæˆåŠŸèƒ½æ·»åŠ å†å²è®°å½•æ”¯æŒï¼Œè®©ç”¨æˆ·èƒ½å¤Ÿï¼š
1. æŸ¥çœ‹å†å²ç”Ÿæˆçš„è¡Œç¨‹è®°å½•ï¼ˆåŒ…æ‹¬è¡¨å•å‚æ•°å’Œç”Ÿæˆç»“æœï¼‰
2. å¿«é€Ÿå¤ç”¨å†å²è®°å½•åˆ›å»ºç±»ä¼¼è¡Œç¨‹
3. ç®¡ç†å†å²è®°å½•ï¼ˆåˆ é™¤ã€æœç´¢ã€ç­›é€‰ï¼‰

### 1.2 ç”¨æˆ·åœºæ™¯

| åœºæ™¯ | æè¿° |
|------|------|
| é‡å¤å‡ºè¡Œ | ç”¨æˆ·æ¯å¹´éƒ½å»åŒä¸€ç›®çš„åœ°æ—…æ¸¸ï¼Œå¸Œæœ›å¿«é€Ÿå¤ç”¨å»å¹´çš„è¡Œç¨‹å‚æ•° |
| å¯¹æ¯”è§„åˆ’ | ç”¨æˆ·æƒ³å¯¹æ¯”ä¸åŒé¢„ç®—/å¤©æ•°ä¸‹çš„è¡Œç¨‹æ–¹æ¡ˆ |
| ä¿®æ”¹é‡è¯• | ç”¨æˆ·å¯¹ä¹‹å‰ç”Ÿæˆçš„è¡Œç¨‹ä¸æ»¡æ„ï¼Œæƒ³è°ƒæ•´å‚æ•°é‡æ–°ç”Ÿæˆ |
| åˆ†äº«æ¨¡æ¿ | ç”¨æˆ·æƒ³ä¿å­˜æˆåŠŸçš„è¡Œç¨‹è§„åˆ’ä½œä¸ºæ¨¡æ¿ä¾›ä»¥åä½¿ç”¨ |

### 1.3 æ ¸å¿ƒæµç¨‹

```
æŸ¥çœ‹å†å²è®°å½• â†’ é€‰æ‹©è®°å½• â†’ [æŸ¥çœ‹è¯¦æƒ… | å¤ç”¨å‚æ•°]
                              â†“
                        é¢„å¡«è¡¨å• â†’ ä¿®æ”¹å‚æ•° â†’ é‡æ–°ç”Ÿæˆ
```

---

## äºŒã€è®¾è®¡æ–¹æ¡ˆ

### 2.1 æ•°æ®æ¨¡å‹

æ–°å¢ `trip_generation_history` è¡¨ï¼Œè®°å½•æ¯æ¬¡è¡Œç¨‹ç”Ÿæˆçš„å®Œæ•´ä¿¡æ¯ï¼š

```sql
CREATE TABLE IF NOT EXISTS public.trip_generation_history (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  user_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE NOT NULL,
  session_id UUID REFERENCES public.chat_sessions(id) ON DELETE SET NULL,
  trip_id UUID REFERENCES public.trips(id) ON DELETE SET NULL,

  -- ç”Ÿæˆå‚æ•°ï¼ˆè¡¨å•æ•°æ®å¿«ç…§ï¼‰
  form_data JSONB NOT NULL,

  -- ç”Ÿæˆç»“æœ
  status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'generating', 'completed', 'failed')),
  result_summary JSONB,  -- ç”Ÿæˆç»“æœæ‘˜è¦ï¼ˆç›®çš„åœ°ã€å¤©æ•°ã€æ€»é¢„ç®—ç­‰ï¼‰
  error_message TEXT,    -- å¤±è´¥æ—¶çš„é”™è¯¯ä¿¡æ¯

  -- æ—¶é—´ä¿¡æ¯
  started_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  completed_at TIMESTAMP WITH TIME ZONE,

  -- å…ƒæ•°æ®
  generation_duration_ms INTEGER,  -- ç”Ÿæˆè€—æ—¶ï¼ˆæ¯«ç§’ï¼‰
  workflow_version TEXT,           -- å·¥ä½œæµç‰ˆæœ¬ï¼ˆv1/v2ï¼‰

  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 2.2 form_data å­—æ®µç»“æ„

```typescript
interface TripFormDataSnapshot {
  // å¿…å¡«å­—æ®µ
  destination: string
  startDate: string         // YYYY-MM-DD
  endDate: string           // YYYY-MM-DD
  budget: number
  travelers: number

  // å¯é€‰å­—æ®µ
  origin?: string
  preferences?: string[]
  accommodation_preference?: 'budget' | 'mid' | 'luxury'
  transport_preference?: 'public' | 'driving' | 'mixed'
  special_requirements?: string
}
```

### 2.3 result_summary å­—æ®µç»“æ„

```typescript
interface TripResultSummary {
  destination: string
  totalDays: number
  totalBudget: number
  actualCost?: number
  attractionCount: number
  hotelCount: number

  // å¿«é€Ÿé¢„è§ˆæ•°æ®
  highlights: string[]      // è¡Œç¨‹äº®ç‚¹ï¼ˆæœ€å¤š3ä¸ªï¼‰
  coverImage?: string       // å°é¢å›¾ç‰‡URL
}
```

### 2.4 UI è®¾è®¡

#### 2.4.1 å†å²è®°å½•å…¥å£

åœ¨ ChatSidebar ç»„ä»¶ä¸­æ·»åŠ "å†å²è®°å½•"é€‰é¡¹å¡ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¯¹è¯åŠ©æ‰‹                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [å¯¹è¯å†å²] | [ç”Ÿæˆè®°å½•]  â† é€‰é¡¹å¡åˆ‡æ¢ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ ğŸ—“ï¸ æ­å· 3 æ—¥æ¸¸                  â”‚â”‚
â”‚  â”‚ é¢„ç®—: Â¥5000 | 2äºº              â”‚â”‚
â”‚  â”‚ 12/07 10:30  âœ… å·²å®Œæˆ          â”‚â”‚
â”‚  â”‚ [æŸ¥çœ‹] [å¤ç”¨]                   â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ ğŸ—“ï¸ ä¸Šæµ· 5 æ—¥æ¸¸                  â”‚â”‚
â”‚  â”‚ é¢„ç®—: Â¥8000 | 4äºº              â”‚â”‚
â”‚  â”‚ 12/05 14:20  âŒ ç”Ÿæˆå¤±è´¥        â”‚â”‚
â”‚  â”‚ [é‡è¯•]                          â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚  ...                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2.4.2 å†å²è®°å½•è¯¦æƒ…å¡ç‰‡

ç‚¹å‡»"æŸ¥çœ‹"å±•å¼€è¯¦æƒ…ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­å· 3 æ—¥æ¸¸                                         â”‚
â”‚  2024-12-14 ~ 2024-12-16                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“ ç›®çš„åœ°: æ­å·                                     â”‚
â”‚  ğŸ’° é¢„ç®—: Â¥5000                                      â”‚
â”‚  ğŸ‘¥ äººæ•°: 2äºº                                        â”‚
â”‚  ğŸ“… å¤©æ•°: 3å¤©                                        â”‚
â”‚  ğŸ¨ ä½å®¿: ä¸­æ¡£é…’åº—                                   â”‚
â”‚  ğŸš— äº¤é€š: å…¬å…±äº¤é€š                                   â”‚
â”‚  ğŸ¯ åå¥½: ç¾é£Ÿ, æ–‡åŒ–å¤è¿¹, è‡ªç„¶é£å…‰                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âœ… ç”ŸæˆæˆåŠŸ | è€—æ—¶ 45 ç§’                            â”‚
â”‚  ç”Ÿæˆæ—¶é—´: 2024-12-07 10:30:25                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [æŸ¥çœ‹è¡Œç¨‹] [å¤ç”¨å‚æ•°] [åˆ é™¤è®°å½•]                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2.4.3 å¤ç”¨å‚æ•°æµç¨‹

ç‚¹å‡»"å¤ç”¨å‚æ•°"åï¼š

1. å¼¹å‡º TripFormModalï¼ˆé¢„å¡«å†å²æ•°æ®ï¼‰
2. ç”¨æˆ·å¯ä¿®æ”¹ä»»æ„å­—æ®µ
3. ç¡®è®¤åè§¦å‘æ–°çš„è¡Œç¨‹ç”Ÿæˆ
4. æ–°ç”Ÿæˆè®°å½•å…³è”åˆ°å†å²è®°å½•ï¼ˆå¯é€‰ï¼‰

### 2.5 å¤ç”¨ç­–ç•¥

| ç­–ç•¥ | æè¿° | ä½¿ç”¨åœºæ™¯ |
|------|------|----------|
| å®Œå…¨å¤ç”¨ | ç›´æ¥ä½¿ç”¨å†å²å‚æ•°ç”Ÿæˆ | ç¡®å®šå‚æ•°æ— éœ€ä¿®æ”¹ |
| ä¿®æ”¹å¤ç”¨ | æ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡†ï¼Œå…è®¸ä¿®æ”¹ | å¾®è°ƒéƒ¨åˆ†å‚æ•° |
| æ—¥æœŸæ›´æ–° | è‡ªåŠ¨æ›´æ–°æ—¥æœŸä¸ºæœªæ¥æ—¥æœŸ | é‡å¤å¹´åº¦æ—…è¡Œ |

---

## ä¸‰ã€å®ç°æ¶æ„

### 3.1 æ•°æ®æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å‰ç«¯                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ChatSidebar                                                â”‚
â”‚  â”œâ”€â”€ HistoryTab (æ–°å¢)                                      â”‚
â”‚  â”‚   â”œâ”€â”€ HistoryList                                        â”‚
â”‚  â”‚   â”‚   â””â”€â”€ HistoryItem Ã— N                               â”‚
â”‚  â”‚   â”œâ”€â”€ HistoryDetailCard (å±•å¼€è¯¦æƒ…)                       â”‚
â”‚  â”‚   â””â”€â”€ HistoryFilters (ç­›é€‰æ¡ä»¶)                          â”‚
â”‚  â””â”€â”€ ConversationTab (ç°æœ‰)                                 â”‚
â”‚                                                             â”‚
â”‚  TripFormModal (ç°æœ‰ï¼Œæ”¯æŒé¢„å¡«æ•°æ®)                          â”‚
â”‚                                                             â”‚
â”‚  hooks/                                                     â”‚
â”‚  â”œâ”€â”€ useTripHistory.ts (æ–°å¢)                               â”‚
â”‚  â””â”€â”€ useChatAgent.ts (æ‰©å±•)                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        API å±‚                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  /api/trip-history/                                         â”‚
â”‚  â”œâ”€â”€ route.ts           GET åˆ—è¡¨ / POST åˆ›å»º                â”‚
â”‚  â”œâ”€â”€ [id]/route.ts      GET è¯¦æƒ… / DELETE åˆ é™¤              â”‚
â”‚  â””â”€â”€ [id]/reuse/route.ts POST å¤ç”¨ç”Ÿæˆ                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       æ•°æ®åº“å±‚                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  trip_generation_history è¡¨                                 â”‚
â”‚  â”œâ”€â”€ å…³è” profiles (ç”¨æˆ·)                                   â”‚
â”‚  â”œâ”€â”€ å…³è” chat_sessions (ä¼šè¯ï¼Œå¯é€‰)                        â”‚
â”‚  â””â”€â”€ å…³è” trips (ç”Ÿæˆçš„è¡Œç¨‹ï¼Œå¯é€‰)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 ä¸ç°æœ‰ç³»ç»Ÿé›†æˆ

#### 3.2.1 è¡Œç¨‹ç”Ÿæˆæ—¶è®°å½•å†å²

ä¿®æ”¹ `/api/chat/generate-trip/route.ts`ï¼š

```typescript
// åœ¨ç”Ÿæˆå¼€å§‹æ—¶åˆ›å»ºå†å²è®°å½•
const historyId = await createGenerationHistory({
  userId,
  sessionId,
  formData,
  status: 'generating',
})

// ç”Ÿæˆå®Œæˆåæ›´æ–°è®°å½•
await updateGenerationHistory(historyId, {
  status: 'completed',
  tripId: result.trip_id,
  resultSummary: {
    destination: formData.destination,
    totalDays: calculateDays(formData.startDate, formData.endDate),
    // ...
  },
  completedAt: new Date(),
  generationDurationMs: Date.now() - startTime,
})
```

#### 3.2.2 æ‰©å±• useChatAgent Hook

```typescript
// æ–°å¢æ–¹æ³•
interface UseChatAgentReturn {
  // ... ç°æœ‰æ–¹æ³•

  // å†å²è®°å½•ç›¸å…³
  reuseHistoryRecord: (historyId: string) => Promise<void>
}
```

### 3.3 çŠ¶æ€ç®¡ç†

```typescript
interface TripHistoryState {
  // åˆ—è¡¨çŠ¶æ€
  records: TripGenerationRecord[]
  isLoading: boolean
  error: string | null

  // åˆ†é¡µ
  total: number
  page: number
  pageSize: number

  // ç­›é€‰
  filters: {
    status?: 'completed' | 'failed' | 'all'
    dateRange?: { start: string; end: string }
    destination?: string
  }

  // è¯¦æƒ…å±•å¼€
  expandedId: string | null
}
```

---

## å››ã€æ–‡ä»¶å˜æ›´æ¸…å•

### 4.1 æ–°å¢æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | è¯´æ˜ |
|----------|------|
| `database/migrations/add_trip_generation_history.sql` | æ•°æ®åº“è¿ç§»è„šæœ¬ |
| `lib/trip-history/types.ts` | ç±»å‹å®šä¹‰ |
| `lib/trip-history/service.ts` | å†å²è®°å½•æœåŠ¡ï¼ˆCRUDï¼‰ |
| `lib/trip-history/index.ts` | ç»Ÿä¸€å¯¼å‡º |
| `hooks/useTripHistory.ts` | å†å²è®°å½• Hook |
| `components/chat/HistoryTab.tsx` | å†å²è®°å½•é€‰é¡¹å¡ |
| `components/chat/HistoryList.tsx` | å†å²è®°å½•åˆ—è¡¨ |
| `components/chat/HistoryItem.tsx` | å†å²è®°å½•é¡¹ |
| `components/chat/HistoryDetailCard.tsx` | å†å²è®°å½•è¯¦æƒ…å¡ç‰‡ |
| `components/chat/HistoryFilters.tsx` | å†å²è®°å½•ç­›é€‰å™¨ |
| `app/api/trip-history/route.ts` | åˆ—è¡¨ API |
| `app/api/trip-history/[id]/route.ts` | è¯¦æƒ…/åˆ é™¤ API |
| `app/api/trip-history/[id]/reuse/route.ts` | å¤ç”¨ API |

### 4.2 ä¿®æ”¹æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | ä¿®æ”¹å†…å®¹ |
|----------|----------|
| `database/init.sql` | æ·»åŠ  trip_generation_history è¡¨å®šä¹‰ |
| `app/api/chat/generate-trip/route.ts` | é›†æˆå†å²è®°å½•åˆ›å»ºé€»è¾‘ |
| `hooks/useChatAgent.ts` | æ·»åŠ  reuseHistoryRecord æ–¹æ³• |
| `components/chat/ChatSidebar.tsx` | æ·»åŠ é€‰é¡¹å¡åˆ‡æ¢ï¼Œé›†æˆ HistoryTab |
| `components/chat/TripFormModal.tsx` | æ”¯æŒé¢„å¡«æ•°æ®å’Œå¤ç”¨æ¨¡å¼ |
| `components/chat/index.ts` | å¯¼å‡ºæ–°ç»„ä»¶ |
| `lib/chat/types.ts` | æ·»åŠ å†å²è®°å½•ç›¸å…³ç±»å‹ |

---

## äº”ã€å®ç°æ­¥éª¤

### Phase 1: æ•°æ®åº“ä¸ç±»å‹å®šä¹‰

**ç›®æ ‡**ï¼šå»ºç«‹æ•°æ®åŸºç¡€

1. **åˆ›å»ºè¿ç§»è„šæœ¬** `database/migrations/add_trip_generation_history.sql`
   - åˆ›å»º `trip_generation_history` è¡¨
   - æ·»åŠ  RLS ç­–ç•¥
   - åˆ›å»ºç´¢å¼•
   - æ·»åŠ è§¦å‘å™¨ï¼ˆè‡ªåŠ¨æ›´æ–° updated_atï¼‰

2. **å®šä¹‰ç±»å‹** `lib/trip-history/types.ts`
   - `TripGenerationRecord` - å†å²è®°å½•å®Œæ•´ç±»å‹
   - `TripGenerationListItem` - åˆ—è¡¨é¡¹ç®€åŒ–ç±»å‹
   - `CreateHistoryParams` - åˆ›å»ºå‚æ•°
   - `UpdateHistoryParams` - æ›´æ–°å‚æ•°
   - `HistoryFilters` - ç­›é€‰å‚æ•°

### Phase 2: æœåŠ¡å±‚å®ç°

**ç›®æ ‡**ï¼šå®ç°å†å²è®°å½• CRUD

1. **åˆ›å»ºæœåŠ¡** `lib/trip-history/service.ts`
   - `createHistory()` - åˆ›å»ºå†å²è®°å½•
   - `updateHistory()` - æ›´æ–°å†å²è®°å½•
   - `getHistory()` - è·å–å•æ¡è®°å½•
   - `listHistory()` - è·å–åˆ—è¡¨ï¼ˆåˆ†é¡µã€ç­›é€‰ï¼‰
   - `deleteHistory()` - åˆ é™¤è®°å½•

2. **é›†æˆåˆ°è¡Œç¨‹ç”Ÿæˆæµç¨‹**
   - ä¿®æ”¹ `/api/chat/generate-trip/route.ts`
   - åœ¨ç”Ÿæˆå¼€å§‹æ—¶åˆ›å»ºè®°å½•
   - åœ¨ç”Ÿæˆå®Œæˆ/å¤±è´¥æ—¶æ›´æ–°è®°å½•

### Phase 3: API ç«¯ç‚¹

**ç›®æ ‡**ï¼šæä¾› RESTful API

1. **åˆ›å»º** `app/api/trip-history/route.ts`
   - GET: è·å–å†å²è®°å½•åˆ—è¡¨
   - æ”¯æŒåˆ†é¡µã€ç­›é€‰ã€æ’åº

2. **åˆ›å»º** `app/api/trip-history/[id]/route.ts`
   - GET: è·å–å•æ¡è®°å½•è¯¦æƒ…
   - DELETE: åˆ é™¤è®°å½•

3. **åˆ›å»º** `app/api/trip-history/[id]/reuse/route.ts`
   - POST: åŸºäºå†å²è®°å½•å¤ç”¨ç”Ÿæˆ

### Phase 4: å‰ç«¯ Hook

**ç›®æ ‡**ï¼šå°è£…çŠ¶æ€ç®¡ç†

1. **åˆ›å»º** `hooks/useTripHistory.ts`
   - åˆ—è¡¨è·å–å’Œåˆ†é¡µ
   - ç­›é€‰çŠ¶æ€ç®¡ç†
   - åˆ é™¤æ“ä½œ
   - å¤ç”¨æ“ä½œ

2. **æ‰©å±•** `hooks/useChatAgent.ts`
   - æ·»åŠ  `reuseHistoryRecord` æ–¹æ³•
   - å¤„ç†å¤ç”¨æ—¶çš„è¡¨å•é¢„å¡«

### Phase 5: UI ç»„ä»¶

**ç›®æ ‡**ï¼šå®ç°ç”¨æˆ·ç•Œé¢

1. **åˆ›å»º HistoryTab** `components/chat/HistoryTab.tsx`
   - é€‰é¡¹å¡å®¹å™¨
   - é›†æˆåˆ—è¡¨å’Œç­›é€‰å™¨

2. **åˆ›å»º HistoryList** `components/chat/HistoryList.tsx`
   - åˆ—è¡¨æ¸²æŸ“
   - åŠ è½½çŠ¶æ€
   - ç©ºçŠ¶æ€æç¤º

3. **åˆ›å»º HistoryItem** `components/chat/HistoryItem.tsx`
   - è®°å½•å¡ç‰‡
   - çŠ¶æ€æ ‡ç­¾ï¼ˆæˆåŠŸ/å¤±è´¥/è¿›è¡Œä¸­ï¼‰
   - æ“ä½œæŒ‰é’®

4. **åˆ›å»º HistoryDetailCard** `components/chat/HistoryDetailCard.tsx`
   - å±•å¼€åçš„è¯¦ç»†ä¿¡æ¯
   - è¡¨å•å‚æ•°å±•ç¤º
   - ç»“æœæ‘˜è¦

5. **åˆ›å»º HistoryFilters** `components/chat/HistoryFilters.tsx`
   - çŠ¶æ€ç­›é€‰
   - æ—¥æœŸèŒƒå›´é€‰æ‹©
   - ç›®çš„åœ°æœç´¢

### Phase 6: é›†æˆä¸ä¼˜åŒ–

**ç›®æ ‡**ï¼šå®Œæˆé›†æˆï¼Œä¼˜åŒ–ä½“éªŒ

1. **ä¿®æ”¹ ChatSidebar**
   - æ·»åŠ é€‰é¡¹å¡åˆ‡æ¢ UI
   - é›†æˆ HistoryTab ç»„ä»¶

2. **ä¿®æ”¹ TripFormModal**
   - æ”¯æŒ `prefillData` å±æ€§
   - æ·»åŠ "å¤ç”¨æ¨¡å¼"æç¤º
   - æ—¥æœŸè‡ªåŠ¨æ›´æ–°é€»è¾‘

3. **UI ä¼˜åŒ–**
   - æ·»åŠ åŠ è½½åŠ¨ç”»
   - æ·»åŠ æ“ä½œæˆåŠŸ/å¤±è´¥æç¤º
   - å“åº”å¼é€‚é…

### Phase 7: æµ‹è¯•ä¸æ–‡æ¡£

**ç›®æ ‡**ï¼šç¡®ä¿è´¨é‡

1. **åŠŸèƒ½æµ‹è¯•**
   - å†å²è®°å½•åˆ›å»ºï¼ˆæˆåŠŸ/å¤±è´¥ï¼‰
   - åˆ—è¡¨å±•ç¤ºå’Œåˆ†é¡µ
   - ç­›é€‰åŠŸèƒ½
   - å¤ç”¨åŠŸèƒ½
   - åˆ é™¤åŠŸèƒ½

2. **è¾¹ç•Œæƒ…å†µ**
   - æ— å†å²è®°å½•æ—¶çš„ç©ºçŠ¶æ€
   - å¤§é‡è®°å½•æ—¶çš„æ€§èƒ½
   - å¹¶å‘æ“ä½œ
   - ç½‘ç»œé”™è¯¯å¤„ç†

3. **æ–‡æ¡£æ›´æ–°**
   - æ›´æ–° CLAUDE.md
   - æ·»åŠ åŠŸèƒ½è¯´æ˜åˆ°ç”¨æˆ·æ–‡æ¡£

---

## å…­ã€å…³é”®ä»£ç è®¾è®¡

### 6.1 æ•°æ®åº“è¿ç§»è„šæœ¬

```sql
-- database/migrations/add_trip_generation_history.sql

-- åˆ›å»ºå†å²è®°å½•è¡¨
CREATE TABLE IF NOT EXISTS public.trip_generation_history (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  user_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE NOT NULL,
  session_id UUID REFERENCES public.chat_sessions(id) ON DELETE SET NULL,
  trip_id UUID REFERENCES public.trips(id) ON DELETE SET NULL,

  form_data JSONB NOT NULL,
  status TEXT NOT NULL DEFAULT 'pending'
    CHECK (status IN ('pending', 'generating', 'completed', 'failed')),
  result_summary JSONB,
  error_message TEXT,

  started_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  completed_at TIMESTAMP WITH TIME ZONE,
  generation_duration_ms INTEGER,
  workflow_version TEXT DEFAULT 'v2',

  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- å¯ç”¨ RLS
ALTER TABLE public.trip_generation_history ENABLE ROW LEVEL SECURITY;

-- RLS ç­–ç•¥
CREATE POLICY "Users can view their own history"
  ON public.trip_generation_history FOR SELECT
  USING (auth.uid() = user_id);

CREATE POLICY "Users can create their own history"
  ON public.trip_generation_history FOR INSERT
  WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update their own history"
  ON public.trip_generation_history FOR UPDATE
  USING (auth.uid() = user_id);

CREATE POLICY "Users can delete their own history"
  ON public.trip_generation_history FOR DELETE
  USING (auth.uid() = user_id);

-- ç´¢å¼•
CREATE INDEX idx_trip_history_user_id ON public.trip_generation_history(user_id);
CREATE INDEX idx_trip_history_status ON public.trip_generation_history(status);
CREATE INDEX idx_trip_history_created_at ON public.trip_generation_history(created_at DESC);
CREATE INDEX idx_trip_history_destination ON public.trip_generation_history((form_data->>'destination'));

-- æ›´æ–°æ—¶é—´è§¦å‘å™¨
CREATE TRIGGER update_trip_history_updated_at
  BEFORE UPDATE ON public.trip_generation_history
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();
```

### 6.2 ç±»å‹å®šä¹‰

```typescript
// lib/trip-history/types.ts

import type { TripFormData } from '@/lib/chat'

/**
 * å†å²è®°å½•çŠ¶æ€
 */
export type HistoryStatus = 'pending' | 'generating' | 'completed' | 'failed'

/**
 * ç”Ÿæˆç»“æœæ‘˜è¦
 */
export interface TripResultSummary {
  destination: string
  totalDays: number
  totalBudget: number
  actualCost?: number
  attractionCount: number
  hotelCount: number
  highlights: string[]
  coverImage?: string
}

/**
 * å®Œæ•´å†å²è®°å½•
 */
export interface TripGenerationRecord {
  id: string
  userId: string
  sessionId?: string
  tripId?: string

  formData: TripFormData
  status: HistoryStatus
  resultSummary?: TripResultSummary
  errorMessage?: string

  startedAt: string
  completedAt?: string
  generationDurationMs?: number
  workflowVersion: string

  createdAt: string
  updatedAt: string
}

/**
 * åˆ—è¡¨é¡¹ï¼ˆç®€åŒ–ç‰ˆï¼‰
 */
export interface TripHistoryListItem {
  id: string
  destination: string
  startDate: string
  endDate: string
  budget: number
  travelers: number
  status: HistoryStatus
  generationDurationMs?: number
  tripId?: string
  createdAt: string
}

/**
 * ç­›é€‰å‚æ•°
 */
export interface HistoryFilters {
  status?: HistoryStatus | 'all'
  destination?: string
  dateFrom?: string
  dateTo?: string
}

/**
 * åˆ—è¡¨è¯·æ±‚å‚æ•°
 */
export interface ListHistoryParams {
  page?: number
  pageSize?: number
  filters?: HistoryFilters
  sortBy?: 'createdAt' | 'destination' | 'status'
  sortOrder?: 'asc' | 'desc'
}

/**
 * åˆ—è¡¨å“åº”
 */
export interface ListHistoryResponse {
  records: TripHistoryListItem[]
  total: number
  page: number
  pageSize: number
}
```

### 6.3 æœåŠ¡å±‚

```typescript
// lib/trip-history/service.ts

import { createClient } from '@/lib/database'
import type {
  TripGenerationRecord,
  TripHistoryListItem,
  ListHistoryParams,
  ListHistoryResponse,
  TripResultSummary,
  HistoryStatus,
} from './types'
import type { TripFormData } from '@/lib/chat'

export class TripHistoryService {
  /**
   * åˆ›å»ºå†å²è®°å½•
   */
  static async create(
    supabase: ReturnType<typeof createClient>,
    params: {
      userId: string
      sessionId?: string
      formData: TripFormData
      workflowVersion?: string
    }
  ): Promise<string> {
    const { data, error } = await supabase
      .from('trip_generation_history')
      .insert({
        user_id: params.userId,
        session_id: params.sessionId || null,
        form_data: params.formData,
        status: 'generating',
        workflow_version: params.workflowVersion || 'v2',
        started_at: new Date().toISOString(),
      })
      .select('id')
      .single()

    if (error) throw error
    return data.id
  }

  /**
   * æ›´æ–°å†å²è®°å½•ï¼ˆå®Œæˆ/å¤±è´¥ï¼‰
   */
  static async update(
    supabase: ReturnType<typeof createClient>,
    id: string,
    params: {
      status: HistoryStatus
      tripId?: string
      resultSummary?: TripResultSummary
      errorMessage?: string
      generationDurationMs?: number
    }
  ): Promise<void> {
    const { error } = await supabase
      .from('trip_generation_history')
      .update({
        status: params.status,
        trip_id: params.tripId || null,
        result_summary: params.resultSummary || null,
        error_message: params.errorMessage || null,
        generation_duration_ms: params.generationDurationMs || null,
        completed_at: params.status === 'completed' || params.status === 'failed'
          ? new Date().toISOString()
          : null,
      })
      .eq('id', id)

    if (error) throw error
  }

  /**
   * è·å–å†å²è®°å½•è¯¦æƒ…
   */
  static async getById(
    supabase: ReturnType<typeof createClient>,
    id: string,
    userId: string
  ): Promise<TripGenerationRecord | null> {
    const { data, error } = await supabase
      .from('trip_generation_history')
      .select('*')
      .eq('id', id)
      .eq('user_id', userId)
      .single()

    if (error) {
      if (error.code === 'PGRST116') return null
      throw error
    }

    return mapToRecord(data)
  }

  /**
   * è·å–å†å²è®°å½•åˆ—è¡¨
   */
  static async list(
    supabase: ReturnType<typeof createClient>,
    userId: string,
    params: ListHistoryParams = {}
  ): Promise<ListHistoryResponse> {
    const {
      page = 1,
      pageSize = 20,
      filters = {},
      sortBy = 'createdAt',
      sortOrder = 'desc',
    } = params

    let query = supabase
      .from('trip_generation_history')
      .select('*', { count: 'exact' })
      .eq('user_id', userId)

    // åº”ç”¨ç­›é€‰
    if (filters.status && filters.status !== 'all') {
      query = query.eq('status', filters.status)
    }
    if (filters.destination) {
      query = query.ilike('form_data->>destination', `%${filters.destination}%`)
    }
    if (filters.dateFrom) {
      query = query.gte('created_at', filters.dateFrom)
    }
    if (filters.dateTo) {
      query = query.lte('created_at', filters.dateTo)
    }

    // æ’åº
    const sortColumn = sortBy === 'createdAt' ? 'created_at' : sortBy
    query = query.order(sortColumn, { ascending: sortOrder === 'asc' })

    // åˆ†é¡µ
    const from = (page - 1) * pageSize
    query = query.range(from, from + pageSize - 1)

    const { data, error, count } = await query

    if (error) throw error

    return {
      records: (data || []).map(mapToListItem),
      total: count || 0,
      page,
      pageSize,
    }
  }

  /**
   * åˆ é™¤å†å²è®°å½•
   */
  static async delete(
    supabase: ReturnType<typeof createClient>,
    id: string,
    userId: string
  ): Promise<void> {
    const { error } = await supabase
      .from('trip_generation_history')
      .delete()
      .eq('id', id)
      .eq('user_id', userId)

    if (error) throw error
  }
}

// è¾…åŠ©å‡½æ•°ï¼šæ˜ å°„æ•°æ®åº“è®°å½•åˆ°ç±»å‹
function mapToRecord(data: any): TripGenerationRecord {
  return {
    id: data.id,
    userId: data.user_id,
    sessionId: data.session_id,
    tripId: data.trip_id,
    formData: data.form_data,
    status: data.status,
    resultSummary: data.result_summary,
    errorMessage: data.error_message,
    startedAt: data.started_at,
    completedAt: data.completed_at,
    generationDurationMs: data.generation_duration_ms,
    workflowVersion: data.workflow_version,
    createdAt: data.created_at,
    updatedAt: data.updated_at,
  }
}

function mapToListItem(data: any): TripHistoryListItem {
  return {
    id: data.id,
    destination: data.form_data?.destination || '',
    startDate: data.form_data?.startDate || '',
    endDate: data.form_data?.endDate || '',
    budget: data.form_data?.budget || 0,
    travelers: data.form_data?.travelers || 1,
    status: data.status,
    generationDurationMs: data.generation_duration_ms,
    tripId: data.trip_id,
    createdAt: data.created_at,
  }
}
```

### 6.4 useTripHistory Hook

```typescript
// hooks/useTripHistory.ts

import { useState, useCallback, useEffect } from 'react'
import { auth } from '@/lib/supabase'
import type {
  TripHistoryListItem,
  TripGenerationRecord,
  HistoryFilters,
  ListHistoryResponse,
} from '@/lib/trip-history'

export interface UseTripHistoryReturn {
  // åˆ—è¡¨
  records: TripHistoryListItem[]
  total: number
  page: number
  pageSize: number
  isLoading: boolean
  error: string | null

  // æ“ä½œ
  refresh: () => Promise<void>
  loadMore: () => Promise<void>
  setFilters: (filters: HistoryFilters) => void
  deleteRecord: (id: string) => Promise<void>
  getRecordDetail: (id: string) => Promise<TripGenerationRecord | null>

  // ç­›é€‰çŠ¶æ€
  filters: HistoryFilters
}

export function useTripHistory(): UseTripHistoryReturn {
  const [records, setRecords] = useState<TripHistoryListItem[]>([])
  const [total, setTotal] = useState(0)
  const [page, setPage] = useState(1)
  const [pageSize] = useState(20)
  const [isLoading, setIsLoading] = useState(false)
  const [error, setError] = useState<string | null>(null)
  const [filters, setFilters] = useState<HistoryFilters>({})

  const fetchRecords = useCallback(async (pageNum: number, append: boolean = false) => {
    setIsLoading(true)
    setError(null)

    try {
      const { data: { session } } = await auth.getSession()
      if (!session?.access_token) {
        throw new Error('è¯·å…ˆç™»å½•')
      }

      const params = new URLSearchParams({
        page: pageNum.toString(),
        page_size: pageSize.toString(),
      })

      if (filters.status && filters.status !== 'all') {
        params.set('status', filters.status)
      }
      if (filters.destination) {
        params.set('destination', filters.destination)
      }

      const response = await fetch(`/api/trip-history?${params}`, {
        headers: {
          Authorization: `Bearer ${session.access_token}`,
        },
      })

      if (!response.ok) {
        const data = await response.json()
        throw new Error(data.error || 'è·å–å†å²è®°å½•å¤±è´¥')
      }

      const data: ListHistoryResponse = await response.json()

      if (append) {
        setRecords(prev => [...prev, ...data.records])
      } else {
        setRecords(data.records)
      }
      setTotal(data.total)
      setPage(pageNum)
    } catch (err) {
      setError(err instanceof Error ? err.message : 'è·å–å†å²è®°å½•å¤±è´¥')
    } finally {
      setIsLoading(false)
    }
  }, [pageSize, filters])

  const refresh = useCallback(async () => {
    await fetchRecords(1, false)
  }, [fetchRecords])

  const loadMore = useCallback(async () => {
    if (records.length >= total) return
    await fetchRecords(page + 1, true)
  }, [fetchRecords, page, records.length, total])

  const deleteRecord = useCallback(async (id: string) => {
    try {
      const { data: { session } } = await auth.getSession()
      if (!session?.access_token) {
        throw new Error('è¯·å…ˆç™»å½•')
      }

      const response = await fetch(`/api/trip-history/${id}`, {
        method: 'DELETE',
        headers: {
          Authorization: `Bearer ${session.access_token}`,
        },
      })

      if (!response.ok) {
        const data = await response.json()
        throw new Error(data.error || 'åˆ é™¤å¤±è´¥')
      }

      setRecords(prev => prev.filter(r => r.id !== id))
      setTotal(prev => prev - 1)
    } catch (err) {
      setError(err instanceof Error ? err.message : 'åˆ é™¤å¤±è´¥')
      throw err
    }
  }, [])

  const getRecordDetail = useCallback(async (id: string): Promise<TripGenerationRecord | null> => {
    try {
      const { data: { session } } = await auth.getSession()
      if (!session?.access_token) {
        throw new Error('è¯·å…ˆç™»å½•')
      }

      const response = await fetch(`/api/trip-history/${id}`, {
        headers: {
          Authorization: `Bearer ${session.access_token}`,
        },
      })

      if (!response.ok) {
        const data = await response.json()
        throw new Error(data.error || 'è·å–è¯¦æƒ…å¤±è´¥')
      }

      return await response.json()
    } catch (err) {
      setError(err instanceof Error ? err.message : 'è·å–è¯¦æƒ…å¤±è´¥')
      return null
    }
  }, [])

  // åˆå§‹åŠ è½½
  useEffect(() => {
    refresh()
  }, [refresh])

  // ç­›é€‰å˜åŒ–æ—¶é‡æ–°åŠ è½½
  useEffect(() => {
    refresh()
  }, [filters, refresh])

  return {
    records,
    total,
    page,
    pageSize,
    isLoading,
    error,
    refresh,
    loadMore,
    setFilters,
    deleteRecord,
    getRecordDetail,
    filters,
  }
}
```

### 6.5 HistoryItem ç»„ä»¶

```typescript
// components/chat/HistoryItem.tsx

'use client'

import { useState } from 'react'
import { format } from 'date-fns'
import { zhCN } from 'date-fns/locale'
import {
  MapPin,
  Calendar,
  Users,
  DollarSign,
  Clock,
  CheckCircle,
  XCircle,
  Loader2,
  MoreVertical,
  Trash2,
  Copy,
  ExternalLink,
} from 'lucide-react'
import { Button } from '@/components/ui/button'
import type { TripHistoryListItem } from '@/lib/trip-history'

interface HistoryItemProps {
  record: TripHistoryListItem
  onReuse: () => void
  onDelete: () => void
  onViewTrip?: () => void
}

export function HistoryItem({
  record,
  onReuse,
  onDelete,
  onViewTrip,
}: HistoryItemProps) {
  const [showMenu, setShowMenu] = useState(false)
  const [isDeleting, setIsDeleting] = useState(false)

  const statusConfig = {
    pending: { icon: Loader2, color: 'text-gray-500', label: 'å‡†å¤‡ä¸­', spin: true },
    generating: { icon: Loader2, color: 'text-blue-500', label: 'ç”Ÿæˆä¸­', spin: true },
    completed: { icon: CheckCircle, color: 'text-green-500', label: 'å·²å®Œæˆ', spin: false },
    failed: { icon: XCircle, color: 'text-red-500', label: 'å¤±è´¥', spin: false },
  }

  const status = statusConfig[record.status]
  const StatusIcon = status.icon

  const handleDelete = async (e: React.MouseEvent) => {
    e.stopPropagation()
    setIsDeleting(true)
    try {
      await onDelete()
    } finally {
      setIsDeleting(false)
      setShowMenu(false)
    }
  }

  const totalDays = Math.ceil(
    (new Date(record.endDate).getTime() - new Date(record.startDate).getTime()) / (1000 * 60 * 60 * 24)
  ) + 1

  return (
    <div className="group bg-white dark:bg-gray-800 border dark:border-gray-700 rounded-lg p-3 hover:shadow-md transition-shadow">
      {/* å¤´éƒ¨ */}
      <div className="flex items-start justify-between mb-2">
        <div className="flex items-center gap-2">
          <MapPin className="w-4 h-4 text-blue-500" />
          <span className="font-medium text-gray-900 dark:text-white">
            {record.destination}
          </span>
          <span className="text-sm text-gray-500">
            {totalDays}æ—¥æ¸¸
          </span>
        </div>

        {/* çŠ¶æ€æ ‡ç­¾ */}
        <div className={`flex items-center gap-1 text-sm ${status.color}`}>
          <StatusIcon className={`w-4 h-4 ${status.spin ? 'animate-spin' : ''}`} />
          <span>{status.label}</span>
        </div>
      </div>

      {/* ä¿¡æ¯è¡Œ */}
      <div className="flex flex-wrap gap-3 text-sm text-gray-600 dark:text-gray-400 mb-3">
        <div className="flex items-center gap-1">
          <Calendar className="w-3.5 h-3.5" />
          <span>
            {format(new Date(record.startDate), 'MM/dd', { locale: zhCN })} -
            {format(new Date(record.endDate), 'MM/dd', { locale: zhCN })}
          </span>
        </div>
        <div className="flex items-center gap-1">
          <DollarSign className="w-3.5 h-3.5" />
          <span>Â¥{record.budget.toLocaleString()}</span>
        </div>
        <div className="flex items-center gap-1">
          <Users className="w-3.5 h-3.5" />
          <span>{record.travelers}äºº</span>
        </div>
        {record.generationDurationMs && (
          <div className="flex items-center gap-1">
            <Clock className="w-3.5 h-3.5" />
            <span>{Math.round(record.generationDurationMs / 1000)}ç§’</span>
          </div>
        )}
      </div>

      {/* æ“ä½œæŒ‰é’® */}
      <div className="flex items-center justify-between">
        <span className="text-xs text-gray-400">
          {format(new Date(record.createdAt), 'yyyy/MM/dd HH:mm', { locale: zhCN })}
        </span>

        <div className="flex items-center gap-2">
          {record.status === 'completed' && record.tripId && (
            <Button
              size="sm"
              variant="ghost"
              onClick={onViewTrip}
              className="h-7 text-xs"
            >
              <ExternalLink className="w-3.5 h-3.5 mr-1" />
              æŸ¥çœ‹è¡Œç¨‹
            </Button>
          )}

          <Button
            size="sm"
            variant="outline"
            onClick={onReuse}
            className="h-7 text-xs"
          >
            <Copy className="w-3.5 h-3.5 mr-1" />
            å¤ç”¨
          </Button>

          {/* æ›´å¤šèœå• */}
          <div className="relative">
            <button
              type="button"
              onClick={(e) => {
                e.stopPropagation()
                setShowMenu(!showMenu)
              }}
              className="p-1 rounded hover:bg-gray-100 dark:hover:bg-gray-700"
            >
              <MoreVertical className="w-4 h-4 text-gray-500" />
            </button>

            {showMenu && (
              <>
                <div
                  className="fixed inset-0 z-10"
                  onClick={() => setShowMenu(false)}
                />
                <div className="absolute right-0 top-full mt-1 z-20 bg-white dark:bg-gray-800 border dark:border-gray-700 rounded-lg shadow-lg py-1 min-w-[100px]">
                  <button
                    type="button"
                    onClick={handleDelete}
                    disabled={isDeleting}
                    className="w-full flex items-center gap-2 px-3 py-1.5 text-sm text-red-600 hover:bg-red-50 dark:hover:bg-red-900/30"
                  >
                    {isDeleting ? (
                      <Loader2 className="w-4 h-4 animate-spin" />
                    ) : (
                      <Trash2 className="w-4 h-4" />
                    )}
                    åˆ é™¤
                  </button>
                </div>
              </>
            )}
          </div>
        </div>
      </div>
    </div>
  )
}
```

---

## ä¸ƒã€éªŒæ”¶æ ‡å‡†

### 7.1 åŠŸèƒ½éªŒæ”¶

- [x] è¡Œç¨‹ç”Ÿæˆæ—¶è‡ªåŠ¨åˆ›å»ºå†å²è®°å½•
- [x] ç”ŸæˆæˆåŠŸ/å¤±è´¥æ—¶æ­£ç¡®æ›´æ–°è®°å½•çŠ¶æ€
- [ ] å†å²è®°å½•åˆ—è¡¨æ­£ç¡®å±•ç¤º
- [ ] åˆ†é¡µåŠŸèƒ½æ­£å¸¸å·¥ä½œ
- [ ] çŠ¶æ€ç­›é€‰åŠŸèƒ½æ­£å¸¸
- [ ] ç›®çš„åœ°æœç´¢åŠŸèƒ½æ­£å¸¸
- [ ] ç‚¹å‡»"å¤ç”¨"èƒ½æ­£ç¡®é¢„å¡«è¡¨å•
- [ ] ä¿®æ”¹é¢„å¡«æ•°æ®åèƒ½æ­£å¸¸ç”Ÿæˆæ–°è¡Œç¨‹
- [ ] ç‚¹å‡»"æŸ¥çœ‹è¡Œç¨‹"èƒ½è·³è½¬åˆ°å¯¹åº”è¡Œç¨‹é¡µé¢
- [ ] åˆ é™¤åŠŸèƒ½æ­£å¸¸å·¥ä½œ

### 7.2 è¾¹ç•Œæƒ…å†µ

- [ ] æ— å†å²è®°å½•æ—¶æ˜¾ç¤ºç©ºçŠ¶æ€æç¤º
- [ ] å†å²è®°å½•è¿‡å¤šæ—¶åˆ†é¡µåŠ è½½æ­£å¸¸
- [ ] ç½‘ç»œé”™è¯¯æ—¶æ˜¾ç¤ºå‹å¥½æç¤º
- [ ] åˆ é™¤ç¡®è®¤é˜²æ­¢è¯¯æ“ä½œ
- [ ] å¹¶å‘æ“ä½œä¸ä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´

### 7.3 æ€§èƒ½è¦æ±‚

- [ ] åˆ—è¡¨é¦–æ¬¡åŠ è½½ < 1ç§’
- [ ] åˆ†é¡µåŠ è½½ < 500ms
- [ ] åˆ é™¤æ“ä½œ < 500ms

---

## å…«ã€é£é™©ä¸ç¼“è§£

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|----------|
| å†å²æ•°æ®è¿‡å¤šå¯¼è‡´å­˜å‚¨å¢é•¿ | ä¸­ | æ·»åŠ è‡ªåŠ¨æ¸…ç†ç­–ç•¥ï¼ˆå¦‚ä¿ç•™æœ€è¿‘100æ¡ï¼‰ |
| è¡¨å•æ•°æ®ç»“æ„å˜æ›´ | ä¸­ | formData ä½¿ç”¨ JSONBï¼Œå…¼å®¹æ–°æ—§æ ¼å¼ |
| å¤ç”¨æ—¶æ—¥æœŸè¿‡æœŸ | ä½ | è‡ªåŠ¨æ£€æµ‹å¹¶æç¤ºç”¨æˆ·æ›´æ–°æ—¥æœŸ |

---

## ä¹ã€åç»­ä¼˜åŒ–æ–¹å‘

1. **æ”¶è—åŠŸèƒ½**ï¼šå…è®¸ç”¨æˆ·æ”¶è—å¸¸ç”¨çš„è¡Œç¨‹æ¨¡æ¿
2. **åˆ†äº«æ¨¡æ¿**ï¼šæ”¯æŒåˆ†äº«å†å²è®°å½•ç»™å…¶ä»–ç”¨æˆ·
3. **è‡ªåŠ¨æ¸…ç†**ï¼šå®šæœŸæ¸…ç†è¿‡æœŸçš„å†å²è®°å½•
4. **ç»Ÿè®¡åˆ†æ**ï¼šå±•ç¤ºç”¨æˆ·çš„æ—…è¡Œåå¥½ç»Ÿè®¡

---

## æ›´æ–°æ—¥å¿—

| æ—¥æœŸ | ç‰ˆæœ¬ | æ›´æ–°å†…å®¹ |
|------|------|----------|
| 2025-12-08 | v1.0 | åˆå§‹è®¡åˆ’æ–‡æ¡£ |
| 2025-12-08 | v1.1 | Phase 1-6 å®æ–½å®Œæˆï¼Œæ„å»ºé€šè¿‡ |

---

## å®æ–½è¿›åº¦

### å·²å®Œæˆçš„ Phase

| Phase | çŠ¶æ€ | å®Œæˆå†…å®¹ |
|-------|------|----------|
| Phase 1 | âœ… å®Œæˆ | æ•°æ®åº“è¿ç§»è„šæœ¬ `database/migrations/add_trip_generation_history.sql`ã€ç±»å‹å®šä¹‰ `lib/trip-history/types.ts` |
| Phase 2 | âœ… å®Œæˆ | æœåŠ¡å±‚ `lib/trip-history/service.ts`ï¼Œå®ç° CRUD æ“ä½œå’Œæ•°æ®æ˜ å°„ |
| Phase 3 | âœ… å®Œæˆ | API ç«¯ç‚¹ `app/api/trip-history/route.ts` å’Œ `app/api/trip-history/[id]/route.ts` |
| Phase 4 | âœ… å®Œæˆ | Hook `hooks/useTripHistory.ts`ï¼Œå°è£…çŠ¶æ€ç®¡ç†å’Œ API è°ƒç”¨ |
| Phase 5 | âœ… å®Œæˆ | UI ç»„ä»¶ `HistoryItem.tsx`ã€`HistoryList.tsx`ã€`HistoryTab.tsx` |
| Phase 6 | âœ… å®Œæˆ | é›†æˆåˆ° `ChatSidebar.tsx`ã€`generate-trip/route.ts`ï¼›æ„å»ºéªŒè¯é€šè¿‡ |
| Phase 7 | â³ å¾…å®Œæˆ | ç«¯åˆ°ç«¯æµ‹è¯•éªŒè¯ |

### å¾…å®Œæˆäº‹é¡¹

1. **æ•°æ®åº“è¿ç§»**ï¼šéœ€è¦åœ¨ Supabase ä¸­æ‰§è¡Œ `database/migrations/add_trip_generation_history.sql`
2. **ç«¯åˆ°ç«¯æµ‹è¯•**ï¼š
   - å¯åŠ¨åº”ç”¨ï¼Œè¿›å…¥å¯¹è¯åŠ©æ‰‹é¡µé¢
   - ç”Ÿæˆè¡Œç¨‹ï¼ŒéªŒè¯å†å²è®°å½•è‡ªåŠ¨åˆ›å»º
   - åˆ‡æ¢åˆ°"è®°å½•"é€‰é¡¹å¡ï¼ŒæŸ¥çœ‹å†å²åˆ—è¡¨
   - æµ‹è¯•ç­›é€‰ã€åˆ é™¤ã€å¤ç”¨åŠŸèƒ½
