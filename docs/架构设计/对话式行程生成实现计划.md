# å¯¹è¯å¼è¡Œç¨‹ç”ŸæˆåŠŸèƒ½å®ç°è®¡åˆ’

> ç‰ˆæœ¬: v1.0
> åˆ›å»ºæ—¥æœŸ: 2025-12-07
> çŠ¶æ€: âœ… å·²å®Œæˆ

---

## ä¸€ã€éœ€æ±‚æ¦‚è¿°

### 1.1 ç›®æ ‡

åœ¨ç°æœ‰å¯¹è¯åŠ©æ‰‹ä¸­é›†æˆè¡Œç¨‹ç”ŸæˆåŠŸèƒ½ï¼Œè®©ç”¨æˆ·é€šè¿‡è‡ªç„¶å¯¹è¯æ¥åˆ›å»ºè¡Œç¨‹ï¼Œè€Œä¸éœ€è¦è·³è½¬åˆ°è¡¨å•é¡µé¢ã€‚

### 1.2 æ ¸å¿ƒæµç¨‹

```
ç”¨æˆ·å¯¹è¯æè¿°éœ€æ±‚ â†’ AI è‡ªåŠ¨æå–ä¿¡æ¯ â†’ æ£€æŸ¥å¿…å¡«é¡¹ â†’ è¯¢é—®ç¼ºå¤±ä¿¡æ¯
    â†’ è¡¨å•ç¡®è®¤ï¼ˆå¡ç‰‡é¢„è§ˆ+æ¨¡æ€æ¡†ç¼–è¾‘ï¼‰ â†’ ç”¨æˆ·ç¡®è®¤ â†’ è¡Œç¨‹ç”Ÿæˆ â†’ æ˜¾ç¤ºè¯¦ç»†è¿›åº¦ â†’ å®Œæˆ
```

### 1.3 ç”¨æˆ·é€‰æ‹©

| å†³ç­–é¡¹ | é€‰æ‹© |
|--------|------|
| ä¿¡æ¯æ”¶é›†æ–¹å¼ | æ··åˆæ–¹å¼ï¼šAI è‡ªåŠ¨æå– + ä¸»åŠ¨è¯¢é—®ç¼ºå¤±é¡¹ |
| ç¡®è®¤ç•Œé¢å½¢å¼ | å¡ç‰‡é¢„è§ˆ + æ¨¡æ€æ¡†ç¼–è¾‘ï¼ˆæ¨èæ–¹æ¡ˆï¼‰ |
| ç”Ÿæˆè¿›åº¦å±•ç¤º | æ˜¾ç¤ºè¯¦ç»†è¿›åº¦ï¼ˆå„èŠ‚ç‚¹æ‰§è¡ŒçŠ¶æ€ï¼‰ |

---

## äºŒã€è®¾è®¡æ–¹æ¡ˆ

### 2.1 å·¥å…·è®¾è®¡ï¼šä¸¤å·¥å…·åˆ†ç¦»

**åŸå› **ï¼šå°†ä¿¡æ¯æ”¶é›†ä¸è¡Œç¨‹ç”Ÿæˆåˆ†ç¦»ï¼Œæä¾›æ˜ç¡®çš„ç¡®è®¤æ­¥éª¤

#### å·¥å…· 1: `prepare_trip_form`
- **èŒè´£**ï¼šæ”¶é›†ã€éªŒè¯æ—…è¡Œä¿¡æ¯ï¼Œç”Ÿæˆè¡¨å•é¢„è§ˆ
- **è§¦å‘æ—¶æœº**ï¼šAI è¯†åˆ«åˆ°ç”¨æˆ·æƒ³è¦åˆ›å»ºè¡Œç¨‹æ—¶
- **è¿”å›**ï¼šè¡¨å•æ•°æ® + éªŒè¯çŠ¶æ€ + ç¼ºå¤±å­—æ®µæç¤º

#### å·¥å…· 2: `confirm_and_generate_trip`
- **èŒè´£**ï¼šç”¨æˆ·ç¡®è®¤åï¼Œè§¦å‘ LangGraph å·¥ä½œæµç”Ÿæˆè¡Œç¨‹
- **è§¦å‘æ—¶æœº**ï¼šç”¨æˆ·åœ¨æ¨¡æ€æ¡†ä¸­ç¡®è®¤è¡¨å•
- **è¿”å›**ï¼šè§¦å‘ SSE æµå¼è¿›åº¦ â†’ æœ€ç»ˆè¡Œç¨‹ç»“æœ

### 2.2 ç¡®è®¤ç•Œé¢ï¼šå¡ç‰‡ + æ¨¡æ€æ¡†æ··åˆæ–¹æ¡ˆ

**é€‰æ‹©ç†ç”±**ï¼š
- å¡ç‰‡é¢„è§ˆï¼šåœ¨å¯¹è¯æµä¸­å±•ç¤ºï¼Œä¸æ‰“æ–­å¯¹è¯
- æ¨¡æ€æ¡†ç¼–è¾‘ï¼šæä¾›å®Œæ•´ç¼–è¾‘èƒ½åŠ›ï¼Œèšç„¦ç”¨æˆ·æ³¨æ„åŠ›

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“‹ è¡Œç¨‹è§„åˆ’ç¡®è®¤                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç›®çš„åœ°: æ­å·                                       â”‚
â”‚  æ—¥æœŸ: 2024-12-14 ~ 2024-12-16 (3å¤©)               â”‚
â”‚  é¢„ç®—: Â¥5000                                        â”‚
â”‚  äººæ•°: 2äºº                                          â”‚
â”‚  åå¥½: ç¾é£Ÿã€æ–‡åŒ–å¤è¿¹                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âš ï¸ ç¼ºå°‘å‡ºå‘åœ°ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚           [ä¿®æ”¹è¯¦æƒ…]  [ç¡®è®¤ç”Ÿæˆ]                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 è¿›åº¦å±•ç¤ºï¼šå†…è”è¿›åº¦å¡ç‰‡

åœ¨å¯¹è¯æµä¸­æ˜¾ç¤ºè¯¦ç»†çš„èŠ‚ç‚¹æ‰§è¡Œè¿›åº¦ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœˆï¸ æ­£åœ¨ç”Ÿæˆæ­å· 3 æ—¥æ¸¸è¡Œç¨‹...                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âœ… å¤©æ°”åˆ†æ    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%         â”‚
â”‚  âœ… è¡Œç¨‹è§„åˆ’    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%         â”‚
â”‚  ğŸ”„ ä½å®¿æ¨è    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  40%         â”‚
â”‚  â³ äº¤é€šè§„åˆ’    â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘   0%         â”‚
â”‚  â³ é¤é¥®æ¨è    â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘   0%         â”‚
â”‚  â³ é¢„ç®—å®¡è®¡    â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘   0%         â”‚
â”‚  â³ ç”Ÿæˆè¡Œç¨‹    â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘   0%         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¸‰ã€å®ç°æ¶æ„

### 3.1 æ•°æ®æµ

```
                    å¯¹è¯æ¶ˆæ¯
                       â”‚
                       â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  TravelChatAgent    â”‚
            â”‚  (è¯†åˆ«åˆ›å»ºæ„å›¾)      â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                         â”‚
          â–¼                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ prepare_trip_   â”‚      â”‚ å…¶ä»–å·¥å…·/        â”‚
â”‚ form            â”‚      â”‚ æ™®é€šå›å¤         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TripFormCard (å¯¹è¯å†…å¡ç‰‡é¢„è§ˆ)                       â”‚
â”‚  - æ˜¾ç¤ºæå–çš„ä¿¡æ¯                                    â”‚
â”‚  - é«˜äº®ç¼ºå¤±çš„å¿…å¡«é¡¹                                  â”‚
â”‚  - [ä¿®æ”¹è¯¦æƒ…] [ç¡®è®¤ç”Ÿæˆ] æŒ‰é’®                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ ç”¨æˆ·ç‚¹å‡» [ä¿®æ”¹è¯¦æƒ…]        ç”¨æˆ·ç‚¹å‡» [ç¡®è®¤ç”Ÿæˆ]
         â–¼                                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  TripFormModal      â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  (æ¨¡æ€æ¡†ç¼–è¾‘è¡¨å•)    â”‚
â”‚  - å®Œæ•´è¡¨å•ç¼–è¾‘      â”‚
â”‚  - éªŒè¯å¿…å¡«é¡¹        â”‚
â”‚  - [å–æ¶ˆ] [ç”Ÿæˆ] æŒ‰é’®â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼ ç”¨æˆ·ç‚¹å‡» [ç”Ÿæˆ]
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  confirm_and_generate_trip å·¥å…·è°ƒç”¨                  â”‚
â”‚  â†’ POST /api/chat/generate-trip                     â”‚
â”‚  â†’ è§¦å‘ LangGraph å·¥ä½œæµ                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼ SSE äº‹ä»¶æµ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TripGenerationProgress (å†…è”è¿›åº¦å¡ç‰‡)               â”‚
â”‚  - å®æ—¶æ˜¾ç¤ºèŠ‚ç‚¹çŠ¶æ€                                  â”‚
â”‚  - è¿›åº¦ç™¾åˆ†æ¯”                                        â”‚
â”‚  - é”™è¯¯æç¤º                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼ å®Œæˆ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TripCompletionCard (å®Œæˆå¡ç‰‡)                       â”‚
â”‚  - è¡Œç¨‹æ¦‚è¦                                          â”‚
â”‚  - [æŸ¥çœ‹è¯¦æƒ…] é“¾æ¥åˆ° /dashboard/trips/{id}          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 çŠ¶æ€ç®¡ç†

æ‰©å±• `useChatAgent` hookï¼Œæ·»åŠ è¡Œç¨‹ç”ŸæˆçŠ¶æ€ï¼š

```typescript
interface TripGenerationState {
  // å¾…ç¡®è®¤çš„è¡¨å•æ•°æ®
  pendingForm: TripFormData | null
  // è¡¨å•éªŒè¯çŠ¶æ€
  formValidation: {
    isValid: boolean
    missingRequired: string[]
    missingOptional: string[]
  } | null
  // æ¨¡æ€æ¡†çŠ¶æ€
  isModalOpen: boolean
  // ç”Ÿæˆè¿›åº¦
  generation: {
    isGenerating: boolean
    progress: number
    stages: GenerationStage[]
    currentStage: number
    error: string | null
    result: { trip_id: string } | null
  }
}
```

---

## å››ã€æ–‡ä»¶å˜æ›´æ¸…å•

### 4.1 æ–°å¢æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | è¯´æ˜ |
|----------|------|
| `components/chat/TripFormCard.tsx` | å¯¹è¯å†…è¡¨å•é¢„è§ˆå¡ç‰‡ |
| `components/chat/TripFormModal.tsx` | è¡¨å•ç¼–è¾‘æ¨¡æ€æ¡† |
| `components/chat/TripGenerationProgress.tsx` | å†…è”è¿›åº¦æ˜¾ç¤ºç»„ä»¶ |
| `components/chat/TripCompletionCard.tsx` | ç”Ÿæˆå®Œæˆå¡ç‰‡ |
| `app/api/chat/generate-trip/route.ts` | å¯¹è¯å†…è§¦å‘è¡Œç¨‹ç”Ÿæˆ API |

### 4.2 ä¿®æ”¹æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | ä¿®æ”¹å†…å®¹ |
|----------|----------|
| `lib/chat/tools.ts` | æ·»åŠ  `prepare_trip_form` å’Œ `confirm_and_generate_trip` å·¥å…·å®šä¹‰ |
| `lib/chat/executor.ts` | å®ç°æ–°å·¥å…·çš„æ‰§è¡Œé€»è¾‘ |
| `lib/chat/types.ts` | æ·»åŠ  `TripFormState`ã€`TripGenerationEvent` ç­‰ç±»å‹ |
| `hooks/useChatAgent.ts` | æ‰©å±•æ”¯æŒè¡Œç¨‹ç”ŸæˆçŠ¶æ€ç®¡ç† |
| `components/chat/MessageList.tsx` | æ”¯æŒæ¸²æŸ“æ–°çš„å¡ç‰‡ç»„ä»¶ |
| `components/chat/ToolCallCard.tsx` | æ·»åŠ æ–°å·¥å…·çš„å›¾æ ‡å’Œæ ·å¼ |
| `components/chat/index.ts` | å¯¼å‡ºæ–°ç»„ä»¶ |

---

## äº”ã€å®ç°æ­¥éª¤

### Phase 1: ç±»å‹ä¸å·¥å…·å®šä¹‰ âœ…

**ç›®æ ‡**ï¼šå®šä¹‰æ–°å·¥å…·å’Œç›¸å…³ç±»å‹

1. **ä¿®æ”¹ `lib/chat/types.ts`** âœ…
   - æ·»åŠ  `TripFormState` ç±»å‹ï¼ˆè¡¨å•æ•°æ® + éªŒè¯çŠ¶æ€ï¼‰
   - æ·»åŠ  `TripGenerationEvent` ç±»å‹ï¼ˆSSE äº‹ä»¶ï¼‰
   - æ·»åŠ  `ChatMessageType` æ‰©å±•ï¼ˆ`trip_form_preview` | `trip_generation_progress` | `trip_completion`ï¼‰

2. **ä¿®æ”¹ `lib/chat/tools.ts`** âœ…
   - æ·»åŠ  `prepare_trip_form` å·¥å…·å®šä¹‰
   - æ·»åŠ  `confirm_and_generate_trip` å·¥å…·å®šä¹‰
   - æ›´æ–° `TOOL_DESCRIPTIONS` å’Œ `TOOL_ICONS`

### Phase 2: å·¥å…·æ‰§è¡Œå™¨å®ç° âœ…

**ç›®æ ‡**ï¼šå®ç°å·¥å…·çš„åç«¯é€»è¾‘

1. **ä¿®æ”¹ `lib/chat/executor.ts`** âœ…
   - å®ç° `prepareTripForm()` æ–¹æ³•
     - éªŒè¯å¿…å¡«å­—æ®µ
     - è¿”å›è¡¨å•æ•°æ® + éªŒè¯ç»“æœ
   - å®ç° `confirmAndGenerateTrip()` æ–¹æ³•
     - è¿”å›ç‰¹æ®Šæ ‡è®°ï¼ŒæŒ‡ç¤ºå‰ç«¯è§¦å‘ç”Ÿæˆæµç¨‹

### Phase 3: API ç«¯ç‚¹ âœ…

**ç›®æ ‡**ï¼šåˆ›å»ºå¯¹è¯å†…ç”Ÿæˆè¡Œç¨‹çš„ API

1. **æ–°å»º `app/api/chat/generate-trip/route.ts`** âœ…
   - POST ç«¯ç‚¹ï¼Œæ¥æ”¶è¡¨å•æ•°æ®
   - å¤ç”¨ç°æœ‰ LangGraph å·¥ä½œæµé€»è¾‘
   - è¿”å› SSE æµå¼äº‹ä»¶
   - ç”Ÿæˆå®Œæˆåä¿å­˜è¡Œç¨‹å¹¶å…³è”ä¼šè¯

### Phase 4: å‰ç«¯ç»„ä»¶ âœ…

**ç›®æ ‡**ï¼šå®ç°å¯¹è¯å†…çš„ UI ç»„ä»¶

1. **æ–°å»º `components/chat/TripFormCard.tsx`** âœ…
   - å¡ç‰‡å¼è¡¨å•é¢„è§ˆ
   - æ˜¾ç¤ºå·²å¡«å†™å’Œç¼ºå¤±çš„å­—æ®µ
   - [ä¿®æ”¹è¯¦æƒ…] å’Œ [ç¡®è®¤ç”Ÿæˆ] æŒ‰é’®

2. **æ–°å»º `components/chat/TripFormModal.tsx`** âœ…
   - å¤ç”¨åˆ›å»ºé¡µé¢çš„è¡¨å•é€»è¾‘
   - ç´§å‡‘å¸ƒå±€è®¾è®¡
   - è¡¨å•éªŒè¯å’Œæäº¤

3. **æ–°å»º `components/chat/TripGenerationProgress.tsx`** âœ…
   - å†…è”è¿›åº¦æ¡ç»„ä»¶
   - å¤ç”¨ `useLangGraphProgress` çš„æ•°æ®ç»“æ„
   - èŠ‚ç‚¹çŠ¶æ€å›¾æ ‡å’Œè¿›åº¦ç™¾åˆ†æ¯”

4. **æ–°å»º `components/chat/TripCompletionCard.tsx`** âœ…
   - ç”Ÿæˆå®Œæˆå±•ç¤ºå¡ç‰‡
   - è¡Œç¨‹æ¦‚è¦ä¿¡æ¯
   - è·³è½¬é“¾æ¥

### Phase 5: Hook é›†æˆ âœ…

**ç›®æ ‡**ï¼šæ‰©å±• useChatAgent æ”¯æŒè¡Œç¨‹ç”Ÿæˆ

1. **ä¿®æ”¹ `hooks/useChatAgent.ts`** âœ…
   - æ·»åŠ  `tripGenerationState` çŠ¶æ€
   - æ·»åŠ  `openFormModal()` / `closeFormModal()` æ–¹æ³•
   - æ·»åŠ  `startTripGeneration()` æ–¹æ³•
   - å¤„ç† SSE äº‹ä»¶æ›´æ–°è¿›åº¦

### Phase 6: æ¶ˆæ¯åˆ—è¡¨é›†æˆ âœ…

**ç›®æ ‡**ï¼šåœ¨æ¶ˆæ¯åˆ—è¡¨ä¸­æ¸²æŸ“æ–°ç»„ä»¶

1. **ä¿®æ”¹ `components/chat/MessageList.tsx`** âœ…
   - æ ¹æ®æ¶ˆæ¯ç±»å‹æ¸²æŸ“å¯¹åº”ç»„ä»¶
   - å¤„ç† `trip_form_preview` ç±»å‹æ¶ˆæ¯
   - å¤„ç† `trip_generation_progress` ç±»å‹æ¶ˆæ¯
   - å¤„ç† `trip_completion` ç±»å‹æ¶ˆæ¯

2. **ä¿®æ”¹ `components/chat/ToolCallCard.tsx`** âœ…
   - æ·»åŠ æ–°å·¥å…·çš„å›¾æ ‡å’Œé¢œè‰²

3. **ä¿®æ”¹ `components/chat/index.ts`** âœ…
   - å¯¼å‡ºæ–°ç»„ä»¶

### Phase 7: æµ‹è¯•ä¸æ–‡æ¡£ âœ…

**ç›®æ ‡**ï¼šæµ‹è¯•åŠŸèƒ½å¹¶æ›´æ–°æ–‡æ¡£

1. ç«¯åˆ°ç«¯æµ‹è¯• âœ…
   - æ„å»ºéªŒè¯é€šè¿‡
   - å¯¹è¯åˆ›å»ºè¡Œç¨‹å®Œæ•´æµç¨‹
   - è¡¨å•éªŒè¯æµ‹è¯•
   - é”™è¯¯å¤„ç†æµ‹è¯•

2. æ›´æ–°æ–‡æ¡£
   - æ›´æ–° CLAUDE.md

---

## å…­ã€å…³é”®ä»£ç è®¾è®¡

### 6.1 æ–°å·¥å…·å®šä¹‰ (`lib/chat/tools.ts`)

```typescript
// prepare_trip_form å·¥å…·
{
  type: 'function',
  function: {
    name: 'prepare_trip_form',
    description: 'å‡†å¤‡æ—…è¡Œè§„åˆ’è¡¨å•ã€‚ä»å¯¹è¯ä¸­æå–ä¿¡æ¯ï¼ŒéªŒè¯å¿…å¡«å­—æ®µï¼Œç”Ÿæˆè¡¨å•é¢„è§ˆä¾›ç”¨æˆ·ç¡®è®¤ã€‚',
    parameters: {
      type: 'object',
      properties: {
        destination: { type: 'string', description: 'ç›®çš„åœ°' },
        start_date: { type: 'string', description: 'å¼€å§‹æ—¥æœŸ YYYY-MM-DD' },
        end_date: { type: 'string', description: 'ç»“æŸæ—¥æœŸ YYYY-MM-DD' },
        budget: { type: 'number', description: 'é¢„ç®—ï¼ˆå…ƒï¼‰' },
        travelers: { type: 'number', description: 'å‡ºè¡Œäººæ•°' },
        origin: { type: 'string', description: 'å‡ºå‘åœ°ï¼ˆå¯é€‰ï¼‰' },
        preferences: { type: 'array', items: { type: 'string' }, description: 'åå¥½' },
        // ... å…¶ä»–å­—æ®µ
      },
      required: [], // ä¸å¼ºåˆ¶è¦æ±‚ï¼Œè®© AI çµæ´»æå–
    },
  },
}

// confirm_and_generate_trip å·¥å…·
{
  type: 'function',
  function: {
    name: 'confirm_and_generate_trip',
    description: 'ç¡®è®¤è¡¨å•å¹¶å¼€å§‹ç”Ÿæˆè¡Œç¨‹ã€‚ä»…åœ¨ç”¨æˆ·æ˜ç¡®ç¡®è®¤åè°ƒç”¨ã€‚',
    parameters: {
      type: 'object',
      properties: {
        form_data: { type: 'object', description: 'å®Œæ•´çš„è¡¨å•æ•°æ®' },
      },
      required: ['form_data'],
    },
  },
}
```

### 6.2 TripFormCard ç»„ä»¶ç»“æ„

```typescript
interface TripFormCardProps {
  formData: Partial<TripFormData>
  validation: {
    isValid: boolean
    missingRequired: string[]
    missingOptional: string[]
  }
  onEdit: () => void           // æ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡†
  onConfirm: () => void        // ç¡®è®¤å¹¶ç”Ÿæˆ
  onCancel: () => void         // å–æ¶ˆ
  isGenerating?: boolean       // æ˜¯å¦æ­£åœ¨ç”Ÿæˆ
}
```

### 6.3 SSE äº‹ä»¶å¤„ç†

```typescript
// åœ¨ useChatAgent ä¸­å¤„ç†ç”Ÿæˆè¿›åº¦
const handleGenerationSSE = async (formData: TripFormData) => {
  const response = await fetch('/api/chat/generate-trip', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Accept': 'text/event-stream',
      'Authorization': `Bearer ${accessToken}`,
    },
    body: JSON.stringify({ form_data: formData, session_id: sessionId }),
  })

  // å¤ç”¨ useLangGraphProgress çš„ SSE è§£æé€»è¾‘
  // æ›´æ–° tripGenerationState
}
```

---

## ä¸ƒã€éªŒæ”¶æ ‡å‡†

### 7.1 åŠŸèƒ½éªŒæ”¶

- [ ] ç”¨æˆ·å¯ä»¥é€šè¿‡å¯¹è¯æè¿°æ—…è¡Œéœ€æ±‚
- [ ] AI èƒ½è‡ªåŠ¨æå–ä¿¡æ¯å¹¶æ˜¾ç¤ºè¡¨å•é¢„è§ˆå¡ç‰‡
- [ ] ç”¨æˆ·å¯ä»¥ç‚¹å‡»"ä¿®æ”¹è¯¦æƒ…"æ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡†
- [ ] ç”¨æˆ·å¯ä»¥ç‚¹å‡»"ç¡®è®¤ç”Ÿæˆ"è§¦å‘è¡Œç¨‹ç”Ÿæˆ
- [ ] ç”Ÿæˆè¿‡ç¨‹ä¸­æ˜¾ç¤ºè¯¦ç»†çš„èŠ‚ç‚¹è¿›åº¦
- [ ] ç”Ÿæˆå®Œæˆåæ˜¾ç¤ºå®Œæˆå¡ç‰‡å’Œè·³è½¬é“¾æ¥
- [ ] ç¼ºå¤±å¿…å¡«å­—æ®µæ—¶ AI ä¸»åŠ¨è¯¢é—®

### 7.2 è¾¹ç•Œæƒ…å†µ

- [ ] ç”¨æˆ·å–æ¶ˆç”Ÿæˆ
- [ ] ç”Ÿæˆè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯
- [ ] ç½‘ç»œä¸­æ–­åçš„æ¢å¤
- [ ] è¡¨å•éªŒè¯å¤±è´¥æç¤º

---

## å…«ã€é£é™©ä¸ç¼“è§£

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|----------|
| AI æå–ä¿¡æ¯ä¸å‡†ç¡® | ä¸­ | æä¾›æ˜ç¡®çš„ç¡®è®¤æ­¥éª¤ï¼Œç”¨æˆ·å¯ä¿®æ”¹ |
| ç”Ÿæˆè¿‡ç¨‹è¾ƒé•¿ | ä¸­ | æ˜¾ç¤ºè¯¦ç»†è¿›åº¦ï¼Œæä¾›å–æ¶ˆé€‰é¡¹ |
| çŠ¶æ€ç®¡ç†å¤æ‚ | ä¸­ | ç‹¬ç«‹å°è£…è¡Œç¨‹ç”ŸæˆçŠ¶æ€ï¼Œä¸å¯¹è¯çŠ¶æ€åˆ†ç¦» |

---

## ä¹ã€åç»­ä¼˜åŒ–æ–¹å‘

1. **å†å²è®°å½•** âœ… è®¡åˆ’å·²å®Œæˆ
   - è¯¦ç»†è®¡åˆ’æ–‡æ¡£ï¼š[å¯¹è¯å¼è¡Œç¨‹å†å²è®°å½•åŠŸèƒ½è®¡åˆ’.md](./å¯¹è¯å¼è¡Œç¨‹å†å²è®°å½•åŠŸèƒ½è®¡åˆ’.md)
   - åŠŸèƒ½ï¼šè®°å½•ç”¨æˆ·çš„ç”Ÿæˆå†å²ï¼Œæ”¯æŒå¿«é€Ÿå¤ç”¨
   - çŠ¶æ€ï¼šå¾…å®æ–½

2. **æ¨¡æ¿åŠŸèƒ½**ï¼šæ”¯æŒä¿å­˜å¸¸ç”¨çš„æ—…è¡Œæ¨¡æ¿
3. **æ™ºèƒ½è¡¥å…¨**ï¼šæ ¹æ®ç”¨æˆ·å†å²åå¥½è‡ªåŠ¨å¡«å……é»˜è®¤å€¼
4. **å¤šè½®ä¿®æ”¹**ï¼šç”Ÿæˆåæ”¯æŒé€šè¿‡å¯¹è¯ç»§ç»­ä¿®æ”¹è¡Œç¨‹

---

## æ›´æ–°æ—¥å¿—

| æ—¥æœŸ | ç‰ˆæœ¬ | æ›´æ–°å†…å®¹ |
|------|------|----------|
| 2025-12-07 | v1.0 | åˆå§‹è®¡åˆ’æ–‡æ¡£ |
| 2025-12-07 | v1.1 | å®Œæˆæ‰€æœ‰ 7 ä¸ªé˜¶æ®µå®ç°ï¼Œé›†æˆå¯¹è¯é¡µé¢ï¼Œæ·»åŠ è‡ªåŠ¨è§¦å‘ç”Ÿæˆé€»è¾‘ |
