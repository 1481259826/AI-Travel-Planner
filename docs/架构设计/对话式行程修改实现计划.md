# å¯¹è¯å¼è¡Œç¨‹ä¿®æ”¹åŠŸèƒ½å®ç°è®¡åˆ’

> ç‰ˆæœ¬: v1.4
> åˆ›å»ºæ—¥æœŸ: 2025-12-08
> æœ€åæ›´æ–°: 2025-12-10
> çŠ¶æ€: Phase 4 å·²å®Œæˆ
> å‰ç½®æ–‡æ¡£: [å¯¹è¯å¼è¡Œç¨‹ç”Ÿæˆå®ç°è®¡åˆ’.md](./å¯¹è¯å¼è¡Œç¨‹ç”Ÿæˆå®ç°è®¡åˆ’.md)

---

## ä¸€ã€éœ€æ±‚æ¦‚è¿°

### 1.1 ç›®æ ‡

åœ¨ç°æœ‰å¯¹è¯ç³»ç»Ÿä¸­å¢å¼ºè¡Œç¨‹ä¿®æ”¹åŠŸèƒ½ï¼Œè®©ç”¨æˆ·é€šè¿‡è‡ªç„¶è¯­è¨€å¯¹è¯æ¥ä¿®æ”¹å·²ç”Ÿæˆçš„è¡Œç¨‹ï¼Œæ”¯æŒä»ç®€å•çš„æ™¯ç‚¹å¢åˆ åˆ°æ™ºèƒ½é‡è§„åˆ’çš„å®Œæ•´ä¿®æ”¹åœºæ™¯ã€‚

### 1.2 æ ¸å¿ƒæµç¨‹

```
ç”¨æˆ·æè¿°ä¿®æ”¹éœ€æ±‚ â†’ AI è§£ææ„å›¾ â†’ ç”Ÿæˆä¿®æ”¹é¢„è§ˆï¼ˆå‰åå¯¹æ¯”ï¼‰
    â†’ ç”¨æˆ·ç¡®è®¤/å–æ¶ˆ/å¾®è°ƒ â†’ ä¿å­˜åˆ°æ•°æ®åº“ â†’ åˆ·æ–°è¡Œç¨‹æ˜¾ç¤º
```

### 1.3 åŠŸèƒ½èŒƒå›´

| åŠŸèƒ½ç±»åˆ« | å…·ä½“æ“ä½œ | å¤æ‚åº¦ |
|---------|---------|--------|
| **åŸºç¡€ä¿®æ”¹** | æ·»åŠ /åˆ é™¤æ™¯ç‚¹ã€è°ƒæ•´æ—¶é—´ã€é‡æ–°æ’åºã€æ›´æ¢ä½å®¿/é¤å… | ä½ |
| **ç»“æ„å˜æ›´** | å¢åŠ /åˆ é™¤å¤©æ•°ã€æ‹†åˆ†/åˆå¹¶å¤©æ•° | ä¸­ |
| **æ™ºèƒ½é‡è§„åˆ’** | ä¼˜åŒ–è·¯çº¿é¡ºåºã€æ ¹æ®çº¦æŸé‡æ–°è§„åˆ’æŸå¤©ã€å¤©æ°”é€‚åº” | é«˜ |
| **å®Œæ•´é‡ç”Ÿæˆ** | é‡æ–°ç”ŸæˆæŸä¸€å¤©æˆ–è¿ç»­å¤šå¤©çš„è¡Œç¨‹ | å¾ˆé«˜ |

### 1.4 ä½¿ç”¨åœºæ™¯

| å…¥å£ | åœºæ™¯æè¿° |
|-----|---------|
| **è¡Œç¨‹è¯¦æƒ…é¡µ** | ç”¨æˆ·æŸ¥çœ‹è¡Œç¨‹æ—¶ï¼Œé€šè¿‡ä¾§è¾¹æ æˆ–æ‚¬æµ®æŒ‰é’®æ‰“å¼€å¯¹è¯é¢æ¿ï¼Œç›´æ¥ä¿®æ”¹å½“å‰è¡Œç¨‹ |
| **å¯¹è¯åŠ©æ‰‹é¡µ** | åœ¨ `/dashboard/chat` é¡µé¢ï¼Œé€‰æ‹©è¦ä¿®æ”¹çš„è¡Œç¨‹åè¿›è¡Œå¯¹è¯ |

### 1.5 ç¡®è®¤æœºåˆ¶

é‡‡ç”¨**é¢„è§ˆç¡®è®¤**æ¨¡å¼ï¼š
- æ‰€æœ‰ä¿®æ”¹å…ˆç”Ÿæˆé¢„è§ˆï¼Œæ˜¾ç¤ºå˜æ›´æ‘˜è¦å’Œå‰åå¯¹æ¯”
- ç”¨æˆ·ç¡®è®¤åæ‰ä¿å­˜åˆ°æ•°æ®åº“
- æ”¯æŒå–æ¶ˆæˆ–å¾®è°ƒé¢„è§ˆå†…å®¹

---

## äºŒã€ç°æœ‰ç³»ç»Ÿåˆ†æ

### 2.1 ç°æœ‰ modify_itinerary å·¥å…·

**ä½ç½®**: `lib/chat/tools.ts` (ç¬¬ 132-200 è¡Œ)

**ç°æœ‰æ“ä½œç±»å‹**:
```typescript
enum: [
  'add_attraction',    // æ·»åŠ æ™¯ç‚¹
  'remove_attraction', // åˆ é™¤æ™¯ç‚¹
  'reorder',           // è°ƒæ•´é¡ºåº
  'change_time',       // ä¿®æ”¹æ—¶é—´
  'add_day',           // å¢åŠ ä¸€å¤©
  'remove_day',        // åˆ é™¤ä¸€å¤©
  'change_hotel',      // æ›´æ¢é…’åº—
  'change_restaurant', // æ›´æ¢é¤å…
]
```

**é—®é¢˜**:
- âš ï¸ ç›´æ¥ä¿å­˜åˆ°æ•°æ®åº“ï¼Œæ— é¢„è§ˆç¡®è®¤æœºåˆ¶
- âš ï¸ ç¼ºå°‘æ™ºèƒ½é‡è§„åˆ’åŠŸèƒ½
- âš ï¸ ä¸æ”¯æŒéƒ¨åˆ†é‡ç”Ÿæˆ

### 2.2 ç°æœ‰æ‰§è¡Œå™¨å®ç°

**ä½ç½®**: `lib/chat/executor.ts` (ç¬¬ 400-522 è¡Œ)

`modifyItinerary()` æ–¹æ³•å·²å®ç°ï¼š
- æ™¯ç‚¹å¢åˆ 
- é¡ºåºè°ƒæ•´
- æ—¶é—´ä¿®æ”¹
- å¤©æ•°å¢åˆ 

**é—®é¢˜**: ç›´æ¥è°ƒç”¨ `supabase.update()` ä¿å­˜ï¼Œæ— æ³•é¢„è§ˆ

### 2.3 ç°æœ‰å¯¹è¯å¼ç”Ÿæˆç»„ä»¶

å·²æœ‰å¯å¤ç”¨çš„ç»„ä»¶ï¼š
- `TripFormCard.tsx` - è¡¨å•é¢„è§ˆå¡ç‰‡ï¼ˆå¯å‚è€ƒè®¾è®¡ï¼‰
- `TripGenerationProgress.tsx` - è¿›åº¦æ˜¾ç¤ºï¼ˆé‡è§„åˆ’æ—¶å¯å¤ç”¨ï¼‰
- `TripCompletionCard.tsx` - å®Œæˆå¡ç‰‡

---

## ä¸‰ã€è®¾è®¡æ–¹æ¡ˆ

### 3.1 å·¥å…·è®¾è®¡ï¼šä¸¤æ­¥ç¡®è®¤æµç¨‹

ä¸ºäº†æ”¯æŒé¢„è§ˆç¡®è®¤ï¼Œè®¾è®¡ä¸¤ä¸ªæ–°å·¥å…·æ›¿ä»£ç°æœ‰çš„ç›´æ¥ä¿å­˜æ¨¡å¼ï¼š

#### å·¥å…· 1: `prepare_itinerary_modification`

- **èŒè´£**: å‡†å¤‡ä¿®æ”¹ï¼Œç”Ÿæˆé¢„è§ˆæ•°æ®ï¼Œ**ä¸ä¿å­˜**
- **è§¦å‘æ—¶æœº**: AI è¯†åˆ«åˆ°ç”¨æˆ·æƒ³è¦ä¿®æ”¹è¡Œç¨‹æ—¶
- **è¿”å›**: ä¿®æ”¹é¢„è§ˆï¼ˆbefore/after å¯¹æ¯”ï¼‰+ ä¿®æ”¹ ID + å½±å“è¯„ä¼°

#### å·¥å…· 2: `confirm_itinerary_modification`

- **èŒè´£**: ç”¨æˆ·ç¡®è®¤åï¼Œåº”ç”¨ä¿®æ”¹å¹¶ä¿å­˜åˆ°æ•°æ®åº“
- **è§¦å‘æ—¶æœº**: ç”¨æˆ·ç‚¹å‡»"ç¡®è®¤ä¿®æ”¹"æŒ‰é’®
- **è¿”å›**: ä¿å­˜ç»“æœ + æ›´æ–°åçš„è¡Œç¨‹

### 3.2 æ“ä½œç±»å‹æ‰©å±•

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ“ä½œç±»å‹åˆ†å±‚æ¶æ„                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  Level 1: åŸºç¡€ä¿®æ”¹ï¼ˆç›´æ¥è®¡ç®—é¢„è§ˆï¼Œæ¯«ç§’çº§ï¼‰                        â”‚
â”‚  â”œâ”€â”€ add_attraction      æ·»åŠ æ™¯ç‚¹åˆ°æŒ‡å®šå¤©æ•°                      â”‚
â”‚  â”œâ”€â”€ remove_attraction   ä»æŒ‡å®šå¤©æ•°åˆ é™¤æ™¯ç‚¹                      â”‚
â”‚  â”œâ”€â”€ reorder            è°ƒæ•´æ™¯ç‚¹é¡ºåºï¼ˆåŒå¤©/è·¨å¤©ï¼‰                 â”‚
â”‚  â”œâ”€â”€ change_time        ä¿®æ”¹æ™¯ç‚¹å¼€å§‹æ—¶é—´                         â”‚
â”‚  â”œâ”€â”€ change_hotel       æ›´æ¢ä½å®¿                                 â”‚
â”‚  â””â”€â”€ change_restaurant  æ›´æ¢é¤å…                                 â”‚
â”‚                                                                  â”‚
â”‚  Level 2: ç»“æ„å˜æ›´ï¼ˆéœ€è¦é‡æ–°è®¡ç®—æ—¶é—´åˆ†é…ï¼Œç§’çº§ï¼‰                  â”‚
â”‚  â”œâ”€â”€ add_day            åœ¨æŒ‡å®šä½ç½®æ’å…¥æ–°çš„ä¸€å¤©                   â”‚
â”‚  â”œâ”€â”€ remove_day         åˆ é™¤æŒ‡å®šå¤©æ•°                             â”‚
â”‚  â”œâ”€â”€ split_day          å°†ä¸€å¤©æ‹†åˆ†ä¸ºä¸¤å¤©                         â”‚
â”‚  â””â”€â”€ merge_days         å°†è¿ç»­ä¸¤å¤©åˆå¹¶ä¸ºä¸€å¤©                     â”‚
â”‚                                                                  â”‚
â”‚  Level 3: æ™ºèƒ½é‡è§„åˆ’ï¼ˆè°ƒç”¨ AI ä¼˜åŒ–ï¼Œ10ç§’çº§ï¼‰                     â”‚
â”‚  â”œâ”€â”€ optimize_route     ä¼˜åŒ–è·¯çº¿é¡ºåºï¼Œæœ€å°åŒ–äº¤é€šæ—¶é—´              â”‚
â”‚  â”œâ”€â”€ replan_day         æ ¹æ®çº¦æŸé‡æ–°è§„åˆ’æŸå¤©ï¼ˆå¦‚æ™¯ç‚¹å…³é—­ï¼‰        â”‚
â”‚  â””â”€â”€ adjust_for_weather æ ¹æ®å¤©æ°”è°ƒæ•´è¡Œç¨‹ï¼ˆå®¤å†…/å®¤å¤–ï¼‰             â”‚
â”‚                                                                  â”‚
â”‚  Level 4: å®Œæ•´é‡ç”Ÿæˆï¼ˆè°ƒç”¨ LangGraph å·¥ä½œæµï¼Œåˆ†é’Ÿçº§ï¼‰            â”‚
â”‚  â”œâ”€â”€ regenerate_day          é‡æ–°ç”ŸæˆæŸå¤©çš„å®Œæ•´è¡Œç¨‹               â”‚
â”‚  â””â”€â”€ regenerate_trip_segment é‡æ–°ç”Ÿæˆè¿ç»­å¤šå¤©çš„è¡Œç¨‹               â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 ç¡®è®¤ç•Œé¢ï¼šä¿®æ”¹é¢„è§ˆå¡ç‰‡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœï¸ è¡Œç¨‹ä¿®æ”¹é¢„è§ˆ                              [åˆ é™¤æ™¯ç‚¹]       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  ğŸ“ å˜æ›´æ‘˜è¦                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ âŒ åˆ é™¤ã€Œè¥¿æ¹–æ¸¸èˆ¹ã€ä»ç¬¬ 2 å¤©                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  ğŸ“Š å½±å“è¯„ä¼°                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â€¢ å—å½±å“å¤©æ•°: ç¬¬ 2 å¤©                                     â”‚   â”‚
â”‚  â”‚ â€¢ é¢„ç®—å˜åŒ–: -Â¥120                                         â”‚   â”‚
â”‚  â”‚ â€¢ æ—¶é—´å˜åŒ–: é‡Šæ”¾ 2 å°æ—¶                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  âš ï¸ åˆ é™¤åç¬¬ 2 å¤©ä¸‹åˆå°†æœ‰è¾ƒå¤šç©ºé—²æ—¶é—´ï¼Œå»ºè®®æ·»åŠ å…¶ä»–æ´»åŠ¨        â”‚
â”‚                                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚              [å–æ¶ˆ]    [æŸ¥çœ‹è¯¦æƒ…]    [ç¡®è®¤ä¿®æ”¹]                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.4 è¯¦ç»†å¯¹æ¯”è§†å›¾ï¼ˆç‚¹å‡»"æŸ¥çœ‹è¯¦æƒ…"å±•å¼€ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“‹ ä¿®æ”¹å‰åå¯¹æ¯”                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         ä¿®æ”¹å‰            â”‚            ä¿®æ”¹å                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç¬¬ 2 å¤© - 12æœˆ26æ—¥       â”‚  ç¬¬ 2 å¤© - 12æœˆ26æ—¥                â”‚
â”‚  â”œâ”€ 09:00 çµéšå¯º          â”‚  â”œâ”€ 09:00 çµéšå¯º                   â”‚
â”‚  â”œâ”€ 12:00 åˆé¤            â”‚  â”œâ”€ 12:00 åˆé¤                     â”‚
â”‚  â”œâ”€ 14:00 è¥¿æ¹–æ¸¸èˆ¹ âŒ     â”‚  â”œâ”€ 14:00 (ç©ºé—²)                   â”‚
â”‚  â””â”€ 17:00 æ²³åŠè¡—          â”‚  â””â”€ 17:00 æ²³åŠè¡—                   â”‚
â”‚                           â”‚                                    â”‚
â”‚  é¢„ç®—: Â¥1,200             â”‚  é¢„ç®—: Â¥1,080 (-Â¥120)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å››ã€æ•°æ®æµæ¶æ„

### 4.1 åŸºç¡€ä¿®æ”¹æµç¨‹

```
ç”¨æˆ·æ¶ˆæ¯: "æŠŠç¬¬äºŒå¤©çš„è¥¿æ¹–æ¸¸èˆ¹åˆ æ‰"
                â”‚
                â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ TravelChat    â”‚  1. è§£æç”¨æˆ·æ„å›¾
        â”‚ Agent         â”‚  2. æå–å‚æ•°:
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     - operation: remove_attraction
                â”‚             - day_index: 1
                â–¼             - activity_name: "è¥¿æ¹–æ¸¸èˆ¹"
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ prepare_itinerary_modification      â”‚
â”‚ å·¥å…·è°ƒç”¨                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ ToolExecutor  â”‚  1. åŠ è½½å½“å‰è¡Œç¨‹
        â”‚               â”‚  2. å®šä½"è¥¿æ¹–æ¸¸èˆ¹"
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  3. è®¡ç®—åˆ é™¤åçš„è¡Œç¨‹
                â”‚          4. ç”Ÿæˆ before/after å¯¹æ¯”
                â–¼          5. ç¼“å­˜ pending ä¿®æ”¹
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ModificationPreview å“åº”             â”‚
â”‚ {                                   â”‚
â”‚   id: "mod_abc123",                 â”‚
â”‚   operation: "remove_attraction",   â”‚
â”‚   before: { days: [...] },          â”‚
â”‚   after: { days: [...] },           â”‚
â”‚   changes: [{ type: "remove", ... }]â”‚
â”‚   impact: { costDelta: -120, ... }  â”‚
â”‚ }                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‰ç«¯æ¸²æŸ“ ModificationPreviewCard    â”‚
â”‚ æ˜¾ç¤ºå˜æ›´æ‘˜è¦ + å½±å“è¯„ä¼°              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
        ç”¨æˆ·ç‚¹å‡» [ç¡®è®¤ä¿®æ”¹]
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ confirm_itinerary_modification      â”‚
â”‚ { modification_id: "mod_abc123" }   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ ToolExecutor  â”‚  1. ä»ç¼“å­˜è·å– pending ä¿®æ”¹
        â”‚               â”‚  2. åº”ç”¨åˆ°æ•°æ®åº“
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  3. æ¸…é™¤ç¼“å­˜
                â”‚          4. è¿”å›æ›´æ–°åçš„è¡Œç¨‹
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å®Œæˆå“åº”                             â”‚
â”‚ "å·²ä»ç¬¬ 2 å¤©åˆ é™¤ã€Œè¥¿æ¹–æ¸¸èˆ¹ã€"         â”‚
â”‚ + æ›´æ–°åçš„è¡Œç¨‹æ•°æ®                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‰ç«¯åˆ·æ–°è¡Œç¨‹æ˜¾ç¤º                     â”‚
â”‚ (å¦‚æœåœ¨è¡Œç¨‹è¯¦æƒ…é¡µï¼Œæ»šåŠ¨åˆ°ä¿®æ”¹ä½ç½®)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 æ™ºèƒ½é‡è§„åˆ’æµç¨‹

```
ç”¨æˆ·æ¶ˆæ¯: "ç¬¬äºŒå¤©çš„åšç‰©é¦†ä¸´æ—¶é—­é¦†äº†ï¼Œå¸®æˆ‘é‡æ–°è§„åˆ’è¿™ä¸€å¤©"
                â”‚
                â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ TravelChat    â”‚  è§£ææ„å›¾:
        â”‚ Agent         â”‚  - operation: replan_day
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  - day_index: 1
                â”‚          - reason: "åšç‰©é¦†é—­é¦†"
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ prepare_itinerary_modification      â”‚
â”‚ { operation: "replan_day", ... }    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ ToolExecutor  â”‚  1. åŠ è½½è¡Œç¨‹å’Œç¬¬ 2 å¤©æ•°æ®
        â”‚               â”‚  2. æå–çº¦æŸæ¡ä»¶
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     - æ’é™¤: åšç‰©é¦†
                â”‚             - ä¿ç•™: å·²ç¡®å®šçš„é¤å…
                â–¼             - åå¥½: åŸæœ‰çš„æ—…è¡Œé£æ ¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Modification Workflow               â”‚
â”‚ (è°ƒç”¨ LangGraph éƒ¨åˆ† Agent)          â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Itinerary   â”‚â†’ â”‚ Transport   â”‚   â”‚
â”‚  â”‚ Planner     â”‚  â”‚ Agent       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                â”‚          â”‚
â”‚         â–¼                â–¼          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚ Dining      â”‚                    â”‚
â”‚  â”‚ Agent       â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼ è¿”å›æ–°çš„ç¬¬ 2 å¤©è®¡åˆ’
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ModificationPreview å“åº”             â”‚
â”‚ åŒ…å«æ–°çš„æ™¯ç‚¹æ¨èã€æ—¶é—´å®‰æ’ã€é¤é¥®æ¨è  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
        (åç»­æµç¨‹åŒä¸Š)
```

---

## äº”ã€ç±»å‹å®šä¹‰

### 5.1 æ“ä½œç±»å‹æšä¸¾

```typescript
// lib/chat/types.ts

/**
 * è¡Œç¨‹ä¿®æ”¹æ“ä½œç±»å‹
 */
export type ItineraryModificationOperation =
  // åŸºç¡€ä¿®æ”¹
  | 'add_attraction'
  | 'remove_attraction'
  | 'reorder'
  | 'change_time'
  | 'change_hotel'
  | 'change_restaurant'
  // ç»“æ„å˜æ›´
  | 'add_day'
  | 'remove_day'
  | 'split_day'
  | 'merge_days'
  // æ™ºèƒ½é‡è§„åˆ’
  | 'optimize_route'
  | 'replan_day'
  | 'adjust_for_weather'
  // å®Œæ•´é‡ç”Ÿæˆ
  | 'regenerate_day'
  | 'regenerate_trip_segment'
```

### 5.2 ä¿®æ”¹é¢„è§ˆæ•°æ®ç»“æ„

```typescript
/**
 * ä¿®æ”¹é¢„è§ˆæ•°æ®
 */
export interface ModificationPreview {
  /** å”¯ä¸€ä¿®æ”¹ IDï¼Œç”¨äºç¡®è®¤æ—¶å¼•ç”¨ */
  id: string

  /** è¡Œç¨‹ ID */
  tripId: string

  /** æ“ä½œç±»å‹ */
  operation: ItineraryModificationOperation

  /** ä¿®æ”¹å‰çš„è¡Œç¨‹æ‘˜è¦ */
  before: {
    days: DayPlanSummary[]
    totalCost: number
  }

  /** ä¿®æ”¹åçš„è¡Œç¨‹æ‘˜è¦ */
  after: {
    days: DayPlanSummary[]
    totalCost: number
  }

  /** å˜æ›´åˆ—è¡¨ */
  changes: ModificationChange[]

  /** å½±å“è¯„ä¼° */
  impact: {
    /** å—å½±å“çš„å¤©æ•° */
    affectedDays: number[]
    /** æˆæœ¬å˜åŒ–ï¼ˆæ­£æ•°è¡¨ç¤ºå¢åŠ ï¼‰ */
    costDelta: number
    /** æ—¶é—´å½±å“æè¿° */
    timeImpact: string
    /** è­¦å‘Šä¿¡æ¯ */
    warnings: string[]
  }

  /** åˆ›å»ºæ—¶é—´ */
  createdAt: number

  /** è¿‡æœŸæ—¶é—´ï¼ˆ10åˆ†é’Ÿåï¼‰ */
  expiresAt: number

  /** çŠ¶æ€ */
  status: 'pending' | 'confirmed' | 'cancelled' | 'expired'
}

/**
 * å•ä¸ªå˜æ›´é¡¹
 */
export interface ModificationChange {
  /** å˜æ›´ç±»å‹ */
  type: 'add' | 'remove' | 'modify' | 'reorder'

  /** å¤©æ•°ç´¢å¼• */
  dayIndex: number

  /** é¡¹ç›®ç±»å‹ */
  itemType: 'attraction' | 'meal' | 'hotel' | 'transport'

  /** é¡¹ç›®åç§° */
  itemName: string

  /** å˜æ›´æè¿° */
  description: string

  /** å˜æ›´å‰çš„å€¼ï¼ˆå¯é€‰ï¼‰ */
  before?: unknown

  /** å˜æ›´åçš„å€¼ï¼ˆå¯é€‰ï¼‰ */
  after?: unknown
}

/**
 * å¤©è®¡åˆ’æ‘˜è¦ï¼ˆç”¨äºé¢„è§ˆæ˜¾ç¤ºï¼‰
 */
export interface DayPlanSummary {
  day: number
  date: string
  activities: Array<{
    time: string
    name: string
    type: string
    /** æ˜¯å¦æœ‰å˜æ›´ */
    isChanged?: boolean
    /** å˜æ›´ç±»å‹ */
    changeType?: 'added' | 'removed' | 'modified'
  }>
}
```

### 5.3 å·¥å…·å‚æ•°ç±»å‹

```typescript
/**
 * prepare_itinerary_modification å·¥å…·å‚æ•°
 */
export interface PrepareItineraryModificationParams {
  /** è¡Œç¨‹ ID */
  trip_id: string

  /** æ“ä½œç±»å‹ */
  operation: ItineraryModificationOperation

  /** æ“ä½œå‚æ•° */
  params: {
    // ç›®æ ‡å®šä½
    day_index?: number
    activity_index?: number

    // æ–°å¢é¡¹æ•°æ®
    attraction?: {
      name: string
      location?: string
      duration?: string
      preferred_time?: string
      description?: string
    }

    // é‡æ’åºå‚æ•°
    from_day?: number
    from_index?: number
    to_day?: number
    to_index?: number

    // æ—¶é—´ä¿®æ”¹
    new_time?: string

    // é‡ç”Ÿæˆé€‰é¡¹
    regeneration_hints?: {
      keep_attractions?: string[]    // ä¿ç•™çš„æ™¯ç‚¹
      exclude_attractions?: string[] // æ’é™¤çš„æ™¯ç‚¹
      preferences?: string[]         // æ–°å¢åå¥½
      budget_adjustment?: number     // é¢„ç®—è°ƒæ•´
    }

    // å¤šå¤©æ“ä½œèŒƒå›´
    day_range?: {
      start_day: number
      end_day: number
    }
  }

  /** ä¿®æ”¹åŸå› ï¼ˆAI ä¸Šä¸‹æ–‡ï¼‰ */
  reason?: string
}

/**
 * confirm_itinerary_modification å·¥å…·å‚æ•°
 */
export interface ConfirmItineraryModificationParams {
  /** ä¿®æ”¹é¢„è§ˆ ID */
  modification_id: string

  /** ç”¨æˆ·è°ƒæ•´ï¼ˆå¯é€‰ï¼‰ */
  user_adjustments?: {
    // å…è®¸åœ¨ç¡®è®¤æ—¶å¾®è°ƒ
    time_adjustments?: Array<{
      day_index: number
      activity_index: number
      new_time: string
    }>
  }
}
```

---

## å…­ã€æ–‡ä»¶å˜æ›´æ¸…å•

### 6.1 æ–°å¢æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | è¯´æ˜ | é¢„ä¼°è¡Œæ•° |
|---------|------|---------|
| `lib/stores/modification-store.ts` | ä¿®æ”¹çŠ¶æ€ç®¡ç† (Zustand) | 80 |
| `lib/chat/modification-workflow.ts` | æ™ºèƒ½é‡è§„åˆ’å·¥ä½œæµï¼ˆè°ƒç”¨ LangGraphï¼‰ | 200 |
| `lib/chat/modification-cache.ts` | Pending ä¿®æ”¹ç¼“å­˜ç®¡ç† | 60 |
| `components/chat/ModificationPreviewCard.tsx` | ä¿®æ”¹é¢„è§ˆå¡ç‰‡ç»„ä»¶ | 150 |
| `components/chat/ModificationDiffView.tsx` | å‰åå¯¹æ¯”è§†å›¾ç»„ä»¶ | 120 |
| `components/chat/ModificationImpactSummary.tsx` | å½±å“è¯„ä¼°ç»„ä»¶ | 60 |
| `components/chat/TripChatPanel.tsx` | è¡Œç¨‹è¯¦æƒ…é¡µå¯¹è¯ä¾§è¾¹æ  | 200 |
| `app/api/trips/[id]/modifications/route.ts` | ä¿®æ”¹é¢„è§ˆ APIï¼ˆå¯é€‰ï¼Œç”¨äº REST è°ƒç”¨ï¼‰ | 100 |

### 6.2 ä¿®æ”¹æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | ä¿®æ”¹å†…å®¹ | é¢„ä¼°æ”¹åŠ¨ |
|---------|---------|---------|
| `lib/chat/tools.ts` | æ·»åŠ  `prepare_itinerary_modification` å’Œ `confirm_itinerary_modification` å·¥å…·å®šä¹‰ | +100 è¡Œ |
| `lib/chat/executor.ts` | å®ç° `prepareItineraryModification()` å’Œ `confirmItineraryModification()` æ–¹æ³• | +250 è¡Œ |
| `lib/chat/types.ts` | æ·»åŠ  `ModificationPreview`, `ModificationChange` ç­‰ç±»å‹å®šä¹‰ | +80 è¡Œ |
| `hooks/useChatAgent.ts` | æ‰©å±•æ”¯æŒä¿®æ”¹é¢„è§ˆçŠ¶æ€ç®¡ç† | +60 è¡Œ |
| `components/chat/MessageList.tsx` | æ”¯æŒæ¸²æŸ“ ModificationPreviewCard | +30 è¡Œ |
| `components/chat/ToolCallCard.tsx` | æ·»åŠ æ–°å·¥å…·çš„å›¾æ ‡å’Œæè¿° | +10 è¡Œ |
| `components/chat/index.ts` | å¯¼å‡ºæ–°ç»„ä»¶ | +5 è¡Œ |
| `app/dashboard/trips/[id]/page.tsx` | æ·»åŠ å¯¹è¯ä¾§è¾¹æ å…¥å£å’ŒçŠ¶æ€ | +50 è¡Œ |

---

## ä¸ƒã€å®ç°é˜¶æ®µ

### Phase 1: åŸºç¡€ä¿®æ”¹ + é¢„è§ˆç¡®è®¤ âœ…

**ç›®æ ‡**: å®ç°åŸºç¡€ä¿®æ”¹æ“ä½œçš„é¢„è§ˆç¡®è®¤æµç¨‹

**é¢„è®¡å·¥ä½œé‡**: 3-4 å¤©

**å®é™…å®Œæˆæ—¥æœŸ**: 2025-12-09

#### 1.1 ç±»å‹å®šä¹‰ (`lib/chat/types.ts`) âœ…

- [x] æ·»åŠ  `ItineraryModificationOperation` æšä¸¾
- [x] æ·»åŠ  `ModificationPreview` æ¥å£
- [x] æ·»åŠ  `ModificationChange` æ¥å£
- [x] æ·»åŠ  `DayPlanSummary` æ¥å£
- [x] æ·»åŠ  `PrepareItineraryModificationParams` æ¥å£
- [x] æ·»åŠ  `ConfirmItineraryModificationParams` æ¥å£

#### 1.2 å·¥å…·å®šä¹‰ (`lib/chat/tools.ts`) âœ…

- [x] æ·»åŠ  `prepare_itinerary_modification` å·¥å…·å®šä¹‰
- [x] æ·»åŠ  `confirm_itinerary_modification` å·¥å…·å®šä¹‰
- [x] æ›´æ–° `TOOL_DESCRIPTIONS` å’Œ `TOOL_ICONS`

#### 1.3 ç¼“å­˜ç®¡ç† (`lib/chat/modification-cache.ts`) âœ…

- [x] å®ç°å†…å­˜ç¼“å­˜ï¼ˆMapï¼‰
- [x] 10 åˆ†é’Ÿè¿‡æœŸæœºåˆ¶
- [x] `set()`, `get()`, `delete()` æ–¹æ³•

#### 1.4 æ‰§è¡Œå™¨å®ç° (`lib/chat/executor.ts`) âœ…

- [x] å®ç° `prepareItineraryModification()` æ–¹æ³•
  - åŠ è½½è¡Œç¨‹
  - è®¡ç®—ä¿®æ”¹åçš„è¡Œç¨‹
  - ç”Ÿæˆ before/after å¯¹æ¯”
  - ç”Ÿæˆå˜æ›´åˆ—è¡¨
  - è®¡ç®—å½±å“è¯„ä¼°
  - ç¼“å­˜ pending ä¿®æ”¹
  - è¿”å›é¢„è§ˆæ•°æ®
- [x] å®ç° `confirmItineraryModification()` æ–¹æ³•
  - ä»ç¼“å­˜è·å– pending ä¿®æ”¹
  - åº”ç”¨åˆ°æ•°æ®åº“
  - æ¸…é™¤ç¼“å­˜
  - è¿”å›æ›´æ–°ç»“æœ

#### 1.5 çŠ¶æ€ç®¡ç† (`lib/stores/modification-store.ts`) âœ…

- [x] åˆ›å»º Zustand store
- [x] `pendingModification` çŠ¶æ€
- [x] `setPendingModification()` æ–¹æ³•
- [x] `confirmModification()` æ–¹æ³•
- [x] `cancelModification()` æ–¹æ³•

#### 1.6 é¢„è§ˆç»„ä»¶ (`components/chat/ModificationPreviewCard.tsx`) âœ…

- [x] æ“ä½œç±»å‹æ ‡é¢˜å’Œå›¾æ ‡
- [x] å˜æ›´æ‘˜è¦åˆ—è¡¨
- [x] å½±å“è¯„ä¼°æ˜¾ç¤º
- [x] ç¡®è®¤/å–æ¶ˆæŒ‰é’®
- [x] å¤„ç†ä¸­çŠ¶æ€
- [x] è¯¦æƒ…å¯¹æ¯”è§†å›¾ï¼ˆå¯å±•å¼€ï¼‰

#### 1.7 æ¶ˆæ¯åˆ—è¡¨é›†æˆ (`components/chat/MessageList.tsx`) âœ…

- [x] è¯†åˆ« `modification_preview` ç±»å‹å·¥å…·ç»“æœ
- [x] æ¸²æŸ“ ModificationPreviewCard

#### 1.8 Hook æ‰©å±• (`hooks/useChatAgent.ts`) âœ…

- [x] å¤„ç† `prepare_itinerary_modification` å·¥å…·ç»“æœ
- [x] æ›´æ–° modification store
- [x] å®ç°ç¡®è®¤/å–æ¶ˆå›è°ƒ
- [x] å¤„ç†ç¡®è®¤åçš„è¡Œç¨‹åˆ·æ–°

### Phase 2: å‰åå¯¹æ¯” + è¯¦æƒ…ç¼–è¾‘ âœ…

**ç›®æ ‡**: å¢å¼ºé¢„è§ˆä½“éªŒï¼Œæ”¯æŒæŸ¥çœ‹è¯¦ç»†å¯¹æ¯”å’Œå¾®è°ƒ

**é¢„è®¡å·¥ä½œé‡**: 2-3 å¤©

**å®é™…å®Œæˆæ—¥æœŸ**: 2025-12-09

#### 2.1 å¯¹æ¯”è§†å›¾ç»„ä»¶ (`components/chat/ModificationDiffView.tsx`) âœ…

- [x] å·¦å³å¯¹æ¯”å¸ƒå±€
- [x] å˜æ›´é¡¹é«˜äº®
- [x] æ—¶é—´çº¿å¯¹æ¯”
- [x] æˆæœ¬å¯¹æ¯”

#### 2.2 å½±å“è¯„ä¼°ç»„ä»¶ (`components/chat/ModificationImpactSummary.tsx`) âœ…

- [x] æˆæœ¬å˜åŒ–æ˜¾ç¤º
- [x] æ—¶é—´å½±å“æ˜¾ç¤º
- [x] è­¦å‘Šä¿¡æ¯æ˜¾ç¤º
- [x] å—å½±å“å¤©æ•°æ ‡è®°

#### 2.3 é¢„è§ˆå¾®è°ƒåŠŸèƒ½ âœ…

- [x] åœ¨é¢„è§ˆä¸­ä¿®æ”¹æ—¶é—´
- [ ] åœ¨é¢„è§ˆä¸­è°ƒæ•´é¡ºåºï¼ˆPhase 3 å®ç°ï¼‰
- [ ] åœ¨é¢„è§ˆä¸­ç¼–è¾‘æ–°å¢é¡¹è¯¦æƒ…ï¼ˆPhase 3 å®ç°ï¼‰
- [x] æ›´æ–° `confirm_itinerary_modification` æ”¯æŒ `user_adjustments`

### Phase 3: æ™ºèƒ½é‡è§„åˆ’ âœ…

**ç›®æ ‡**: å®ç° AI é©±åŠ¨çš„æ™ºèƒ½ä¼˜åŒ–åŠŸèƒ½

**é¢„è®¡å·¥ä½œé‡**: 4-5 å¤©

**å®é™…å®Œæˆæ—¥æœŸ**: 2025-12-10

#### 3.1 é‡è§„åˆ’å·¥ä½œæµ (`lib/chat/modification-workflow.ts`) âœ…

- [x] å®ç° `optimizeRoute()` - è·¯çº¿ä¼˜åŒ–ç®—æ³•
  - åŸºäºåœ°ç†ä½ç½®çš„æœ€è¿‘é‚»è´ªå¿ƒç®—æ³•
  - è€ƒè™‘äº¤é€šæ—¶é—´å’Œè·ç¦»
  - è‡ªåŠ¨é‡æ–°åˆ†é…æ—¶é—´
- [x] å®ç° `replanDay()` - è°ƒç”¨ AI é‡æ–°è§„åˆ’
  - å¤ç”¨ DeepSeek API
  - æ”¯æŒä¿ç•™/æ’é™¤æ™¯ç‚¹çº¦æŸ
  - æ”¯æŒåå¥½å’Œé¢„ç®—è°ƒæ•´
- [x] å®ç° `adjustForWeather()` - å¤©æ°”é€‚åº”
  - è·å–é«˜å¾·å¤©æ°”é¢„æŠ¥
  - è‡ªåŠ¨è¯†åˆ«æˆ·å¤–æ™¯ç‚¹
  - AI æ¨èå®¤å†…æ›¿ä»£æ™¯ç‚¹

#### 3.2 æ‰§è¡Œå™¨é›†æˆ (`lib/chat/executor.ts`) âœ…

- [x] é›†æˆ `optimize_route` æ“ä½œ
- [x] é›†æˆ `replan_day` æ“ä½œ
- [x] é›†æˆ `adjust_for_weather` æ“ä½œ
- [x] é”™è¯¯å¤„ç†å’Œå‹å¥½æç¤º

#### 3.3 æ¨¡å—å¯¼å‡º (`lib/chat/index.ts`) âœ…

- [x] å¯¼å‡ºå·¥ä½œæµå‡½æ•°
- [x] å¯¼å‡ºç±»å‹å®šä¹‰

### Phase 4: è¡Œç¨‹è¯¦æƒ…é¡µé›†æˆ âœ…

**ç›®æ ‡**: åœ¨è¡Œç¨‹è¯¦æƒ…é¡µæ·»åŠ å¯¹è¯å…¥å£

**é¢„è®¡å·¥ä½œé‡**: 2-3 å¤©

**å®é™…å®Œæˆæ—¥æœŸ**: 2025-12-10

#### 4.1 å¯¹è¯ä¾§è¾¹æ  (`components/chat/TripChatPanel.tsx`) âœ…

- [x] æ»‘å‡ºå¼é¢æ¿ç»„ä»¶
- [x] å…³è”å½“å‰è¡Œç¨‹ä¸Šä¸‹æ–‡
- [x] æ¶ˆæ¯åˆ—è¡¨
- [x] è¾“å…¥æ¡†

#### 4.2 è¡Œç¨‹è¯¦æƒ…é¡µä¿®æ”¹ (`app/dashboard/trips/[id]/page.tsx`) âœ…

- [x] æ·»åŠ "AI ä¿®æ”¹"æŒ‰é’®å’Œæ‚¬æµ®æŒ‰é’®
- [x] é›†æˆ TripChatPanel
- [x] çŠ¶æ€ç®¡ç†ï¼ˆé¢æ¿å¼€å…³ï¼‰
- [x] ä¿®æ”¹åè‡ªåŠ¨åˆ·æ–°è¡Œç¨‹æ˜¾ç¤º

#### 4.3 å®æ—¶åŒæ­¥ âœ…

- [x] ç›‘å¬ä¿®æ”¹ç¡®è®¤äº‹ä»¶ï¼ˆé€šè¿‡ lastConfirmedModification çŠ¶æ€ï¼‰
- [x] åˆ·æ–°è¡Œç¨‹æ•°æ®ï¼ˆè°ƒç”¨ refetchï¼‰
- [x] æ»šåŠ¨åˆ°ä¿®æ”¹çš„å¤©æ•°ï¼ˆscrollIntoViewï¼‰
- [x] é«˜äº®æ–°ä¿®æ”¹çš„å†…å®¹ï¼ˆ3ç§’åè‡ªåŠ¨æ¸…é™¤ï¼‰

---

## å…«ã€å…³é”®ä»£ç è®¾è®¡

### 8.1 å·¥å…·å®šä¹‰

```typescript
// lib/chat/tools.ts

// prepare_itinerary_modification å·¥å…·
{
  type: 'function',
  function: {
    name: 'prepare_itinerary_modification',
    description: `å‡†å¤‡è¡Œç¨‹ä¿®æ”¹é¢„è§ˆã€‚åˆ†æä¿®æ”¹å½±å“ï¼Œç”Ÿæˆå‰åå¯¹æ¯”ï¼Œç­‰å¾…ç”¨æˆ·ç¡®è®¤åæ‰ä¿å­˜ã€‚

æ”¯æŒçš„æ“ä½œç±»å‹ï¼š
- åŸºç¡€ä¿®æ”¹ï¼šadd_attraction, remove_attraction, reorder, change_time, change_hotel, change_restaurant
- ç»“æ„å˜æ›´ï¼šadd_day, remove_day, split_day, merge_days
- æ™ºèƒ½é‡è§„åˆ’ï¼šoptimize_route, replan_day, adjust_for_weather
- é‡ç”Ÿæˆï¼šregenerate_day, regenerate_trip_segment

ä½¿ç”¨åœºæ™¯ï¼š
- ç”¨æˆ·è¯´"åˆ é™¤ç¬¬äºŒå¤©çš„è¥¿æ¹–" â†’ operation: remove_attraction
- ç”¨æˆ·è¯´"æŠŠçµéšå¯ºç§»åˆ°ä¸Šåˆ" â†’ operation: change_time
- ç”¨æˆ·è¯´"å¸®æˆ‘ä¼˜åŒ–ä¸€ä¸‹è·¯çº¿" â†’ operation: optimize_route
- ç”¨æˆ·è¯´"åšç‰©é¦†é—­é¦†äº†é‡æ–°è§„åˆ’" â†’ operation: replan_day

æ³¨æ„ï¼šæ­¤å·¥å…·åªç”Ÿæˆé¢„è§ˆï¼Œä¸ä¼šç«‹å³ä¿å­˜ã€‚ç”¨æˆ·éœ€è¦ç¡®è®¤åæ‰ä¼šæ‰§è¡Œä¿®æ”¹ã€‚`,
    parameters: {
      type: 'object',
      properties: {
        trip_id: {
          type: 'string',
          description: 'è¦ä¿®æ”¹çš„è¡Œç¨‹ ID',
        },
        operation: {
          type: 'string',
          enum: [
            'add_attraction', 'remove_attraction', 'reorder', 'change_time',
            'change_hotel', 'change_restaurant',
            'add_day', 'remove_day', 'split_day', 'merge_days',
            'optimize_route', 'replan_day', 'adjust_for_weather',
            'regenerate_day', 'regenerate_trip_segment',
          ],
          description: 'æ“ä½œç±»å‹',
        },
        params: {
          type: 'object',
          description: 'æ“ä½œå‚æ•°',
          properties: {
            day_index: { type: 'number', description: 'å¤©æ•°ç´¢å¼•ï¼ˆä» 0 å¼€å§‹ï¼‰' },
            activity_index: { type: 'number', description: 'æ´»åŠ¨ç´¢å¼•' },
            attraction: {
              type: 'object',
              description: 'æ–°å¢æ™¯ç‚¹ä¿¡æ¯',
              properties: {
                name: { type: 'string' },
                location: { type: 'string' },
                duration: { type: 'string' },
                preferred_time: { type: 'string' },
              },
            },
            new_time: { type: 'string', description: 'æ–°æ—¶é—´ï¼Œå¦‚ "09:00"' },
            from_day: { type: 'number' },
            from_index: { type: 'number' },
            to_day: { type: 'number' },
            to_index: { type: 'number' },
            regeneration_hints: {
              type: 'object',
              properties: {
                keep_attractions: { type: 'array', items: { type: 'string' } },
                exclude_attractions: { type: 'array', items: { type: 'string' } },
                preferences: { type: 'array', items: { type: 'string' } },
              },
            },
            day_range: {
              type: 'object',
              properties: {
                start_day: { type: 'number' },
                end_day: { type: 'number' },
              },
            },
          },
        },
        reason: {
          type: 'string',
          description: 'ç”¨æˆ·è¯´æ˜çš„ä¿®æ”¹åŸå› ï¼ˆç”¨äº AI ä¸Šä¸‹æ–‡ç†è§£ï¼‰',
        },
      },
      required: ['trip_id', 'operation', 'params'],
    },
  },
},

// confirm_itinerary_modification å·¥å…·
{
  type: 'function',
  function: {
    name: 'confirm_itinerary_modification',
    description: `ç¡®è®¤å¹¶åº”ç”¨è¡Œç¨‹ä¿®æ”¹ã€‚

ä»…åœ¨ä»¥ä¸‹æƒ…å†µè°ƒç”¨ï¼š
1. ç”¨æˆ·æ˜ç¡®ç¡®è®¤è¦æ‰§è¡Œä¿®æ”¹
2. ç”¨æˆ·ç‚¹å‡»äº†"ç¡®è®¤ä¿®æ”¹"æŒ‰é’®

æ­¤å·¥å…·ä¼šå°† prepare_itinerary_modification ç”Ÿæˆçš„é¢„è§ˆä¿®æ”¹ä¿å­˜åˆ°æ•°æ®åº“ã€‚`,
    parameters: {
      type: 'object',
      properties: {
        modification_id: {
          type: 'string',
          description: 'ä¿®æ”¹é¢„è§ˆ IDï¼ˆç”± prepare_itinerary_modification è¿”å›ï¼‰',
        },
        user_adjustments: {
          type: 'object',
          description: 'ç”¨æˆ·åœ¨ç¡®è®¤å‰çš„å¾®è°ƒï¼ˆå¯é€‰ï¼‰',
          properties: {
            time_adjustments: {
              type: 'array',
              items: {
                type: 'object',
                properties: {
                  day_index: { type: 'number' },
                  activity_index: { type: 'number' },
                  new_time: { type: 'string' },
                },
              },
            },
          },
        },
      },
      required: ['modification_id'],
    },
  },
},
```

### 8.2 æ‰§è¡Œå™¨æ ¸å¿ƒæ–¹æ³•

```typescript
// lib/chat/executor.ts

/**
 * å‡†å¤‡è¡Œç¨‹ä¿®æ”¹é¢„è§ˆ
 */
private async prepareItineraryModification(
  params: PrepareItineraryModificationParams
): Promise<ModificationPreview | { success: false; message: string }> {
  const { trip_id, operation, params: opParams, reason } = params

  // 1. åŠ è½½å½“å‰è¡Œç¨‹
  const { data: trip, error } = await this.supabase
    .from('trips')
    .select('*')
    .eq('id', trip_id)
    .eq('user_id', this.userId)
    .single()

  if (error || !trip) {
    return { success: false, message: 'è¡Œç¨‹ä¸å­˜åœ¨æˆ–æ— æƒè®¿é—®' }
  }

  // 2. æ·±æ‹·è´è¡Œç¨‹ä½œä¸ºå·¥ä½œå‰¯æœ¬
  const beforeItinerary = JSON.parse(JSON.stringify(trip.itinerary))
  const afterItinerary = JSON.parse(JSON.stringify(trip.itinerary))

  // 3. æ ¹æ®æ“ä½œç±»å‹è®¡ç®—ä¿®æ”¹
  const changes: ModificationChange[] = []
  let modified = false

  switch (operation) {
    case 'remove_attraction':
      // å®ç°åˆ é™¤é€»è¾‘ï¼Œè®°å½• change
      break
    case 'add_attraction':
      // å®ç°æ·»åŠ é€»è¾‘
      break
    case 'reorder':
      // å®ç°é‡æ’åºé€»è¾‘
      break
    case 'optimize_route':
      // è°ƒç”¨è·¯çº¿ä¼˜åŒ–ç®—æ³•
      break
    case 'replan_day':
      // è°ƒç”¨ AI é‡è§„åˆ’
      break
    // ... å…¶ä»–æ“ä½œ
  }

  // 4. ç”Ÿæˆé¢„è§ˆæ‘˜è¦
  const beforeSummary = this.generateDaySummary(beforeItinerary, changes)
  const afterSummary = this.generateDaySummary(afterItinerary, changes)

  // 5. è®¡ç®—å½±å“è¯„ä¼°
  const impact = this.calculateImpact(beforeItinerary, afterItinerary, changes)

  // 6. åˆ›å»ºé¢„è§ˆå¯¹è±¡
  const preview: ModificationPreview = {
    id: `mod_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
    tripId: trip_id,
    operation,
    before: {
      days: beforeSummary,
      totalCost: this.calculateTotalCost(beforeItinerary),
    },
    after: {
      days: afterSummary,
      totalCost: this.calculateTotalCost(afterItinerary),
    },
    changes,
    impact,
    createdAt: Date.now(),
    expiresAt: Date.now() + 10 * 60 * 1000, // 10 åˆ†é’Ÿåè¿‡æœŸ
    status: 'pending',
  }

  // 7. ç¼“å­˜ pending ä¿®æ”¹ï¼ˆåŒ…å«å®Œæ•´çš„ afterItineraryï¼‰
  modificationCache.set(preview.id, {
    preview,
    afterItinerary,
  })

  return preview
}

/**
 * ç¡®è®¤å¹¶åº”ç”¨ä¿®æ”¹
 */
private async confirmItineraryModification(
  params: ConfirmItineraryModificationParams
): Promise<{ success: boolean; message: string; itinerary?: Itinerary }> {
  const { modification_id, user_adjustments } = params

  // 1. ä»ç¼“å­˜è·å– pending ä¿®æ”¹
  const cached = modificationCache.get(modification_id)
  if (!cached) {
    return { success: false, message: 'ä¿®æ”¹é¢„è§ˆå·²è¿‡æœŸæˆ–ä¸å­˜åœ¨ï¼Œè¯·é‡æ–°å‘èµ·ä¿®æ”¹' }
  }

  let { afterItinerary } = cached

  // 2. åº”ç”¨ç”¨æˆ·å¾®è°ƒï¼ˆå¦‚æœæœ‰ï¼‰
  if (user_adjustments?.time_adjustments) {
    for (const adj of user_adjustments.time_adjustments) {
      afterItinerary.days[adj.day_index].activities[adj.activity_index].time = adj.new_time
    }
  }

  // 3. ä¿å­˜åˆ°æ•°æ®åº“
  const { error } = await this.supabase
    .from('trips')
    .update({
      itinerary: afterItinerary,
      updated_at: new Date().toISOString(),
    })
    .eq('id', cached.preview.tripId)

  if (error) {
    return { success: false, message: 'ä¿å­˜å¤±è´¥: ' + error.message }
  }

  // 4. æ¸…é™¤ç¼“å­˜
  modificationCache.delete(modification_id)

  return {
    success: true,
    message: 'è¡Œç¨‹ä¿®æ”¹å·²ä¿å­˜',
    itinerary: afterItinerary,
  }
}
```

### 8.3 çŠ¶æ€ç®¡ç†

```typescript
// lib/stores/modification-store.ts

import { create } from 'zustand'
import type { ModificationPreview } from '@/lib/chat/types'

interface ModificationState {
  /** å½“å‰å¾…ç¡®è®¤çš„ä¿®æ”¹é¢„è§ˆ */
  pendingModification: ModificationPreview | null

  /** æ˜¯å¦æ­£åœ¨å¤„ç† */
  isProcessing: boolean

  /** è®¾ç½®å¾…ç¡®è®¤ä¿®æ”¹ */
  setPendingModification: (preview: ModificationPreview | null) => void

  /** ç¡®è®¤ä¿®æ”¹ */
  confirmModification: (modificationId: string, userAdjustments?: any) => Promise<boolean>

  /** å–æ¶ˆä¿®æ”¹ */
  cancelModification: () => void

  /** è®¾ç½®å¤„ç†çŠ¶æ€ */
  setProcessing: (processing: boolean) => void
}

export const useModificationStore = create<ModificationState>((set, get) => ({
  pendingModification: null,
  isProcessing: false,

  setPendingModification: (preview) => set({ pendingModification: preview }),

  confirmModification: async (modificationId, userAdjustments) => {
    set({ isProcessing: true })
    try {
      // è¿™é‡Œå®é™…ä¼šé€šè¿‡å¯¹è¯å‘é€ç¡®è®¤å·¥å…·è°ƒç”¨
      // æˆ–è€…ç›´æ¥è°ƒç”¨ API
      return true
    } finally {
      set({ isProcessing: false, pendingModification: null })
    }
  },

  cancelModification: () => set({ pendingModification: null }),

  setProcessing: (processing) => set({ isProcessing: processing }),
}))
```

### 8.4 é¢„è§ˆç»„ä»¶

```tsx
// components/chat/ModificationPreviewCard.tsx

import type { ModificationPreview } from '@/lib/chat/types'

const OPERATION_LABELS: Record<string, string> = {
  add_attraction: 'æ·»åŠ æ™¯ç‚¹',
  remove_attraction: 'åˆ é™¤æ™¯ç‚¹',
  reorder: 'è°ƒæ•´é¡ºåº',
  change_time: 'ä¿®æ”¹æ—¶é—´',
  optimize_route: 'ä¼˜åŒ–è·¯çº¿',
  replan_day: 'é‡æ–°è§„åˆ’',
  // ...
}

const OPERATION_ICONS: Record<string, string> = {
  add_attraction: 'â•',
  remove_attraction: 'âŒ',
  reorder: 'ğŸ”„',
  change_time: 'â°',
  optimize_route: 'ğŸ—ºï¸',
  replan_day: 'âœ¨',
  // ...
}

interface ModificationPreviewCardProps {
  preview: ModificationPreview
  onConfirm: () => void
  onCancel: () => void
  onViewDetails: () => void
  isProcessing?: boolean
}

export function ModificationPreviewCard({
  preview,
  onConfirm,
  onCancel,
  onViewDetails,
  isProcessing,
}: ModificationPreviewCardProps) {
  return (
    <div className="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 overflow-hidden">
      {/* å¤´éƒ¨ */}
      <div className="px-4 py-3 bg-blue-50 dark:bg-blue-900/20 border-b border-gray-200 dark:border-gray-700">
        <div className="flex items-center gap-2">
          <span className="text-xl">{OPERATION_ICONS[preview.operation] || 'âœï¸'}</span>
          <h3 className="font-medium text-gray-900 dark:text-white">è¡Œç¨‹ä¿®æ”¹é¢„è§ˆ</h3>
          <span className="px-2 py-0.5 text-xs bg-blue-100 dark:bg-blue-800 text-blue-800 dark:text-blue-100 rounded">
            {OPERATION_LABELS[preview.operation] || preview.operation}
          </span>
        </div>
      </div>

      {/* å˜æ›´æ‘˜è¦ */}
      <div className="p-4">
        <h4 className="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ğŸ“ å˜æ›´æ‘˜è¦</h4>
        <ul className="space-y-1">
          {preview.changes.map((change, idx) => (
            <li key={idx} className="flex items-center gap-2 text-sm">
              <span>{change.type === 'add' ? 'â•' : change.type === 'remove' ? 'âŒ' : 'ğŸ“'}</span>
              <span className="text-gray-600 dark:text-gray-400">{change.description}</span>
            </li>
          ))}
        </ul>
      </div>

      {/* å½±å“è¯„ä¼° */}
      <div className="px-4 pb-4">
        <h4 className="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ğŸ“Š å½±å“è¯„ä¼°</h4>
        <div className="grid grid-cols-2 gap-2 text-sm">
          <div>
            <span className="text-gray-500">å—å½±å“å¤©æ•°ï¼š</span>
            <span>ç¬¬ {preview.impact.affectedDays.map(d => d + 1).join(', ')} å¤©</span>
          </div>
          <div>
            <span className="text-gray-500">é¢„ç®—å˜åŒ–ï¼š</span>
            <span className={preview.impact.costDelta > 0 ? 'text-red-500' : 'text-green-500'}>
              {preview.impact.costDelta > 0 ? '+' : ''}Â¥{preview.impact.costDelta}
            </span>
          </div>
        </div>

        {/* è­¦å‘Šä¿¡æ¯ */}
        {preview.impact.warnings.length > 0 && (
          <div className="mt-2 text-sm text-yellow-600 dark:text-yellow-400">
            {preview.impact.warnings.map((w, i) => (
              <p key={i}>âš ï¸ {w}</p>
            ))}
          </div>
        )}
      </div>

      {/* æ“ä½œæŒ‰é’® */}
      <div className="px-4 py-3 bg-gray-50 dark:bg-gray-900/50 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-2">
        <button
          onClick={onCancel}
          disabled={isProcessing}
          className="px-3 py-1.5 text-sm text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800 rounded"
        >
          å–æ¶ˆ
        </button>
        <button
          onClick={onViewDetails}
          disabled={isProcessing}
          className="px-3 py-1.5 text-sm text-blue-600 dark:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/50 rounded"
        >
          æŸ¥çœ‹è¯¦æƒ…
        </button>
        <button
          onClick={onConfirm}
          disabled={isProcessing}
          className="px-3 py-1.5 text-sm bg-blue-600 text-white hover:bg-blue-700 rounded disabled:opacity-50"
        >
          {isProcessing ? 'å¤„ç†ä¸­...' : 'ç¡®è®¤ä¿®æ”¹'}
        </button>
      </div>
    </div>
  )
}
```

---

## ä¹ã€éªŒæ”¶æ ‡å‡†

### 9.1 åŠŸèƒ½éªŒæ”¶

**Phase 1 éªŒæ”¶**:
- [ ] ç”¨æˆ·å¯ä»¥é€šè¿‡å¯¹è¯æè¿°ä¿®æ”¹éœ€æ±‚ï¼ˆåˆ é™¤æ™¯ç‚¹ã€æ·»åŠ æ™¯ç‚¹ç­‰ï¼‰
- [ ] AI æ­£ç¡®è¯†åˆ«ä¿®æ”¹æ„å›¾å¹¶è°ƒç”¨ `prepare_itinerary_modification`
- [ ] æ˜¾ç¤ºä¿®æ”¹é¢„è§ˆå¡ç‰‡ï¼ŒåŒ…å«å˜æ›´æ‘˜è¦å’Œå½±å“è¯„ä¼°
- [ ] ç”¨æˆ·ç‚¹å‡»"ç¡®è®¤"åä¿®æ”¹ä¿å­˜åˆ°æ•°æ®åº“
- [ ] ç”¨æˆ·ç‚¹å‡»"å–æ¶ˆ"åä¿®æ”¹è¢«ä¸¢å¼ƒ
- [ ] é¢„è§ˆ 10 åˆ†é’Ÿåè‡ªåŠ¨è¿‡æœŸ

**Phase 2 éªŒæ”¶**:
- [ ] ç‚¹å‡»"æŸ¥çœ‹è¯¦æƒ…"æ˜¾ç¤ºå‰åå¯¹æ¯”è§†å›¾
- [ ] å¯¹æ¯”è§†å›¾æ­£ç¡®é«˜äº®å˜æ›´é¡¹
- [ ] å¯ä»¥åœ¨é¢„è§ˆä¸­å¾®è°ƒæ—¶é—´

**Phase 3 éªŒæ”¶**:
- [ ] `optimize_route` æ“ä½œæ­£ç¡®ä¼˜åŒ–è·¯çº¿é¡ºåº
- [ ] `replan_day` æ“ä½œè°ƒç”¨ AI é‡æ–°è§„åˆ’
- [ ] é‡è§„åˆ’è¿‡ç¨‹æ˜¾ç¤ºè¿›åº¦

**Phase 4 éªŒæ”¶**:
- [x] è¡Œç¨‹è¯¦æƒ…é¡µæœ‰"AI ä¿®æ”¹"å…¥å£å’Œæ‚¬æµ®æŒ‰é’®
- [x] å¯¹è¯ä¾§è¾¹æ æ­£å¸¸æ˜¾ç¤º
- [x] ä¿®æ”¹ç¡®è®¤åè¡Œç¨‹è¯¦æƒ…é¡µè‡ªåŠ¨åˆ·æ–°
- [x] åˆ·æ–°åæ»šåŠ¨åˆ°ä¿®æ”¹çš„å¤©æ•°
- [x] ä¿®æ”¹çš„å¤©æ•°å¡ç‰‡é«˜äº®æ˜¾ç¤ºï¼ˆ3ç§’åè‡ªåŠ¨æ¶ˆå¤±ï¼‰

### 9.2 è¾¹ç•Œæƒ…å†µæµ‹è¯•

- [ ] å¹¶å‘ä¿®æ”¹ï¼šåŒæ—¶ä¿®æ”¹åŒä¸€è¡Œç¨‹çš„å¤„ç†
- [ ] è¿‡æœŸå¤„ç†ï¼šé¢„è§ˆè¿‡æœŸåçš„å‹å¥½æç¤º
- [ ] ç½‘ç»œé”™è¯¯ï¼šä¿å­˜å¤±è´¥åçš„æ¢å¤æœºåˆ¶
- [ ] æ•°æ®å†²çªï¼šè¡Œç¨‹è¢«å…¶ä»–åœ°æ–¹ä¿®æ”¹åçš„å¤„ç†
- [ ] æƒé™éªŒè¯ï¼šç¡®ä¿åªèƒ½ä¿®æ”¹è‡ªå·±çš„è¡Œç¨‹

---

## åã€é£é™©ä¸ç¼“è§£

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|---------|
| é¢„è§ˆè®¡ç®—è€—æ—¶ | ä¸­ | åŸºç¡€æ“ä½œæœ¬åœ°è®¡ç®—ï¼Œå¤æ‚æ“ä½œæ˜¾ç¤ºåŠ è½½çŠ¶æ€ |
| ç¼“å­˜è¿‡æœŸ | ä½ | æ¸…æ™°çš„è¿‡æœŸæç¤ºï¼Œå¼•å¯¼ç”¨æˆ·é‡æ–°å‘èµ· |
| AI é‡è§„åˆ’è´¨é‡ | ä¸­ | å¤ç”¨å·²éªŒè¯çš„ LangGraph Agent |
| çŠ¶æ€åŒæ­¥ | ä¸­ | ç¡®è®¤åç«‹å³åˆ·æ–°ï¼Œä½¿ç”¨ä¹è§‚æ›´æ–° |
| ç§»åŠ¨ç«¯ä½“éªŒ | ä¸­ | ä¾§è¾¹æ æ”¹ä¸ºåº•éƒ¨å¼¹å‡ºé¢æ¿ |

---

## æ›´æ–°æ—¥å¿—

| æ—¥æœŸ | ç‰ˆæœ¬ | æ›´æ–°å†…å®¹ |
|------|------|---------|
| 2025-12-08 | v1.0 | åˆå§‹è®¡åˆ’æ–‡æ¡£ |
| 2025-12-09 | v1.1 | Phase 1 å·²å®Œæˆï¼šå®ç°åŸºç¡€ä¿®æ”¹ + é¢„è§ˆç¡®è®¤æµç¨‹ |
| 2025-12-09 | v1.2 | Phase 2 å·²å®Œæˆï¼šå®ç°å‰åå¯¹æ¯”è§†å›¾ã€å½±å“è¯„ä¼°ç»„ä»¶ã€æ—¶é—´å¾®è°ƒåŠŸèƒ½ |
| 2025-12-10 | v1.3 | Phase 3 å·²å®Œæˆï¼šå®ç°æ™ºèƒ½é‡è§„åˆ’ï¼ˆè·¯çº¿ä¼˜åŒ–ã€AI é‡è§„åˆ’ã€å¤©æ°”é€‚åº”ï¼‰ |
| 2025-12-10 | v1.4 | Phase 4 å·²å®Œæˆï¼šå®ç°è¡Œç¨‹è¯¦æƒ…é¡µé›†æˆï¼ˆä¾§è¾¹æ ã€æ‚¬æµ®æŒ‰é’®ã€è‡ªåŠ¨åˆ·æ–°ã€æ»šåŠ¨é«˜äº®ï¼‰ |
