# ä»£ç æ¸…ç†ä¸­æœŸæ‰§è¡Œè®¡åˆ’

**åˆ›å»ºæ—¥æœŸ**ï¼š2024-12-12
**é¢„è®¡å‘¨æœŸ**ï¼š4-8 å‘¨
**ä¼˜å…ˆçº§**ï¼šä¸­

---

## ä¸€ã€è®¡åˆ’æ¦‚è¿°

æœ¬è®¡åˆ’æ—¨åœ¨é€æ­¥æ¸…ç†é¡¹ç›®ä¸­çš„æŠ€æœ¯å€ºåŠ¡ï¼ŒåŒ…æ‹¬ï¼š
1. å‘åå…¼å®¹å±‚æ–‡ä»¶çš„è¿ç§»å’Œåˆ é™¤
2. æœªå……åˆ†ä½¿ç”¨çš„æœåŠ¡å±‚è¯„ä¼°
3. è¶…å¤§æ–‡ä»¶çš„æ‹†åˆ†ä¼˜åŒ–
4. å¸¸é‡æ¨¡å—æ•´åˆ

---

## äºŒã€å‘åå…¼å®¹å±‚è¿ç§»

### 2.1 ç›®æ ‡æ–‡ä»¶

| æ–‡ä»¶ | å½“å‰å¼•ç”¨æ•° | æ–°æ¨¡å—ä½ç½® | ä¼˜å…ˆçº§ |
|------|-----------|-----------|--------|
| `lib/api-keys.ts` | 42 ä¸ªæ–‡ä»¶ | `lib/api-keys/` | é«˜ |
| `lib/supabase.ts` | 28 ä¸ªæ–‡ä»¶ | `lib/database/` | é«˜ |
| `lib/check-api-keys.ts` | å¤šå¤„ä½¿ç”¨ | `lib/api-keys/checker.ts` | ä¸­ |

### 2.2 è¿ç§»æ­¥éª¤

#### é˜¶æ®µ 1ï¼š`lib/api-keys.ts` è¿ç§»ï¼ˆé¢„è®¡ 2 å‘¨ï¼‰

> âœ… **å·²å®Œæˆ** (2024-12-12): æ‰€æœ‰ä»£ç å·²ä½¿ç”¨æ–°çš„ç±»å¼ APIï¼Œå…¼å®¹å±‚æ–‡ä»¶å·²åˆ é™¤ã€‚

**ç›®æ ‡**ï¼šå°†æ‰€æœ‰ `lib/api-keys.ts` çš„å¯¼å…¥è¿ç§»åˆ° `lib/api-keys/` æ¨¡å—

**æ–° API å¯¹ç…§è¡¨**ï¼š

| æ—§ API | æ–° API |
|--------|--------|
| `getDecryptedApiKey(userId, service, supabase)` | `ApiKeyClient.getUserConfig(userId, service, supabase)` |
| `getSystemApiKey(service)` | `ApiKeyClient.getSystemKey(service)` |
| `testDeepSeekApiKey(apiKey)` | `ApiKeyValidator.testDeepSeekKey(apiKey)` |
| `testModelScopeApiKey(apiKey)` | `ApiKeyValidator.testModelScopeKey(apiKey)` |
| `testAmapApiKey(apiKey)` | `ApiKeyValidator.testAmapKey(apiKey)` |

**è¿ç§»ä»»åŠ¡æ¸…å•**ï¼š

- [ ] **app/api/ ç›®å½•**ï¼ˆ~15 ä¸ªæ–‡ä»¶ï¼‰
  - [ ] `app/api/generate-itinerary/route.ts`
  - [ ] `app/api/v2/generate-itinerary/route.ts`
  - [ ] `app/api/chat/generate-trip/route.ts`
  - [ ] `app/api/chat/route.ts`
  - [ ] `app/api/enrich-attraction/route.ts`
  - [ ] `app/api/enrich-hotel/route.ts`
  - [ ] `app/api/user/api-keys/route.ts`
  - [ ] `app/api/user/api-keys/[id]/route.ts`
  - [ ] `app/api/user/api-keys/test/route.ts`
  - [ ] `app/api/user/api-keys/import/route.ts`
  - [ ] `app/api/user/api-keys/system/route.ts`
  - [ ] `app/api/voice/parse-trip/route.ts`
  - [ ] `app/api/voice/transcribe/route.ts`
  - [ ] å…¶ä»–ç›¸å…³ API è·¯ç”±

- [ ] **components/ ç›®å½•**ï¼ˆ~5 ä¸ªæ–‡ä»¶ï¼‰
  - [ ] `components/settings/ApiKeyManager.tsx`
  - [ ] `components/settings/api-keys/*.tsx`
  - [ ] å…¶ä»–ç›¸å…³ç»„ä»¶

- [ ] **hooks/ ç›®å½•**ï¼ˆ~3 ä¸ªæ–‡ä»¶ï¼‰
  - [ ] `hooks/useApiKeyCheck.ts`
  - [ ] å…¶ä»–ç›¸å…³ hooks

- [ ] **app/dashboard/ ç›®å½•**ï¼ˆ~5 ä¸ªæ–‡ä»¶ï¼‰
  - [ ] `app/dashboard/create/page.tsx`
  - [ ] `app/login/page.tsx`
  - [ ] å…¶ä»–ç›¸å…³é¡µé¢

- [ ] **lib/ å†…éƒ¨å¼•ç”¨**
  - [ ] `lib/api-keys/index.ts`ï¼ˆå†…éƒ¨å¯¼å…¥æ¸…ç†ï¼‰

#### é˜¶æ®µ 2ï¼š`lib/supabase.ts` è¿ç§»ï¼ˆé¢„è®¡ 2 å‘¨ï¼‰

> âœ… **å·²å®Œæˆ** (2024-12-12): æ‰€æœ‰å¯¼å…¥å·²æ›´æ–°ï¼Œ`db` CRUD æ“ä½œå·²è¿ç§»åˆ° `lib/database/crud.ts`ï¼Œå…¼å®¹å±‚æ–‡ä»¶å·²åˆ é™¤ã€‚

**ç›®æ ‡**ï¼šå°†æ‰€æœ‰ `lib/supabase.ts` çš„å¯¼å…¥è¿ç§»åˆ° `lib/database/` æ¨¡å—

**æ–° API å¯¹ç…§è¡¨**ï¼š

| æ—§ API | æ–° API |
|--------|--------|
| `supabase` | `supabase` (from `@/lib/database`) |
| `signIn(email, password)` | `signIn(email, password)` (from `@/lib/database`) |
| `signUp(email, password)` | `signUp(email, password)` (from `@/lib/database`) |
| `signOut()` | `signOut()` (from `@/lib/database`) |
| `db.trips.getAll(userId)` | ç›´æ¥ä½¿ç”¨ `supabase.from('trips').select()` |
| `db.trips.getById(id)` | ç›´æ¥ä½¿ç”¨ `supabase.from('trips').select().eq('id', id)` |
| `db.expenses.*` | ç›´æ¥ä½¿ç”¨ `supabase.from('expenses').*` |

**è¿ç§»ä»»åŠ¡æ¸…å•**ï¼š

- [ ] **app/api/ ç›®å½•**ï¼ˆ~12 ä¸ªæ–‡ä»¶ï¼‰
  - [ ] `app/api/trips/[id]/route.ts`
  - [ ] `app/api/trips/[id]/share/route.ts`
  - [ ] `app/api/trips/share/[token]/route.ts`
  - [ ] `app/api/expenses/route.ts`
  - [ ] `app/api/expenses/[id]/route.ts`
  - [ ] å…¶ä»–ç›¸å…³ API è·¯ç”±

- [ ] **components/ ç›®å½•**
  - [ ] ä½¿ç”¨ `db.trips` æˆ– `db.expenses` çš„ç»„ä»¶

- [ ] **lib/ å†…éƒ¨å¼•ç”¨**
  - [ ] ä½¿ç”¨ `supabase` çš„å…¶ä»–æ¨¡å—

#### é˜¶æ®µ 3ï¼š`lib/check-api-keys.ts` è¿ç§»ï¼ˆé¢„è®¡ 1 å‘¨ï¼‰

> âœ… **å·²å®Œæˆ** (2024-12-12): è¯¥æ–‡ä»¶æ— ä»»ä½•å¤–éƒ¨å¼•ç”¨ï¼Œå·²ç›´æ¥åˆ é™¤ã€‚

**ç›®æ ‡**ï¼šå°† `checkApiKeyAvailability` å‡½æ•°çš„è°ƒç”¨è¿ç§»åˆ° `ApiKeyChecker` ç±»

**æ–° API**ï¼š

```typescript
import { ApiKeyChecker } from '@/lib/api-keys'

// æ—§æ–¹å¼
const result = await checkApiKeyAvailability(userId, token, 'deepseek')

// æ–°æ–¹å¼
const result = await ApiKeyChecker.checkDeepSeekRequired(userId, token)
```

### 2.3 éªŒè¯æ­¥éª¤

æ¯ä¸ªé˜¶æ®µå®Œæˆåæ‰§è¡Œï¼š

1. **ç±»å‹æ£€æŸ¥**ï¼š`npm run lint`
2. **å•å…ƒæµ‹è¯•**ï¼š`npm test`
3. **æ‰‹åŠ¨æµ‹è¯•**ï¼š
   - ç™»å½•/æ³¨å†ŒåŠŸèƒ½
   - API Key ç®¡ç†åŠŸèƒ½
   - è¡Œç¨‹ç”ŸæˆåŠŸèƒ½
   - è´¹ç”¨ç®¡ç†åŠŸèƒ½

### 2.4 åˆ é™¤æ—§æ–‡ä»¶

æ‰€æœ‰è¿ç§»å®Œæˆå¹¶éªŒè¯åï¼š

```bash
# æœ€ååˆ é™¤å‘åå…¼å®¹å±‚
rm lib/api-keys.ts
rm lib/check-api-keys.ts
rm lib/supabase.ts
```

---

## ä¸‰ã€æœåŠ¡å±‚è¯„ä¼°

> âœ… **å·²å®Œæˆ** (2024-12-12): é‡‡ç”¨é€‰é¡¹ Bï¼Œå·²åˆ é™¤æœªä½¿ç”¨çš„æœåŠ¡æ–‡ä»¶ï¼Œä¿ç•™ `geocoding.service.ts`ã€‚

### 3.1 è¯„ä¼°ç»“æœ

**å…³é”®å‘ç°**ï¼š
- `lib/repositories/` ç›®å½•ä¸å­˜åœ¨ï¼Œæ„å‘³ç€ä¾èµ– Repository æ¨¡å¼çš„æœåŠ¡ï¼ˆ`trip.service.ts`, `expense.service.ts`ï¼‰æ ¹æœ¬æ— æ³•æ­£å¸¸å·¥ä½œ
- `base.service.ts` ä¾èµ–ä¸å­˜åœ¨çš„ `IRepository` æ¥å£
- `ai.service.ts` è™½ç„¶å¯ç‹¬ç«‹å·¥ä½œï¼Œä½†æ— ä»»ä½•ä»£ç å¼•ç”¨
- `geocoding.service.ts` ç‹¬ç«‹å®ç°ï¼ˆä¸ä¾èµ– BaseServiceï¼‰ï¼Œè¢« `coordinate-fixer.ts` å®é™…ä½¿ç”¨

### 3.2 æ‰§è¡Œç»“æœ

| æœåŠ¡ | è¡Œæ•° | å¤„ç†æ–¹å¼ |
|------|------|---------|
| `trip.service.ts` | 346 | âŒ å·²åˆ é™¤ï¼ˆä¾èµ–ä¸å­˜åœ¨çš„ Repositoryï¼‰ |
| `expense.service.ts` | 292 | âŒ å·²åˆ é™¤ï¼ˆä¾èµ–ä¸å­˜åœ¨çš„ Repositoryï¼‰ |
| `ai.service.ts` | 256 | âŒ å·²åˆ é™¤ï¼ˆæ— ä»»ä½•å¼•ç”¨ï¼‰ |
| `base.service.ts` | 189 | âŒ å·²åˆ é™¤ï¼ˆRepository æ¨¡å¼æœªå®ç°ï¼‰ |
| `geocoding.service.ts` | 392 | âœ… ä¿ç•™ï¼ˆè¢« `coordinate-fixer.ts` ä½¿ç”¨ï¼‰ |

### 3.3 æœ€ç»ˆçŠ¶æ€

`lib/services/` ç›®å½•ç°ä»…åŒ…å«ï¼š
- `geocoding.service.ts` - æä¾›åœ°ç†ç¼–ç ã€POI æœç´¢ã€åæ ‡è½¬æ¢åŠŸèƒ½

---

## å››ã€è¶…å¤§æ–‡ä»¶æ‹†åˆ†

> âœ… **è¯„ä¼°å®Œæˆ** (2024-12-12): ç»è¿‡é‡æ–°æ£€æŸ¥ï¼Œæ–‡ä»¶å¤§å°ä¸åŸå§‹è®°å½•å·®å¼‚å¾ˆå¤§ï¼Œæ— éœ€æ‹†åˆ†ã€‚

### 4.1 `hooks/useChatAgent.ts` è¯„ä¼°

**åŸå§‹è®°å½•**ï¼š32,549 è¡Œï¼ˆè¿‡å¤§ï¼‰
**å®é™…çŠ¶æ€**ï¼š**1,057 è¡Œ**ï¼ˆåˆç†èŒƒå›´ï¼‰

**ç»“è®º**ï¼šæ–‡ä»¶å¤§å°åœ¨åˆç†èŒƒå›´å†…ï¼ˆçº¦ 1000 è¡Œï¼‰ï¼Œä»£ç ç»“æ„æ¸…æ™°ï¼Œæ— éœ€æ‹†åˆ†ã€‚

### 4.2 `lib/sync.ts` è¯„ä¼°

**åŸå§‹è®°å½•**ï¼š11,391 è¡Œ
**å®é™…çŠ¶æ€**ï¼š**408 è¡Œ**ï¼ˆåˆç†èŒƒå›´ï¼‰

**ç»“è®º**ï¼šæ–‡ä»¶å¤§å°åœ¨åˆç†èŒƒå›´å†…ï¼ˆçº¦ 400 è¡Œï¼‰ï¼Œæ— éœ€æ‹†åˆ†ã€‚

> **å¤‡æ³¨**ï¼šåŸå§‹è®°å½•çš„è¡Œæ•°å¯èƒ½æ˜¯ç»Ÿè®¡é”™è¯¯æˆ–æ—©æœŸç‰ˆæœ¬æ•°æ®ã€‚å½“å‰ä»£ç å·²ç»è¿‡è‰¯å¥½çš„æ¨¡å—åŒ–é‡æ„ã€‚

---

## äº”ã€å¸¸é‡æ¨¡å—æ•´åˆ

> âœ… **å·²å®Œæˆ** (2024-12-12): `lib/constants/` ç›®å½•æœªè¢«ä»»ä½•ä»£ç å¼•ç”¨ï¼Œå·²åˆ é™¤ã€‚

### 5.1 è¯„ä¼°ç»“æœ

**å…³é”®å‘ç°**ï¼š
- `lib/constants/` ç›®å½•åŒ…å« 3 ä¸ªæ–‡ä»¶ï¼š`index.ts`ã€`business.ts`ã€`ui.ts`
- æœç´¢æ•´ä¸ªä»£ç åº“ï¼Œ**æ²¡æœ‰ä»»ä½• `.ts` æˆ– `.tsx` æ–‡ä»¶** å¼•ç”¨ `@/lib/constants`
- `lib/config/index.ts` å¯¼å…¥çš„æ˜¯ `./constants`ï¼ˆå³ `lib/config/constants.ts`ï¼‰ï¼Œè€Œé `lib/constants/`
- `lib/config/constants.ts` æ˜¯ç‹¬ç«‹çš„å¸¸é‡æ–‡ä»¶ï¼ŒåŒ…å«é¡¹ç›®å®é™…ä½¿ç”¨çš„å¸¸é‡

### 5.2 æ‰§è¡Œç»“æœ

| æ–‡ä»¶ | è¡Œæ•° | å¤„ç†æ–¹å¼ |
|------|------|---------|
| `lib/constants/index.ts` | 7 | âŒ å·²åˆ é™¤ï¼ˆæ— å¼•ç”¨ï¼‰ |
| `lib/constants/business.ts` | 191 | âŒ å·²åˆ é™¤ï¼ˆæ— å¼•ç”¨ï¼‰ |
| `lib/constants/ui.ts` | 145 | âŒ å·²åˆ é™¤ï¼ˆæ— å¼•ç”¨ï¼‰ |

### 5.3 æœ€ç»ˆçŠ¶æ€

- `lib/constants/` ç›®å½•å·²å®Œå…¨åˆ é™¤
- é¡¹ç›®å¸¸é‡ç»Ÿä¸€ç”± `lib/config/constants.ts` ç®¡ç†
- å·²é€šè¿‡ `npm run lint` éªŒè¯ï¼Œæ— ä»»ä½•å¼•ç”¨é”™è¯¯

---

## å…­ã€è¿›åº¦è·Ÿè¸ª

### é˜¶æ®µå®Œæˆæ¸…å•

| é˜¶æ®µ | ä»»åŠ¡ | çŠ¶æ€ | å®Œæˆæ—¥æœŸ |
|------|------|------|---------|
| 1 | `lib/api-keys.ts` è¿ç§» | âœ… å·²å®Œæˆ | 2024-12-12 |
| 2 | `lib/supabase.ts` è¿ç§» | âœ… å·²å®Œæˆ | 2024-12-12 |
| 3 | `lib/check-api-keys.ts` è¿ç§» | âœ… å·²å®Œæˆ | 2024-12-12 |
| 4 | æœåŠ¡å±‚è¯„ä¼°ä¸å¤„ç† | âœ… å·²å®Œæˆ | 2024-12-12 |
| 5 | `useChatAgent.ts` æ‹†åˆ† | âœ… æ— éœ€æ‹†åˆ† | 2024-12-12 |
| 6 | `sync.ts` æ‹†åˆ† | âœ… æ— éœ€æ‹†åˆ† | 2024-12-12 |
| 7 | å¸¸é‡æ¨¡å—æ•´åˆ | âœ… å·²å®Œæˆ | 2024-12-12 |
| 8 | åˆ é™¤å‘åå…¼å®¹å±‚æ–‡ä»¶ | âœ… å·²å®Œæˆ | 2024-12-12 |

### ğŸ‰ è®¡åˆ’å®Œæˆæ€»ç»“

**æ‰€æœ‰ä»»åŠ¡å·²å®Œæˆï¼** ä»£ç æ¸…ç†ä¸­æœŸæ‰§è¡Œè®¡åˆ’åœ†æ»¡ç»“æŸã€‚

**ä¸»è¦æˆæœ**ï¼š
1. **å‘åå…¼å®¹å±‚è¿ç§»**ï¼šæˆåŠŸå°† `lib/api-keys.ts`ã€`lib/supabase.ts`ã€`lib/check-api-keys.ts` è¿ç§»åˆ°æ¨¡å—åŒ–æ¶æ„ï¼Œå¹¶åˆ é™¤æ—§æ–‡ä»¶
2. **æœåŠ¡å±‚æ¸…ç†**ï¼šè¯„ä¼°å¹¶åˆ é™¤äº† 4 ä¸ªæœªä½¿ç”¨/æ— æ³•å·¥ä½œçš„æœåŠ¡æ–‡ä»¶ï¼Œä¿ç•™äº† `geocoding.service.ts`
3. **è¶…å¤§æ–‡ä»¶è¯„ä¼°**ï¼šé‡æ–°æ£€æŸ¥å‘ç°æ–‡ä»¶å¤§å°å·²åœ¨åˆç†èŒƒå›´å†…ï¼Œæ— éœ€æ‹†åˆ†
4. **æ­»ä»£ç æ¸…ç†**ï¼šåˆ é™¤äº†å®Œå…¨æœªè¢«å¼•ç”¨çš„ `lib/constants/` ç›®å½•

**ä»£ç å‡å°‘ç»Ÿè®¡**ï¼š
- åˆ é™¤çš„æ–‡ä»¶ï¼š
  - `lib/api-keys.ts`
  - `lib/supabase.ts`
  - `lib/check-api-keys.ts`
  - `lib/services/trip.service.ts`
  - `lib/services/expense.service.ts`
  - `lib/services/ai.service.ts`
  - `lib/services/base.service.ts`
  - `lib/constants/index.ts`
  - `lib/constants/business.ts`
  - `lib/constants/ui.ts`

### é‡Œç¨‹ç¢‘

- **ç¬¬ 2 å‘¨ç»“æŸ**ï¼šå®Œæˆ `lib/api-keys.ts` è¿ç§»
- **ç¬¬ 4 å‘¨ç»“æŸ**ï¼šå®Œæˆ `lib/supabase.ts` è¿ç§»
- **ç¬¬ 5 å‘¨ç»“æŸ**ï¼šå®ŒæˆæœåŠ¡å±‚è¯„ä¼°
- **ç¬¬ 7 å‘¨ç»“æŸ**ï¼šå®Œæˆè¶…å¤§æ–‡ä»¶æ‹†åˆ†
- **ç¬¬ 8 å‘¨ç»“æŸ**ï¼šåˆ é™¤å‘åå…¼å®¹å±‚ï¼Œå®Œæˆæ¸…ç†

---

## ä¸ƒã€é£é™©ä¸æ³¨æ„äº‹é¡¹

### 7.1 é£é™©

1. **å›å½’é£é™©**ï¼šè¿ç§»è¿‡ç¨‹ä¸­å¯èƒ½å¼•å…¥ bug
   - ç¼“è§£æªæ–½ï¼šæ¯ä¸ªé˜¶æ®µå®Œæˆåè¿›è¡Œå®Œæ•´æµ‹è¯•

2. **åä½œå†²çª**ï¼šå¦‚æœå¤šäººåŒæ—¶ä¿®æ”¹ç›¸å…³æ–‡ä»¶
   - ç¼“è§£æªæ–½ï¼šæå‰æ²Ÿé€šï¼Œåˆ†é…æ˜ç¡®çš„ä»»åŠ¡èŒƒå›´

3. **é—æ¼å¯¼å…¥**ï¼šå¯èƒ½é—æ¼æŸäº›æ–‡ä»¶çš„å¯¼å…¥æ›´æ–°
   - ç¼“è§£æªæ–½ï¼šä½¿ç”¨ `grep` æˆ– IDE å…¨å±€æœç´¢ç¡®è®¤

### 7.2 æ³¨æ„äº‹é¡¹

1. **ä¿æŒå‘åå…¼å®¹**ï¼šåœ¨å®Œå…¨è¿ç§»å‰ï¼Œä¿ç•™å…¼å®¹å±‚æ–‡ä»¶
2. **å¢é‡æäº¤**ï¼šæ¯ä¸ªå°ä»»åŠ¡å®Œæˆåç«‹å³æäº¤
3. **æ–‡æ¡£æ›´æ–°**ï¼šè¿ç§»å®Œæˆåæ›´æ–° `CLAUDE.md` ç›¸å…³æ–‡æ¡£
4. **ç±»å‹æ£€æŸ¥**ï¼šæ¯æ¬¡ä¿®æ”¹åè¿è¡Œ `npm run lint`

---

## å…«ã€ç›¸å…³æ–‡æ¡£

- [CLAUDE.md](../../CLAUDE.md) - é¡¹ç›®ä¸»æ–‡æ¡£
- [Phase 3 ç»„ä»¶é‡æ„æŠ¥å‘Š](../æ¶æ„è®¾è®¡/Phase3ç»„ä»¶é‡æ„æŠ¥å‘Š.md)
- [å¤šæ™ºèƒ½ä½“æ¶æ„å‡çº§è®¡åˆ’](../æ¶æ„è®¾è®¡/å¤šæ™ºèƒ½ä½“æ¶æ„å‡çº§è®¡åˆ’.md)
