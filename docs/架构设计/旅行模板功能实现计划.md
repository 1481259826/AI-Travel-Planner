# 旅行模板功能实现计划

## 概述

旅行模板功能允许用户将已有行程保存为模板，方便以后复用。模板仅供个人使用，不支持公开分享。

## 功能特性

- **保存模板**：从行程详情页一键保存为模板
- **管理模板**：在设置页面查看、编辑、删除模板
- **应用模板**：基于模板快速创建新行程
- **分类筛选**：支持按旅行类型分类（亲子、情侣、朋友等）
- **对话集成**：通过 AI 对话助手管理和应用模板

## 实现进度

### Phase 1: 数据库和基础层 ✅

- [x] 创建数据库迁移脚本 `database/migrations/add_templates_table.sql`
- [x] 创建类型定义 `lib/templates/types.ts`
- [x] 创建服务层 `lib/templates/service.ts`
- [x] 创建统一导出 `lib/templates/index.ts`

### Phase 2: API 端点 ✅

- [x] `GET/POST /api/templates` - 列表查询和创建
- [x] `GET/PUT/DELETE/POST /api/templates/[id]` - 单个模板操作和应用
- [x] `POST /api/templates/from-trip` - 从行程创建模板

### Phase 3: 前端组件 ✅

- [x] `TemplateCard` - 模板卡片组件
- [x] `TemplateSaveModal` - 保存模板模态框
- [x] `TemplateEditModal` - 编辑模板模态框
- [x] `TemplateManager` - 模板管理主组件
- [x] `useTemplates` Hook - 模板状态管理

### Phase 4: 页面集成 ✅

- [x] 设置页面添加「旅行模板」Tab
- [x] 行程详情页添加「保存为模板」按钮

### Phase 5: 对话工具集成 ✅

- [x] 添加模板相关工具定义（list_templates, save_template, apply_template, delete_template）
- [x] 实现工具执行器方法
- [x] 扩展 useChatAgent 处理 apply_template 结果

### Phase 6: 文档更新 ✅

- [x] 创建实现计划文档

## 技术架构

### 数据库设计

```sql
CREATE TABLE trip_templates (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  name VARCHAR(100) NOT NULL,
  description TEXT,
  category VARCHAR(20) DEFAULT 'other',
  destination VARCHAR(100) NOT NULL,
  duration_days INTEGER NOT NULL,
  itinerary_template JSONB NOT NULL,
  use_count INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### 模块结构

```
lib/templates/
├── types.ts          # 类型定义
├── service.ts        # 服务层（CRUD + 业务逻辑）
└── index.ts          # 统一导出

components/templates/
├── TemplateCard.tsx      # 模板卡片
├── TemplateSaveModal.tsx # 保存模态框
├── TemplateEditModal.tsx # 编辑模态框
├── TemplateManager.tsx   # 管理主组件
└── index.ts              # 统一导出

hooks/
└── useTemplates.ts       # 模板状态管理 Hook

app/api/templates/
├── route.ts              # 列表和创建 API
├── [id]/route.ts         # 单个模板 API
└── from-trip/route.ts    # 从行程创建 API
```

### 对话工具

| 工具名 | 功能 | 参数 |
|--------|------|------|
| `list_templates` | 列出用户模板 | category?, search?, limit? |
| `save_template` | 保存行程为模板 | trip_id, name, description?, category? |
| `apply_template` | 应用模板创建行程 | template_id |
| `delete_template` | 删除模板 | template_id |

## 使用方式

### 1. 保存模板

```typescript
// 在行程详情页点击「保存为模板」按钮
// 或通过对话："把这个行程保存为模板，叫杭州三日游"
```

### 2. 管理模板

```typescript
// 在设置页面的「旅行模板」Tab 中管理
// 或通过对话："查看我的模板"、"删除杭州模板"
```

### 3. 应用模板

```typescript
// 通过对话："用杭州模板创建新行程"
// 或在模板管理页面点击「应用」按钮
```

## 后续优化方向

- [ ] 模板预览功能
- [ ] 模板导入导出
- [ ] 公开模板市场（可选）
- [ ] 模板版本管理

---

创建日期：2024-12
状态：已完成
