# 费用数据可视化功能文档

## 功能概述

费用数据可视化功能为旅行计划应用提供了全面的预算分析和费用追踪可视化能力。用户可以通过直观的图表查看费用分布、每日开销趋势，并监控预算使用情况。

## 主要特性

### 1. 预算使用情况仪表板
- **实时统计**：显示总预算、已花费、剩余预算和使用率
- **可视化进度条**：直观展示预算使用百分比
- **智能预警**：
  - 绿色：使用率 < 80%
  - 黄色：使用率 80-100%
  - 红色：已超出预算

### 2. 费用类别分布（饼图）
- 按类别聚合费用总额
- 显示每个类别的金额和占比
- 支持的类别：
  - 交通（蓝色）
  - 住宿（绿色）
  - 餐饮（琥珀色）
  - 景点（紫色）
  - 购物（粉色）
  - 其他（灰色）

### 3. 每日开销趋势（柱状图）
- 按日期展示费用分布
- 可视化每日开销变化
- 支持按时间范围筛选

### 4. 数据导出功能
- **CSV 导出**：导出费用明细表格，支持 Excel 打开
- **PDF 导出**：生成专业的费用报告，包含：
  - 预算摘要
  - 类别统计表
  - 费用明细表

### 5. 日期范围筛选
- 自定义开始和结束日期
- 实时更新图表数据
- 一键重置功能

## 技术实现

### 核心组件

#### 1. `BudgetChart.tsx`
主要可视化组件，包含：
- Recharts 图表库集成
- 响应式设计
- 数据导出功能

```typescript
<BudgetChart
  expenses={expenses}
  totalBudget={trip.budget}
  tripName={trip.destination}
/>
```

#### 2. `lib/analytics.ts`
数据处理工具库，提供：
- `calculateBudgetStats()` - 计算预算统计
- `aggregateByCategory()` - 按类别聚合
- `aggregateByDate()` - 按日期聚合
- `filterExpensesByDateRange()` - 日期筛选
- `exportToCSV()` - CSV 导出
- `exportToPDF()` - PDF 导出

#### 3. `types/expense.ts`
类型定义：
```typescript
export interface Expense {
  id: string;
  trip_id: string;
  category: string;
  amount: number;
  description: string | null;
  expense_date: string;
  created_at: string;
  updated_at: string;
}
```

### 依赖库

- **recharts** (^2.15.0) - 图表绘制
- **jspdf** (^2.5.2) - PDF 生成
- **jspdf-autotable** (^3.8.4) - PDF 表格

## 使用指南

### 访问数据分析页面

1. 登录应用
2. 进入 Dashboard
3. 点击任意行程卡片
4. 切换到"数据分析"标签页

### 查看费用分布

- **饼图**：直观了解各类费用占比
- **图例**：显示每个类别的具体金额和百分比

### 分析每日开销

- **柱状图**：查看每天的消费趋势
- **悬停提示**：显示具体日期和金额

### 导出数据

#### CSV 导出
1. 点击"导出 CSV"按钮
2. 文件自动下载，格式：`{行程名}_expenses_{时间戳}.csv`
3. 可用 Excel 或其他表格软件打开

#### PDF 导出
1. 点击"导出 PDF"按钮
2. 系统生成完整报告
3. 包含预算摘要、类别统计和费用明细

### 使用日期筛选

1. 设置开始日期和/或结束日期
2. 图表自动更新显示筛选后的数据
3. 点击"重置"按钮清除筛选

## 响应式设计

### 桌面端（≥1024px）
- 左右布局：饼图和柱状图并排显示
- 完整功能展示

### 平板端（768px - 1023px）
- 图表垂直堆叠
- 保持完整功能

### 移动端（<768px）
- 单列布局
- 图表自适应缩放
- 触摸友好的交互

## API 集成

### 数据库查询

从 Supabase `expenses` 表获取数据：

```typescript
const { data, error } = await supabase
  .from('expenses')
  .select('*')
  .eq('trip_id', tripId)
  .order('expense_date', { ascending: false });
```

### 数据结构

确保数据库表包含以下字段：
- `id` - UUID 主键
- `trip_id` - 关联行程 ID
- `category` - 费用类别
- `amount` - 金额（数值）
- `description` - 描述
- `expense_date` - 费用日期
- `created_at` - 创建时间
- `updated_at` - 更新时间

## 最佳实践

### 1. 性能优化
- 使用 `useMemo` 缓存计算结果
- 按需加载图表库
- 异步导出大量数据

### 2. 用户体验
- 提供加载状态提示
- 空状态引导用户添加数据
- 导出时显示进度指示

### 3. 数据准确性
- 实时同步费用数据
- 验证日期范围有效性
- 处理边界情况（无数据、超预算等）

## 故障排查

### 图表不显示
1. 检查是否有费用数据
2. 验证数据格式是否正确
3. 查看浏览器控制台错误

### 导出失败
1. 检查浏览器是否支持下载
2. 验证数据是否完整
3. 确认依赖库已正确安装

### 日期筛选无效
1. 确认日期格式正确
2. 检查开始日期是否早于结束日期
3. 验证费用记录包含有效日期

## 未来改进

### 计划中的功能
- [ ] 多币种支持
- [ ] 自定义图表主题
- [ ] 费用预测和趋势分析
- [ ] 与预算目标的对比
- [ ] 导出 Excel 格式
- [ ] 分享报告链接
- [ ] 打印优化视图

### 性能优化
- [ ] 虚拟滚动长列表
- [ ] Web Worker 处理大数据集
- [ ] 图表懒加载
- [ ] 缓存策略优化

## 相关文档

- [费用追踪系统](./EXPENSE_TRACKING.md)
- [数据库设置指南](./DATABASE_SETUP.md)
- [API 文档](./API.md)

## 支持

如遇问题，请：
1. 查看浏览器控制台错误信息
2. 检查网络请求是否成功
3. 验证环境变量配置
4. 提交 Issue 到 GitHub 仓库
