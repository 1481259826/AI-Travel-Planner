# 代码清理中期执行计划

**创建日期**：2024-12-12
**预计周期**：4-8 周
**优先级**：中

---

## 一、计划概述

本计划旨在逐步清理项目中的技术债务，包括：
1. 向后兼容层文件的迁移和删除
2. 未充分使用的服务层评估
3. 超大文件的拆分优化
4. 常量模块整合

---

## 二、向后兼容层迁移

### 2.1 目标文件

| 文件 | 当前引用数 | 新模块位置 | 优先级 |
|------|-----------|-----------|--------|
| `lib/api-keys.ts` | 42 个文件 | `lib/api-keys/` | 高 |
| `lib/supabase.ts` | 28 个文件 | `lib/database/` | 高 |
| `lib/check-api-keys.ts` | 多处使用 | `lib/api-keys/checker.ts` | 中 |

### 2.2 迁移步骤

#### 阶段 1：`lib/api-keys.ts` 迁移（预计 2 周）

**目标**：将所有 `lib/api-keys.ts` 的导入迁移到 `lib/api-keys/` 模块

**新 API 对照表**：

| 旧 API | 新 API |
|--------|--------|
| `getDecryptedApiKey(userId, service, supabase)` | `ApiKeyClient.getUserConfig(userId, service, supabase)` |
| `getSystemApiKey(service)` | `ApiKeyClient.getSystemKey(service)` |
| `testDeepSeekApiKey(apiKey)` | `ApiKeyValidator.testDeepSeekKey(apiKey)` |
| `testModelScopeApiKey(apiKey)` | `ApiKeyValidator.testModelScopeKey(apiKey)` |
| `testAmapApiKey(apiKey)` | `ApiKeyValidator.testAmapKey(apiKey)` |

**迁移任务清单**：

- [ ] **app/api/ 目录**（~15 个文件）
  - [ ] `app/api/generate-itinerary/route.ts`
  - [ ] `app/api/v2/generate-itinerary/route.ts`
  - [ ] `app/api/chat/generate-trip/route.ts`
  - [ ] `app/api/chat/route.ts`
  - [ ] `app/api/enrich-attraction/route.ts`
  - [ ] `app/api/enrich-hotel/route.ts`
  - [ ] `app/api/user/api-keys/route.ts`
  - [ ] `app/api/user/api-keys/[id]/route.ts`
  - [ ] `app/api/user/api-keys/test/route.ts`
  - [ ] `app/api/user/api-keys/import/route.ts`
  - [ ] `app/api/user/api-keys/system/route.ts`
  - [ ] `app/api/voice/parse-trip/route.ts`
  - [ ] `app/api/voice/transcribe/route.ts`
  - [ ] 其他相关 API 路由

- [ ] **components/ 目录**（~5 个文件）
  - [ ] `components/settings/ApiKeyManager.tsx`
  - [ ] `components/settings/api-keys/*.tsx`
  - [ ] 其他相关组件

- [ ] **hooks/ 目录**（~3 个文件）
  - [ ] `hooks/useApiKeyCheck.ts`
  - [ ] 其他相关 hooks

- [ ] **app/dashboard/ 目录**（~5 个文件）
  - [ ] `app/dashboard/create/page.tsx`
  - [ ] `app/login/page.tsx`
  - [ ] 其他相关页面

- [ ] **lib/ 内部引用**
  - [ ] `lib/api-keys/index.ts`（内部导入清理）

#### 阶段 2：`lib/supabase.ts` 迁移（预计 2 周）

**目标**：将所有 `lib/supabase.ts` 的导入迁移到 `lib/database/` 模块

**新 API 对照表**：

| 旧 API | 新 API |
|--------|--------|
| `supabase` | `supabase` (from `@/lib/database`) |
| `signIn(email, password)` | `signIn(email, password)` (from `@/lib/database`) |
| `signUp(email, password)` | `signUp(email, password)` (from `@/lib/database`) |
| `signOut()` | `signOut()` (from `@/lib/database`) |
| `db.trips.getAll(userId)` | 直接使用 `supabase.from('trips').select()` |
| `db.trips.getById(id)` | 直接使用 `supabase.from('trips').select().eq('id', id)` |
| `db.expenses.*` | 直接使用 `supabase.from('expenses').*` |

**迁移任务清单**：

- [ ] **app/api/ 目录**（~12 个文件）
  - [ ] `app/api/trips/[id]/route.ts`
  - [ ] `app/api/trips/[id]/share/route.ts`
  - [ ] `app/api/trips/share/[token]/route.ts`
  - [ ] `app/api/expenses/route.ts`
  - [ ] `app/api/expenses/[id]/route.ts`
  - [ ] 其他相关 API 路由

- [ ] **components/ 目录**
  - [ ] 使用 `db.trips` 或 `db.expenses` 的组件

- [ ] **lib/ 内部引用**
  - [ ] 使用 `supabase` 的其他模块

#### 阶段 3：`lib/check-api-keys.ts` 迁移（预计 1 周）

**目标**：将 `checkApiKeyAvailability` 函数的调用迁移到 `ApiKeyChecker` 类

**新 API**：

```typescript
import { ApiKeyChecker } from '@/lib/api-keys'

// 旧方式
const result = await checkApiKeyAvailability(userId, token, 'deepseek')

// 新方式
const result = await ApiKeyChecker.checkDeepSeekRequired(userId, token)
```

### 2.3 验证步骤

每个阶段完成后执行：

1. **类型检查**：`npm run lint`
2. **单元测试**：`npm test`
3. **手动测试**：
   - 登录/注册功能
   - API Key 管理功能
   - 行程生成功能
   - 费用管理功能

### 2.4 删除旧文件

所有迁移完成并验证后：

```bash
# 最后删除向后兼容层
rm lib/api-keys.ts
rm lib/check-api-keys.ts
rm lib/supabase.ts
```

---

## 三、服务层评估

### 3.1 当前状态

`lib/services/` 目录包含以下服务类：

| 服务 | 文件大小 | 当前使用情况 |
|------|---------|-------------|
| `trip.service.ts` | 9.9 KB | 仅测试文件使用 |
| `expense.service.ts` | 7.9 KB | 仅测试文件使用 |
| `ai.service.ts` | 6.9 KB | 仅测试文件使用 |
| `base.service.ts` | 4.9 KB | 作为基类 |
| `geocoding.service.ts` | 10.3 KB | `app/api/_utils/coordinate-fixer.ts` 使用 |

### 3.2 评估任务

- [ ] **确认 `geocoding.service.ts` 的依赖关系**
  - 检查 `coordinate-fixer.ts` 是否可以使用其他方式替代
  - 如果保留，考虑迁移到 `lib/` 根目录或专门的地理模块

- [ ] **评估其他服务的价值**
  - 决定是否推广使用服务层模式
  - 或者删除未使用的服务文件

### 3.3 决策选项

**选项 A：推广服务层模式**
- 在 API 路由中使用服务类
- 好处：代码复用、测试友好
- 工作量：较大，需要重构多个 API 路由

**选项 B：删除未使用的服务**
- 保留 `geocoding.service.ts`（如有必要）
- 删除其他未使用的服务
- 好处：减少代码量
- 工作量：较小

**推荐**：选项 B，除非有明确的服务层复用需求

---

## 四、超大文件拆分

### 4.1 `hooks/useChatAgent.ts` 拆分（高优先级）

**当前状态**：32,549 行（过大）

**拆分方案**：

```
hooks/
├── useChatAgent.ts          # 主 hook（入口）
├── chat/
│   ├── useChatState.ts      # 聊天状态管理
│   ├── useChatMessages.ts   # 消息处理逻辑
│   ├── useChatSession.ts    # 会话管理
│   ├── useChatTools.ts      # 工具调用处理
│   ├── useChatStream.ts     # SSE 流处理
│   └── types.ts             # 类型定义
```

**拆分任务**：

- [ ] 创建 `hooks/chat/` 目录
- [ ] 提取状态管理逻辑到 `useChatState.ts`
- [ ] 提取消息处理逻辑到 `useChatMessages.ts`
- [ ] 提取会话管理逻辑到 `useChatSession.ts`
- [ ] 提取工具调用逻辑到 `useChatTools.ts`
- [ ] 提取 SSE 流处理到 `useChatStream.ts`
- [ ] 重构主 `useChatAgent.ts` 组合这些 hooks
- [ ] 更新所有导入该 hook 的文件
- [ ] 测试验证

### 4.2 `lib/sync.ts` 拆分（中优先级）

**当前状态**：11,391 行

**拆分方案**：

```
lib/sync/
├── index.ts                 # 统一导出
├── sync-manager.ts          # 同步管理器
├── conflict-resolver.ts     # 冲突解决
├── queue-manager.ts         # 同步队列
├── network-monitor.ts       # 网络状态监听
└── types.ts                 # 类型定义
```

---

## 五、常量模块整合

### 5.1 当前状态

`lib/constants/` 目录仅被 `lib/config/index.ts` 导入一次

### 5.2 建议

- [ ] 将 `lib/constants/` 内容合并到 `lib/config/`
- [ ] 删除 `lib/constants/` 目录
- [ ] 或者在更多地方使用常量模块（如果有价值）

---

## 六、进度跟踪

### 阶段完成清单

| 阶段 | 任务 | 状态 | 完成日期 |
|------|------|------|---------|
| 1 | `lib/api-keys.ts` 迁移 | 待开始 | - |
| 2 | `lib/supabase.ts` 迁移 | 待开始 | - |
| 3 | `lib/check-api-keys.ts` 迁移 | 待开始 | - |
| 4 | 服务层评估与处理 | 待开始 | - |
| 5 | `useChatAgent.ts` 拆分 | 待开始 | - |
| 6 | `sync.ts` 拆分 | 待开始 | - |
| 7 | 常量模块整合 | 待开始 | - |
| 8 | 删除向后兼容层文件 | 待开始 | - |

### 里程碑

- **第 2 周结束**：完成 `lib/api-keys.ts` 迁移
- **第 4 周结束**：完成 `lib/supabase.ts` 迁移
- **第 5 周结束**：完成服务层评估
- **第 7 周结束**：完成超大文件拆分
- **第 8 周结束**：删除向后兼容层，完成清理

---

## 七、风险与注意事项

### 7.1 风险

1. **回归风险**：迁移过程中可能引入 bug
   - 缓解措施：每个阶段完成后进行完整测试

2. **协作冲突**：如果多人同时修改相关文件
   - 缓解措施：提前沟通，分配明确的任务范围

3. **遗漏导入**：可能遗漏某些文件的导入更新
   - 缓解措施：使用 `grep` 或 IDE 全局搜索确认

### 7.2 注意事项

1. **保持向后兼容**：在完全迁移前，保留兼容层文件
2. **增量提交**：每个小任务完成后立即提交
3. **文档更新**：迁移完成后更新 `CLAUDE.md` 相关文档
4. **类型检查**：每次修改后运行 `npm run lint`

---

## 八、相关文档

- [CLAUDE.md](../../CLAUDE.md) - 项目主文档
- [Phase 3 组件重构报告](../架构设计/Phase3组件重构报告.md)
- [多智能体架构升级计划](../架构设计/多智能体架构升级计划.md)
