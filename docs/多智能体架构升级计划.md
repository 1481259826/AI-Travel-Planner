# 多智能体架构升级计划

> 基于 LangGraph + MCP 协议的地理空间感知多智能体协作系统
> (Geospatially Aware Multi-Agent System via LangGraph & Model Context Protocol)

**创建日期**: 2025-11-26
**状态**: 规划中
**核心框架**: LangGraph (状态图编排) + MCP (工具调用协议)
**预计完成**: 分 5 个阶段实施

---

## 目录

1. [项目概述](#项目概述)
2. [架构设计](#架构设计)
3. [LangGraph 核心设计](#langgraph-核心设计)
4. [实施阶段](#实施阶段)
5. [Agent 详细设计](#agent-详细设计)
6. [MCP Server 设计](#mcp-server-设计)
7. [数据流与状态管理](#数据流与状态管理)
8. [技术选型](#技术选型)
9. [风险与挑战](#风险与挑战)
10. [进度追踪](#进度追踪)

---

## 项目概述

### 当前架构

项目当前采用单体 AI 调用架构：
- 用户提交表单 → 单次 AI 调用生成完整行程 → 坐标修正 → 地理聚类优化 → 保存

**现有模块**：
- `lib/amap-weather.ts` - 天气 API 集成
- `lib/geo-clustering.ts` - 地理聚类优化
- `app/api/_utils/ai-helper.ts` - AI 调用封装
- `app/api/_utils/coordinate-fixer.ts` - 坐标修正
- `app/api/enrich-attraction/` - 景点信息增强
- `app/api/enrich-hotel/` - 酒店信息增强

### 目标架构

升级为 **LangGraph 驱动的多智能体协作系统**：

**编排层 (LangGraph StateGraph)**：
- 使用 LangGraph 状态图定义 Agent 执行流程
- 节点 (Node) = Agent，边 (Edge) = 状态转移
- 原生支持条件分支、循环、并行执行

**专家 Agent 层**：
- **天气感知 Agent (Weather Scout)** - 环境上下文生成
- **核心规划 Agent (Itinerary Planner)** - 行程骨架生成
- **酒店专家 Agent (Accommodation Specialist)** - 住宿推荐
- **交通调度 Agent (Transport Logistician)** - 路线规划
- **餐饮推荐 Agent (Dining Recommender)** - 餐厅推荐
- **预算审计 Agent (Budget Critic)** - 成本校验

**工具层 (MCP Infrastructure)**：
- 所有外部 API 调用通过 **AMap MCP Server** 统一管理

### 架构优势

1. **LangGraph 状态图** - 可视化执行流程，易于理解和调试
2. **原生循环支持** - 预算超支自动触发重新规划，无需手动实现
3. **并行执行** - 资源类 Agent 使用并行节点同时执行
4. **检查点持久化** - 内置状态持久化，支持长任务中断恢复
5. **职责分离** - 每个 Agent 专注单一领域
6. **MCP 标准化** - 工具调用统一协议，易于扩展

---

## 架构设计

### 系统分层

```
┌─────────────────────────────────────────────────────────────┐
│                      用户层 (User Layer)                     │
│                   Next.js 前端 + API Routes                  │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│               编排层 (LangGraph StateGraph)                  │
│                                                             │
│   ┌─────────┐    ┌─────────┐    ┌─────────┐               │
│   │ Weather │───►│ Planner │───►│Resource │               │
│   │  Scout  │    │         │    │ Agents  │               │
│   └─────────┘    └─────────┘    └────┬────┘               │
│                                      │                      │
│                                      ▼                      │
│                               ┌─────────┐                   │
│                               │ Budget  │──┐                │
│                               │ Critic  │  │ 超预算?        │
│                               └────┬────┘  │                │
│                                    │       │                │
│                          通过 ◄────┴───────┘ 重试循环       │
└─────────────────────────────────────────────────────────────┘
                              │
            ┌─────────────────┼─────────────────┐
            ▼                 ▼                 ▼
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│   专家 Agent     │ │   专家 Agent     │ │   专家 Agent     │
│  Accommodation  │ │    Transport    │ │     Dining      │
│   Specialist    │ │   Logistician   │ │   Recommender   │
└─────────────────┘ └─────────────────┘ └─────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                  工具层 (MCP Infrastructure)                 │
│                     AMap MCP Server                         │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐       │
│  │ 天气查询  │ │ POI搜索  │ │ 路线规划  │ │ 地理编码  │       │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘       │
└─────────────────────────────────────────────────────────────┘
```

### 数据流

```
用户输入
    │
    ▼
┌───────────────────┐
│  Orchestrator     │ ◄─────────────────────────────────────┐
│  初始化共享状态     │                                       │
└───────────────────┘                                       │
    │                                                       │
    ▼                                                       │
┌───────────────────┐                                       │
│  Weather Scout    │                                       │
│  获取天气 + 策略   │                                       │
└───────────────────┘                                       │
    │ strategy_tags                                         │
    ▼                                                       │
┌───────────────────┐                                       │
│ Itinerary Planner │                                       │
│  生成行程骨架      │                                       │
└───────────────────┘                                       │
    │ draft_itinerary                                       │
    ├──────────────────┬──────────────────┐                 │
    ▼                  ▼                  ▼                 │
┌──────────┐    ┌──────────┐    ┌──────────┐               │
│  Hotel   │    │Transport │    │  Dining  │    并行执行    │
│ Agent    │    │  Agent   │    │  Agent   │               │
└──────────┘    └──────────┘    └──────────┘               │
    │                  │                  │                 │
    └──────────────────┴──────────────────┘                 │
                       │ enriched_data                      │
                       ▼                                    │
              ┌───────────────────┐                         │
              │  Budget Critic    │                         │
              │  预算审计          │                         │
              └───────────────────┘                         │
                       │                                    │
                       ▼                                    │
              ┌───────────────────┐    超预算?              │
              │     判断是否      │ ────Yes────────────────►│
              │     通过审计      │      feedback_loop      │
              └───────────────────┘                         │
                       │ No                                 │
                       ▼                                    │
              ┌───────────────────┐
              │  最终行程输出      │
              └───────────────────┘
```

---

## LangGraph 核心设计

### 为什么选择 LangGraph

| 需求 | 手动实现 | LangGraph |
|------|---------|-----------|
| 多 Agent 协作 | 自己写调度逻辑 | StateGraph 节点编排 |
| 预算超支重试 | while 循环 + 状态管理 | 条件边 + 循环边 |
| 并行执行 | Promise.all | 并行节点 (Fan-out/Fan-in) |
| 状态传递 | 手动管理对象 | 内置 State Channel |
| 执行追踪 | 自己实现日志 | 内置 Tracing |
| 中断恢复 | 复杂 | 内置 Checkpointer |

### 状态图定义

```typescript
import { StateGraph, END, START } from "@langchain/langgraph";
import { Annotation } from "@langchain/langgraph";

// 1. 定义共享状态 Schema (使用 Annotation)
const TripStateAnnotation = Annotation.Root({
  // 用户输入
  userInput: Annotation<TripFormData>,

  // 天气上下文
  weather: Annotation<WeatherOutput | null>({
    default: () => null,
    reducer: (_, new_val) => new_val,
  }),

  // 行程草稿
  draftItinerary: Annotation<DraftItinerary | null>({
    default: () => null,
    reducer: (_, new_val) => new_val,
  }),

  // 资源数据 (并行 Agent 结果合并)
  accommodation: Annotation<AccommodationResult | null>({
    default: () => null,
  }),
  transport: Annotation<TransportResult | null>({
    default: () => null,
  }),
  dining: Annotation<DiningResult | null>({
    default: () => null,
  }),

  // 预算审计
  budgetResult: Annotation<BudgetResult | null>({
    default: () => null,
  }),
  retryCount: Annotation<number>({
    default: () => 0,
    reducer: (current, delta) => current + delta,
  }),

  // 最终输出
  finalItinerary: Annotation<Itinerary | null>({
    default: () => null,
  }),
});

type TripState = typeof TripStateAnnotation.State;
```

### 工作流构建

```typescript
// 2. 创建状态图
const workflow = new StateGraph(TripStateAnnotation);

// 3. 添加节点 (每个节点是一个 Agent 函数)
workflow
  .addNode("weather_scout", weatherScoutAgent)
  .addNode("itinerary_planner", itineraryPlannerAgent)
  .addNode("accommodation", accommodationAgent)
  .addNode("transport", transportAgent)
  .addNode("dining", diningAgent)
  .addNode("budget_critic", budgetCriticAgent)
  .addNode("finalize", finalizeAgent);

// 4. 定义边 (执行顺序)
workflow
  // 入口 → 天气
  .addEdge(START, "weather_scout")
  // 天气 → 规划
  .addEdge("weather_scout", "itinerary_planner")
  // 规划 → 资源 (并行扇出)
  .addEdge("itinerary_planner", "accommodation")
  .addEdge("itinerary_planner", "transport")
  .addEdge("itinerary_planner", "dining")
  // 资源 → 预算 (扇入汇合)
  .addEdge("accommodation", "budget_critic")
  .addEdge("transport", "budget_critic")
  .addEdge("dining", "budget_critic");

// 5. 条件边：预算审计后的决策
workflow.addConditionalEdges(
  "budget_critic",
  (state: TripState) => {
    // 通过审计
    if (state.budgetResult?.isWithinBudget) {
      return "finalize";
    }
    // 超过最大重试次数，强制结束
    if (state.retryCount >= 3) {
      return "finalize";
    }
    // 超预算，返回重新规划
    return "retry";
  },
  {
    finalize: "finalize",
    retry: "itinerary_planner",  // 循环回规划节点
  }
);

// 6. 结束边
workflow.addEdge("finalize", END);

// 7. 编译工作流
const app = workflow.compile();
```

### Agent 节点实现示例

```typescript
/**
 * 天气感知 Agent
 * 调用 MCP 工具获取天气，输出策略标签
 */
async function weatherScoutAgent(state: TripState): Promise<Partial<TripState>> {
  const { userInput } = state;

  // 调用 MCP 工具获取天气
  const weatherData = await mcpClient.callTool("get_weather_forecast", {
    city: userInput.destination,
  });

  // 调用 AI 分析天气，生成策略标签
  const aiClient = createAIClient({ apiKey, baseURL });
  const analysis = await aiClient.chat.completions.create({
    model: "deepseek-chat",
    messages: [{
      role: "system",
      content: WEATHER_SCOUT_PROMPT,
    }, {
      role: "user",
      content: JSON.stringify(weatherData),
    }],
  });

  const weather = JSON.parse(analysis.choices[0].message.content);

  // 返回状态更新 (只返回要更新的字段)
  return { weather };
}

/**
 * 预算审计 Agent
 * 汇总成本，判断是否通过
 */
async function budgetCriticAgent(state: TripState): Promise<Partial<TripState>> {
  const { userInput, accommodation, transport, dining, draftItinerary } = state;

  // 汇总成本
  const totalCost =
    (accommodation?.totalCost || 0) +
    (transport?.totalCost || 0) +
    (dining?.totalCost || 0) +
    (draftItinerary?.estimatedAttractionCost || 0);

  const isWithinBudget = totalCost <= userInput.budget * 1.1; // 允许 10% 溢价

  const budgetResult: BudgetResult = {
    totalCost,
    budgetUtilization: totalCost / userInput.budget,
    isWithinBudget,
    feedback: isWithinBudget ? undefined : {
      action: "downgrade_hotel",
      targetReduction: totalCost - userInput.budget,
      suggestion: "建议选择更经济的住宿",
    },
  };

  return {
    budgetResult,
    retryCount: isWithinBudget ? 0 : 1, // 触发 reducer 累加
  };
}
```

### 执行工作流

```typescript
// 在 API Route 中调用
export async function POST(request: NextRequest) {
  const formData = await request.json();

  // 初始状态
  const initialState = {
    userInput: formData,
  };

  // 执行工作流
  const result = await app.invoke(initialState);

  // 返回最终行程
  return Response.json({
    success: true,
    data: result.finalItinerary,
  });
}
```

### 流式执行与进度反馈

```typescript
// 使用 stream 方法获取实时进度
const stream = await app.stream(initialState);

for await (const event of stream) {
  // event 包含当前执行的节点和状态更新
  console.log("Current node:", event);

  // 可以通过 SSE 推送给前端
  // res.write(`data: ${JSON.stringify(event)}\n\n`);
}
```

### 检查点与中断恢复

```typescript
import { MemorySaver } from "@langchain/langgraph";

// 添加检查点存储
const checkpointer = new MemorySaver();
const app = workflow.compile({ checkpointer });

// 执行时指定 thread_id
const config = { configurable: { thread_id: "trip-123" } };
const result = await app.invoke(initialState, config);

// 如果中断，可以从检查点恢复
const resumedResult = await app.invoke(null, config);
```

---

## 实施阶段

### Phase 1: MCP 基础设施搭建
**状态**: [x] 已完成 (2025-11-26)

#### 目标
- 搭建 AMap MCP Server
- 实现核心 MCP 工具集
- 本地调试验证

#### 任务清单
- [x] 1.1 创建 MCP Server 项目结构 (`mcp-servers/amap/`)
- [x] 1.2 实现天气查询工具 (`get_weather_forecast`)
- [x] 1.3 实现 POI 搜索工具 (`search_poi`, `search_nearby`)
- [x] 1.4 实现路线规划工具 (`get_driving_route`, `get_transit_route`, `get_walking_route`)
- [x] 1.5 实现地理编码工具 (`geocode`, `reverse_geocode`)
- [x] 1.6 实现距离计算工具 (`calculate_distance`)
- [x] 1.7 编写 MCP Server 单元测试
- [x] 1.8 配置 SSE/stdio 两种连接模式
- [x] 1.9 编写 MCP Server 文档

#### 技术要点
- 使用 `@modelcontextprotocol/sdk` 官方 SDK
- 支持 SSE 模式 (开发) 和 stdio 模式 (生产)
- 复用现有的 `lib/amap-weather.ts` 逻辑

#### 完成情况
已完成 AMap MCP Server 的完整实现，位于 `mcp-servers/amap/` 目录：
- 9 个 MCP 工具：天气查询、POI 搜索、周边搜索、驾车路线、步行路线、公交路线、地理编码、逆地理编码、距离计算
- 完整的 TypeScript 类型定义
- 24 个单元测试全部通过
- 支持 stdio 和 SSE 两种连接模式
- 详细的 README 文档

---

### Phase 2: LangGraph 框架搭建
**状态**: [x] 已完成 (2025-11-26)

#### 目标
- 安装配置 LangGraph
- 定义状态 Schema
- 构建工作流图
- 实现基础 Agent 节点

#### 任务清单
- [x] 2.1 安装 LangGraph 依赖 (`@langchain/langgraph`, `@langchain/core`)
- [x] 2.2 定义 TripState Annotation Schema (`lib/agents/state.ts`)
- [x] 2.3 创建 StateGraph 工作流 (`lib/agents/workflow.ts`)
- [x] 2.4 实现 MCP 客户端封装 (`lib/agents/mcp-client.ts`)
- [x] 2.5 实现简单的线性流程 (Weather → Planner → End)
- [x] 2.6 添加条件边和循环边 (Budget 重试)
- [x] 2.7 实现并行节点 (Resource Agents Fan-out/Fan-in)
- [x] 2.8 配置 Checkpointer 检查点存储
- [ ] 2.9 编写工作流单元测试

#### 技术要点
- 使用 `Annotation.Root` 定义类型安全的状态
- 使用 `addConditionalEdges` 实现预算审计决策
- 并行节点：从 Planner 发出多条边到资源 Agent
- 状态更新使用 Partial 返回，LangGraph 自动合并

#### 完成情况
已完成 LangGraph 框架的完整搭建，位于 `lib/agents/` 目录：
- **状态定义** (`state.ts`): 完整的 TripState Annotation，包含天气、草稿行程、资源数据、预算审计等所有状态字段
- **工作流定义** (`workflow.ts`): StateGraph 工作流，包含所有 Agent 节点、边定义、条件边、并行执行、检查点配置
- **MCP 客户端** (`mcp-client.ts`): 封装所有高德地图 API 调用，包含天气、POI 搜索、路线规划、地理编码、距离计算等 9 个工具
- **统一导出** (`index.ts`): 统一的模块导出接口

**注**: Agent 节点函数目前为占位符实现，完整的 AI 逻辑将在 Phase 3 实现

---

### Phase 3: 专家 Agent 实现
**状态**: [x] 已完成 (2025-11-26)

#### 目标
- 实现所有专家 Agent 节点函数
- 集成 MCP 工具调用
- 编写 Agent Prompts

#### 任务清单
- [x] 3.1 实现 Weather Scout Agent (`lib/agents/nodes/weather-scout.ts`)
- [x] 3.2 实现 Itinerary Planner Agent (`lib/agents/nodes/itinerary-planner.ts`)
- [x] 3.3 实现 Accommodation Specialist Agent (`lib/agents/nodes/accommodation.ts`)
- [x] 3.4 实现 Transport Logistician Agent (`lib/agents/nodes/transport.ts`)
- [x] 3.5 实现 Dining Recommender Agent (`lib/agents/nodes/dining.ts`)
- [x] 3.6 实现 Budget Critic Agent (`lib/agents/nodes/budget-critic.ts`)
- [x] 3.7 实现 Finalize Agent (汇总输出) (`lib/agents/nodes/finalize.ts`)
- [x] 3.8 编写各 Agent 的 System Prompts (`lib/agents/prompts/`)
- [ ] 3.9 编写各 Agent 单元测试

#### 技术要点
- 每个 Agent 是一个 `async (state: TripState) => Partial<TripState>` 函数
- Agent 内部可调用 MCP 工具和 AI 模型
- Prompt 设计要明确输入输出格式
- 复用现有 `createAIClient` 函数

#### 完成情况
已完成所有专家 Agent 的实现，位于 `lib/agents/nodes/` 目录：

**Agent 节点**：
- `weather-scout.ts`: 天气感知 Agent，获取天气预报并生成策略标签
- `itinerary-planner.ts`: 核心规划 Agent，生成行程骨架
- `accommodation.ts`: 住宿专家 Agent，推荐酒店
- `transport.ts`: 交通调度 Agent，计算路线和费用
- `dining.ts`: 餐饮推荐 Agent，推荐餐厅
- `budget-critic.ts`: 预算审计 Agent，汇总成本判断是否通过
- `finalize.ts`: 汇总输出 Agent，整合所有数据生成最终行程

**Agent Prompts**（`lib/agents/prompts/`）：
- 每个 Agent 都有对应的 System Prompt
- 包含输入输出格式说明
- 提供用户消息构建函数

**特性**：
- 支持自定义 AI 配置（apiKey, baseURL, model）
- 集成 MCP 客户端获取实时数据
- 支持预算超支自动重试
- 完整的类型定义和错误处理

---

### Phase 4: API 集成与迁移
**状态**: [x] 已完成 (2025-11-27)

#### 目标
- 重构现有 API 使用 LangGraph 工作流
- 实现流式进度反馈
- 保持向后兼容

#### 任务清单
- [x] 4.1 创建新 API 端点 (`/api/v2/generate-itinerary`)
- [x] 4.2 集成 LangGraph 工作流到 API Route
- [x] 4.3 实现 Feature Flag 切换 (`NEXT_PUBLIC_USE_LANGGRAPH`)
- [x] 4.4 实现 SSE 流式响应 (使用 `app.stream()`)
- [x] 4.5 更新前端调用逻辑，支持进度显示
- [x] 4.6 添加 Agent 执行进度 UI 组件 (`hooks/useLangGraphProgress.ts`)
- [x] 4.7 编写集成测试
- [ ] 4.8 性能对比测试 (单体 vs LangGraph) - 延后到 Phase 5

#### 技术要点
- 使用 `app.stream()` 获取实时执行状态
- 通过 SSE 推送 Agent 执行进度给前端
- Feature Flag 控制新旧架构切换
- 旧 API 保持不变，确保向后兼容

#### 已完成的实现
- **v2 API** (`app/api/v2/generate-itinerary/route.ts`): 支持 SSE 流式响应
- **Feature Flag** (`NEXT_PUBLIC_USE_LANGGRAPH`): 在 `.env.example` 和 `lib/config/app.config.ts` 中配置
- **SSE 进度监听 Hook** (`hooks/useLangGraphProgress.ts`): 使用 fetch + ReadableStream 实现
- **前端集成** (`app/dashboard/create/page.tsx`): 根据 Feature Flag 自动切换 v1/v2 API
- **集成测试** (`__tests__/lib/agents/`): workflow.test.ts (15 tests) + mcp-client.test.ts (11 tests)

---

### Phase 5: 优化与扩展
**状态**: [ ] 未开始

#### 目标
- 性能优化
- 持久化存储
- 可观测性提升

#### 任务清单
- [ ] 5.1 实现 Agent 执行结果缓存
- [ ] 5.2 配置 PostgreSQL Checkpointer (替换 MemorySaver)
- [ ] 5.3 实现 LangGraph Tracing (集成 LangSmith 或自定义)
- [ ] 5.4 添加执行指标监控 (Prometheus/Grafana)
- [ ] 5.5 实现工作流可视化调试页面
- [ ] 5.6 添加更多专家 Agent (如景点详情 Agent)
- [ ] 5.7 编写性能优化文档
- [ ] 5.8 更新 CLAUDE.md 和 README
- [ ] 5.9 完整 E2E 测试

#### 技术要点
- 使用 `@langchain/langgraph-checkpoint-postgres` 持久化
- LangSmith 提供开箱即用的 Tracing
- 导出工作流图用于可视化

---

## Agent 详细设计

### 1. 主控编排 Agent (Orchestrator)

**职责**：项目经理角色，负责状态管理和任务分发

```typescript
interface OrchestratorAgent {
  // 初始化共享状态
  initializeState(userInput: TripFormData): SharedState

  // 分发任务给专家 Agent
  dispatch(agent: AgentType, context: AgentContext): Promise<AgentResult>

  // 处理反馈循环
  handleFeedback(feedback: BudgetFeedback): void

  // 最终汇总
  finalize(): Itinerary
}
```

**Prompt 设计思路**：
- 不生成具体行程，只生成"任务指令"
- 持有完整的 JSON State
- 根据各 Agent 返回结果做决策

**决策逻辑示例**：
```
IF weather_agent.returns("暴雨") THEN
  instruct_planner("优先室内景点")

IF budget_agent.returns("超支") THEN
  instruct_hotel_agent("寻找更便宜的住宿")
  retry_budget_check()
```

---

### 2. 天气感知 Agent (Weather Scout)

**职责**：前置预处理，获取环境上下文

**MCP 工具**：
- `amap_mcp.get_weather_forecast(city, date)`

**输入**：
```typescript
interface WeatherInput {
  destination: string
  startDate: string
  endDate: string
}
```

**输出**：
```typescript
interface WeatherOutput {
  forecasts: DayForecast[]
  strategyTags: StrategyTag[]
  clothingAdvice: string
  warnings: string[]
}

type StrategyTag =
  | 'indoor_priority'      // 优先室内活动
  | 'outdoor_friendly'     // 适合户外
  | 'rain_prepared'        // 需带雨具
  | 'cold_weather'         // 天气寒冷
  | 'hot_weather'          // 天气炎热
```

**Prompt 核心**：
```
你是天气分析专家。分析目的地天气预报并输出策略建议。

根据天气情况输出以下策略标签：
- 如果有雨：添加 "indoor_priority" 和 "rain_prepared"
- 如果温度 < 10°C：添加 "cold_weather"
- 如果温度 > 30°C：添加 "hot_weather"
- 如果晴朗无风：添加 "outdoor_friendly"

输出格式为 JSON。
```

---

### 3. 核心规划 Agent (Itinerary Planner)

**职责**：生成行程骨架（景点顺序）

**MCP 工具**：
- `amap_mcp.search_poi(keywords, city)` - 确认景点存在
- `amap_mcp.geocode(address)` - 获取坐标

**输入**：
```typescript
interface PlannerInput {
  userRequest: TripFormData
  weatherContext: WeatherOutput
}
```

**输出**：
```typescript
interface DraftItinerary {
  days: DraftDay[]
  totalAttractions: number
  totalMeals: number
}

interface DraftDay {
  day: number
  date: string
  attractions: AttractionSlot[]  // 只有名称和时间，无详细信息
  mealSlots: MealSlot[]
}
```

**Prompt 核心**：
```
你是专业旅行规划师。根据用户需求和天气策略生成行程框架。

天气策略：{strategy_tags}
- 如果包含 "indoor_priority"：每天至少安排 1 个室内景点
- 如果包含 "hot_weather"：避免中午 12-14 点安排户外活动

输出景点顺序链表，考虑：
1. 地理位置相近性
2. 开放时间
3. 游玩时长
4. 餐饮时间合理性
```

---

### 4. 酒店专家 Agent (Accommodation Specialist)

**职责**：推荐住宿

**MCP 工具**：
- `amap_mcp.search_hotels(location, radius, keywords)`
- `amap_mcp.search_nearby(location, type: 'hotel')`

**智能逻辑**：
1. 计算每日行程的地理中心点 (Centroid)
2. 在中心点附近搜索酒店
3. 根据用户偏好过滤（安静、近地铁、价格）

**输出**：
```typescript
interface AccommodationResult {
  recommendations: HotelRecommendation[]
  totalCost: number
  centroidLocation: Location
}
```

---

### 5. 交通调度 Agent (Transport Logistician)

**职责**：计算交通路线和费用

**MCP 工具**：
- `amap_mcp.get_driving_route(origin, destination)`
- `amap_mcp.get_transit_route(origin, destination, city)`
- `amap_mcp.get_walking_route(origin, destination)`
- `amap_mcp.calculate_distance(origins, destinations)`

**输出**：
```typescript
interface TransportResult {
  segments: TransportSegment[]
  totalTime: number      // 分钟
  totalCost: number      // 元
  recommendedModes: TransportMode[]
}

interface TransportSegment {
  from: Location
  to: Location
  mode: 'driving' | 'transit' | 'walking'
  duration: number
  distance: number
  cost: number
  polyline?: string      // 路线轨迹
}
```

---

### 6. 预算审计 Agent (Budget Critic)

**职责**：后置校验，汇总成本

**工具**：无（纯计算逻辑）

**输入**：
```typescript
interface BudgetInput {
  userBudget: number
  accommodationCost: number
  transportCost: number
  mealCost: number
  attractionCost: number
  miscCost: number
}
```

**输出**：
```typescript
interface BudgetResult {
  totalCost: number
  budgetUtilization: number    // 0-1
  isWithinBudget: boolean
  feedback?: BudgetFeedback
}

interface BudgetFeedback {
  action: 'downgrade_hotel' | 'reduce_attractions' | 'cheaper_transport' | 'adjust_meals'
  targetReduction: number
  suggestion: string
}
```

**判定逻辑**：
```
IF Total > Budget * 1.1 THEN
  返回 feedback 触发反馈循环
ELSE
  通过审计
```

---

## MCP Server 设计

### 目录结构

```
mcp-servers/
└── amap/
    ├── package.json
    ├── tsconfig.json
    ├── src/
    │   ├── index.ts           # 入口
    │   ├── server.ts          # MCP Server 主类
    │   ├── tools/
    │   │   ├── weather.ts     # 天气查询
    │   │   ├── poi.ts         # POI 搜索
    │   │   ├── route.ts       # 路线规划
    │   │   ├── geocode.ts     # 地理编码
    │   │   └── distance.ts    # 距离计算
    │   ├── utils/
    │   │   ├── http.ts        # HTTP 请求封装
    │   │   └── transform.ts   # 数据转换
    │   └── types.ts           # 类型定义
    └── tests/
        └── *.test.ts
```

### 工具定义 Schema

```typescript
// 天气查询
const weatherTool = {
  name: 'get_weather_forecast',
  description: '获取城市天气预报（未来 3 天）',
  inputSchema: {
    type: 'object',
    properties: {
      city: { type: 'string', description: '城市名称' },
      date: { type: 'string', description: '查询日期 (YYYY-MM-DD)' }
    },
    required: ['city']
  }
}

// POI 搜索
const poiSearchTool = {
  name: 'search_poi',
  description: '关键词搜索 POI 地点',
  inputSchema: {
    type: 'object',
    properties: {
      keywords: { type: 'string', description: '搜索关键词' },
      city: { type: 'string', description: '城市名称' },
      types: { type: 'string', description: 'POI 类型代码' },
      page_size: { type: 'number', description: '返回数量', default: 10 }
    },
    required: ['keywords']
  }
}

// 路线规划
const drivingRouteTool = {
  name: 'get_driving_route',
  description: '获取驾车路线规划',
  inputSchema: {
    type: 'object',
    properties: {
      origin: { type: 'string', description: '起点坐标 (lng,lat)' },
      destination: { type: 'string', description: '终点坐标 (lng,lat)' },
      strategy: { type: 'number', description: '路线策略', default: 0 }
    },
    required: ['origin', 'destination']
  }
}
```

### 配置方式

**SSE 模式 (开发/测试)**：
```json
{
  "mcpServers": {
    "amap-sse": {
      "url": "http://localhost:3009/sse"
    }
  }
}
```

**Node.js stdio 模式 (生产)**：
```json
{
  "mcpServers": {
    "amap": {
      "command": "node",
      "args": ["./mcp-servers/amap/dist/index.js"],
      "env": {
        "AMAP_API_KEY": "${AMAP_WEB_SERVICE_KEY}"
      }
    }
  }
}
```

---

## 数据流与状态管理

### 共享状态结构

```typescript
interface SharedState {
  // 用户输入
  userInput: TripFormData

  // 环境上下文
  environment: {
    weather: WeatherOutput | null
    strategyTags: StrategyTag[]
  }

  // 草稿行程
  draftItinerary: DraftItinerary | null

  // 资源填充结果
  resources: {
    accommodation: AccommodationResult | null
    transport: TransportResult | null
    dining: DiningResult | null
  }

  // 预算审计
  budget: {
    result: BudgetResult | null
    feedbackHistory: BudgetFeedback[]
    retryCount: number
  }

  // 最终输出
  finalItinerary: Itinerary | null

  // 元信息
  meta: {
    startTime: number
    agentExecutions: AgentExecution[]
    errors: AgentError[]
  }
}

interface AgentExecution {
  agent: string
  startTime: number
  endTime: number
  status: 'success' | 'failed' | 'skipped'
  toolCalls: ToolCall[]
}
```

### 状态流转

```
Initial State
    │
    ▼ [Weather Scout]
State.environment.weather = {...}
State.environment.strategyTags = [...]
    │
    ▼ [Itinerary Planner]
State.draftItinerary = {...}
    │
    ▼ [Resource Agents - Parallel]
State.resources.accommodation = {...}
State.resources.transport = {...}
State.resources.dining = {...}
    │
    ▼ [Budget Critic]
State.budget.result = {...}
    │
    ├─► [Pass] → State.finalItinerary = {...}
    │
    └─► [Fail] → State.budget.feedbackHistory.push(feedback)
                State.budget.retryCount++
                → 返回 Orchestrator 重新调度
```

---

## 技术选型

### 核心依赖

| 用途 | 选型 | 理由 |
|------|------|------|
| **Agent 编排** | `@langchain/langgraph` | 状态图编排，原生循环/并行支持 |
| **LangChain 核心** | `@langchain/core` | LangGraph 依赖 |
| MCP SDK | `@modelcontextprotocol/sdk` | 官方 SDK，TypeScript 支持 |
| AI 调用 | `openai` (现有) | 兼容 DeepSeek/ModelScope |
| 检查点存储 | `MemorySaver` → `PostgresSaver` | 开发用内存，生产用 PG |
| HTTP 请求 | `node:https` (现有) | 绕过代理问题 |
| 测试 | `vitest` (现有) | 项目已配置 |

### 新增依赖安装

```bash
npm install @langchain/langgraph @langchain/core
# 可选：生产环境持久化
npm install @langchain/langgraph-checkpoint-postgres
```

### 文件结构

```
lib/
├── agents/                         # LangGraph Agent 模块
│   ├── state.ts                   # TripState Annotation 定义
│   ├── workflow.ts                # StateGraph 工作流定义
│   ├── mcp-client.ts              # MCP 客户端封装
│   ├── nodes/                     # Agent 节点函数
│   │   ├── weather-scout.ts
│   │   ├── itinerary-planner.ts
│   │   ├── accommodation.ts
│   │   ├── transport.ts
│   │   ├── dining.ts
│   │   ├── budget-critic.ts
│   │   └── finalize.ts
│   ├── prompts/                   # Agent System Prompts
│   │   ├── weather-scout.ts
│   │   ├── itinerary-planner.ts
│   │   └── ...
│   └── index.ts                   # 统一导出
│
mcp-servers/                        # MCP Server 独立项目
└── amap/
    ├── package.json
    ├── src/
    └── tests/
```

### LangGraph 与现有代码集成

```typescript
// lib/agents/nodes/weather-scout.ts
import { createAIClient } from '@/app/api/_utils/ai-helper';
import { getWeatherByCityName } from '@/lib/amap-weather';
import type { TripState } from '../state';

export async function weatherScoutAgent(
  state: TripState
): Promise<Partial<TripState>> {
  // 复用现有的天气 API 封装
  const weatherData = await getWeatherByCityName(state.userInput.destination);

  // 复用现有的 AI 客户端
  const aiClient = createAIClient({ apiKey, baseURL });

  // ... AI 分析逻辑

  return { weather: result };
}
```

---

## 风险与挑战

### 技术风险

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| LangGraph 学习曲线 | 开发速度下降 | 参考官方教程，从简单流程开始 |
| MCP 协议复杂度 | 集成困难 | 参考官方示例，逐步实现 |
| Agent 执行时间长 | 用户体验差 | 使用 `stream()` + SSE 进度反馈 |
| 反馈循环死循环 | 无法生成结果 | 限制 `retryCount <= 3` |
| 高德 API 限流 | 请求失败 | 添加请求间隔 + 重试机制 |
| 依赖体积增加 | 构建变慢 | LangGraph 仅服务端使用，不影响前端 |

### LangGraph 特定注意事项

1. **状态不可变性**：使用 Annotation reducer 确保状态正确合并
2. **并行节点等待**：Fan-in 节点需等待所有上游节点完成
3. **类型安全**：使用 TypeScript 泛型确保状态类型正确
4. **调试**：使用 `console.log` 或 LangSmith 追踪执行流程

### 兼容性考虑

1. **向后兼容**：保留 `/api/generate-itinerary` 原有实现
2. **渐进迁移**：使用 Feature Flag 控制新架构启用
3. **降级策略**：新架构失败时回退到单体调用

---

## 进度追踪

### Phase 1: MCP 基础设施
| 任务 | 状态 | 完成日期 |
|------|------|----------|
| 1.1 创建 MCP Server 项目结构 | [x] | 2025-11-26 |
| 1.2 实现天气查询工具 | [x] | 2025-11-26 |
| 1.3 实现 POI 搜索工具 | [x] | 2025-11-26 |
| 1.4 实现路线规划工具 | [x] | 2025-11-26 |
| 1.5 实现地理编码工具 | [x] | 2025-11-26 |
| 1.6 实现距离计算工具 | [x] | 2025-11-26 |
| 1.7 编写单元测试 | [x] | 2025-11-26 |
| 1.8 配置连接模式 | [x] | 2025-11-26 |
| 1.9 编写文档 | [x] | 2025-11-26 |

### Phase 2: LangGraph 框架搭建
| 任务 | 状态 | 完成日期 |
|------|------|----------|
| 2.1 安装 LangGraph 依赖 | [x] | 2025-11-26 |
| 2.2 定义 TripState Annotation | [x] | 2025-11-26 |
| 2.3 创建 StateGraph 工作流 | [x] | 2025-11-26 |
| 2.4 实现 MCP 客户端封装 | [x] | 2025-11-26 |
| 2.5 实现线性流程 | [x] | 2025-11-26 |
| 2.6 添加条件边和循环边 | [x] | 2025-11-26 |
| 2.7 实现并行节点 | [x] | 2025-11-26 |
| 2.8 配置 Checkpointer | [x] | 2025-11-26 |
| 2.9 编写工作流测试 | [ ] | - |

### Phase 3: 专家 Agent 实现
| 任务 | 状态 | 完成日期 |
|------|------|----------|
| 3.1 Weather Scout Agent | [x] | 2025-11-26 |
| 3.2 Itinerary Planner Agent | [x] | 2025-11-26 |
| 3.3 Accommodation Agent | [x] | 2025-11-26 |
| 3.4 Transport Agent | [x] | 2025-11-26 |
| 3.5 Dining Agent | [x] | 2025-11-26 |
| 3.6 Budget Critic Agent | [x] | 2025-11-26 |
| 3.7 Finalize Agent | [x] | 2025-11-26 |
| 3.8 编写 Agent Prompts | [x] | 2025-11-26 |
| 3.9 编写 Agent 测试 | [ ] | - |

### Phase 4: API 集成与迁移
| 任务 | 状态 | 完成日期 |
|------|------|----------|
| 4.1 创建 v2 API | [x] | 2025-11-27 |
| 4.2 集成 LangGraph 工作流 | [x] | 2025-11-27 |
| 4.3 Feature Flag | [x] | 2025-11-27 |
| 4.4 SSE 流式响应 | [x] | 2025-11-27 |
| 4.5 更新前端 | [x] | 2025-11-27 |
| 4.6 进度 UI 组件 | [x] | 2025-11-27 |
| 4.7 集成测试 | [x] | 2025-11-27 |
| 4.8 性能测试 | [ ] | - (延后到 Phase 5) |

### Phase 5: 优化与扩展
| 任务 | 状态 | 完成日期 |
|------|------|----------|
| 5.1 结果缓存 | [ ] | - |
| 5.2 PostgreSQL Checkpointer | [ ] | - |
| 5.3 LangGraph Tracing | [ ] | - |
| 5.4 指标监控 | [ ] | - |
| 5.5 工作流可视化 | [ ] | - |
| 5.6 扩展 Agent | [ ] | - |
| 5.7 优化文档 | [ ] | - |
| 5.8 更新 README | [ ] | - |
| 5.9 E2E 测试 | [ ] | - |

---

## 参考资源

### LangGraph 学习资源
- [LangGraph 官方文档](https://langchain-ai.github.io/langgraph/)
- [LangGraph 快速入门](https://langchain-ai.github.io/langgraph/tutorials/introduction/)
- [LangGraph TypeScript API](https://langchain-ai.github.io/langgraphjs/)
- [LangGraph 状态图概念](https://langchain-ai.github.io/langgraph/concepts/)
- [LangGraph 检查点与持久化](https://langchain-ai.github.io/langgraph/concepts/persistence/)

### MCP 相关资源
- [Model Context Protocol 官方文档](https://modelcontextprotocol.io/)
- [高德地图 MCP Server 教程](https://blog.csdn.net/Dontla/article/details/147577827)
- [高德地图 Web 服务 API](https://lbs.amap.com/api/webservice/summary)
- [MCP 开发实战教程](https://www.cnblogs.com/hogwarts/p/19050887)

### 其他资源
- [LangSmith 追踪平台](https://smith.langchain.com/)
- [高德开放平台控制台](https://console.amap.com/)

---

*最后更新: 2025-11-27*
*技术选型: LangGraph + MCP*
*Phase 1 完成: 2025-11-26*
*Phase 2 完成: 2025-11-26*
*Phase 3 完成: 2025-11-26*
*Phase 4 完成: 2025-11-27*
