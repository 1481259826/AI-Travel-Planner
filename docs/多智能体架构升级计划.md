# å¤šæ™ºèƒ½ä½“æ¶æ„å‡çº§è®¡åˆ’

> åŸºäº LangGraph + MCP åè®®çš„åœ°ç†ç©ºé—´æ„ŸçŸ¥å¤šæ™ºèƒ½ä½“åä½œç³»ç»Ÿ
> (Geospatially Aware Multi-Agent System via LangGraph & Model Context Protocol)

**åˆ›å»ºæ—¥æœŸ**: 2025-11-26
**çŠ¶æ€**: è§„åˆ’ä¸­
**æ ¸å¿ƒæ¡†æ¶**: LangGraph (çŠ¶æ€å›¾ç¼–æ’) + MCP (å·¥å…·è°ƒç”¨åè®®)
**é¢„è®¡å®Œæˆ**: åˆ† 5 ä¸ªé˜¶æ®µå®æ–½

---

## ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
2. [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
3. [LangGraph æ ¸å¿ƒè®¾è®¡](#langgraph-æ ¸å¿ƒè®¾è®¡)
4. [å®æ–½é˜¶æ®µ](#å®æ–½é˜¶æ®µ)
5. [Agent è¯¦ç»†è®¾è®¡](#agent-è¯¦ç»†è®¾è®¡)
6. [MCP Server è®¾è®¡](#mcp-server-è®¾è®¡)
7. [æ•°æ®æµä¸çŠ¶æ€ç®¡ç†](#æ•°æ®æµä¸çŠ¶æ€ç®¡ç†)
8. [æŠ€æœ¯é€‰å‹](#æŠ€æœ¯é€‰å‹)
9. [é£é™©ä¸æŒ‘æˆ˜](#é£é™©ä¸æŒ‘æˆ˜)
10. [è¿›åº¦è¿½è¸ª](#è¿›åº¦è¿½è¸ª)

---

## é¡¹ç›®æ¦‚è¿°

### å½“å‰æ¶æ„

é¡¹ç›®å½“å‰é‡‡ç”¨å•ä½“ AI è°ƒç”¨æ¶æ„ï¼š
- ç”¨æˆ·æäº¤è¡¨å• â†’ å•æ¬¡ AI è°ƒç”¨ç”Ÿæˆå®Œæ•´è¡Œç¨‹ â†’ åæ ‡ä¿®æ­£ â†’ åœ°ç†èšç±»ä¼˜åŒ– â†’ ä¿å­˜

**ç°æœ‰æ¨¡å—**ï¼š
- `lib/amap-weather.ts` - å¤©æ°” API é›†æˆ
- `lib/geo-clustering.ts` - åœ°ç†èšç±»ä¼˜åŒ–
- `app/api/_utils/ai-helper.ts` - AI è°ƒç”¨å°è£…
- `app/api/_utils/coordinate-fixer.ts` - åæ ‡ä¿®æ­£
- `app/api/enrich-attraction/` - æ™¯ç‚¹ä¿¡æ¯å¢å¼º
- `app/api/enrich-hotel/` - é…’åº—ä¿¡æ¯å¢å¼º

### ç›®æ ‡æ¶æ„

å‡çº§ä¸º **LangGraph é©±åŠ¨çš„å¤šæ™ºèƒ½ä½“åä½œç³»ç»Ÿ**ï¼š

**ç¼–æ’å±‚ (LangGraph StateGraph)**ï¼š
- ä½¿ç”¨ LangGraph çŠ¶æ€å›¾å®šä¹‰ Agent æ‰§è¡Œæµç¨‹
- èŠ‚ç‚¹ (Node) = Agentï¼Œè¾¹ (Edge) = çŠ¶æ€è½¬ç§»
- åŸç”Ÿæ”¯æŒæ¡ä»¶åˆ†æ”¯ã€å¾ªç¯ã€å¹¶è¡Œæ‰§è¡Œ

**ä¸“å®¶ Agent å±‚**ï¼š
- **å¤©æ°”æ„ŸçŸ¥ Agent (Weather Scout)** - ç¯å¢ƒä¸Šä¸‹æ–‡ç”Ÿæˆ
- **æ ¸å¿ƒè§„åˆ’ Agent (Itinerary Planner)** - è¡Œç¨‹éª¨æ¶ç”Ÿæˆ
- **é…’åº—ä¸“å®¶ Agent (Accommodation Specialist)** - ä½å®¿æ¨è
- **äº¤é€šè°ƒåº¦ Agent (Transport Logistician)** - è·¯çº¿è§„åˆ’
- **é¤é¥®æ¨è Agent (Dining Recommender)** - é¤å…æ¨è
- **é¢„ç®—å®¡è®¡ Agent (Budget Critic)** - æˆæœ¬æ ¡éªŒ

**å·¥å…·å±‚ (MCP Infrastructure)**ï¼š
- æ‰€æœ‰å¤–éƒ¨ API è°ƒç”¨é€šè¿‡ **AMap MCP Server** ç»Ÿä¸€ç®¡ç†

### æ¶æ„ä¼˜åŠ¿

1. **LangGraph çŠ¶æ€å›¾** - å¯è§†åŒ–æ‰§è¡Œæµç¨‹ï¼Œæ˜“äºç†è§£å’Œè°ƒè¯•
2. **åŸç”Ÿå¾ªç¯æ”¯æŒ** - é¢„ç®—è¶…æ”¯è‡ªåŠ¨è§¦å‘é‡æ–°è§„åˆ’ï¼Œæ— éœ€æ‰‹åŠ¨å®ç°
3. **å¹¶è¡Œæ‰§è¡Œ** - èµ„æºç±» Agent ä½¿ç”¨å¹¶è¡ŒèŠ‚ç‚¹åŒæ—¶æ‰§è¡Œ
4. **æ£€æŸ¥ç‚¹æŒä¹…åŒ–** - å†…ç½®çŠ¶æ€æŒä¹…åŒ–ï¼Œæ”¯æŒé•¿ä»»åŠ¡ä¸­æ–­æ¢å¤
5. **èŒè´£åˆ†ç¦»** - æ¯ä¸ª Agent ä¸“æ³¨å•ä¸€é¢†åŸŸ
6. **MCP æ ‡å‡†åŒ–** - å·¥å…·è°ƒç”¨ç»Ÿä¸€åè®®ï¼Œæ˜“äºæ‰©å±•

---

## æ¶æ„è®¾è®¡

### ç³»ç»Ÿåˆ†å±‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ç”¨æˆ·å±‚ (User Layer)                     â”‚
â”‚                   Next.js å‰ç«¯ + API Routes                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               ç¼–æ’å±‚ (LangGraph StateGraph)                  â”‚
â”‚                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚   â”‚ Weather â”‚â”€â”€â”€â–ºâ”‚ Planner â”‚â”€â”€â”€â–ºâ”‚Resource â”‚               â”‚
â”‚   â”‚  Scout  â”‚    â”‚         â”‚    â”‚ Agents  â”‚               â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜               â”‚
â”‚                                      â”‚                      â”‚
â”‚                                      â–¼                      â”‚
â”‚                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚                               â”‚ Budget  â”‚â”€â”€â”                â”‚
â”‚                               â”‚ Critic  â”‚  â”‚ è¶…é¢„ç®—?        â”‚
â”‚                               â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â”‚                â”‚
â”‚                                    â”‚       â”‚                â”‚
â”‚                          é€šè¿‡ â—„â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜ é‡è¯•å¾ªç¯       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â–¼                 â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ä¸“å®¶ Agent     â”‚ â”‚   ä¸“å®¶ Agent     â”‚ â”‚   ä¸“å®¶ Agent     â”‚
â”‚  Accommodation  â”‚ â”‚    Transport    â”‚ â”‚     Dining      â”‚
â”‚   Specialist    â”‚ â”‚   Logistician   â”‚ â”‚   Recommender   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  å·¥å…·å±‚ (MCP Infrastructure)                 â”‚
â”‚                     AMap MCP Server                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ å¤©æ°”æŸ¥è¯¢  â”‚ â”‚ POIæœç´¢  â”‚ â”‚ è·¯çº¿è§„åˆ’  â”‚ â”‚ åœ°ç†ç¼–ç   â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµ

```
ç”¨æˆ·è¾“å…¥
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Orchestrator     â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åˆå§‹åŒ–å…±äº«çŠ¶æ€     â”‚                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
    â”‚                                                       â”‚
    â–¼                                                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
â”‚  Weather Scout    â”‚                                       â”‚
â”‚  è·å–å¤©æ°” + ç­–ç•¥   â”‚                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
    â”‚ strategy_tags                                         â”‚
    â–¼                                                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
â”‚ Itinerary Planner â”‚                                       â”‚
â”‚  ç”Ÿæˆè¡Œç¨‹éª¨æ¶      â”‚                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
    â”‚ draft_itinerary                                       â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
    â–¼                  â–¼                  â–¼                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  Hotel   â”‚    â”‚Transport â”‚    â”‚  Dining  â”‚    å¹¶è¡Œæ‰§è¡Œ    â”‚
â”‚ Agent    â”‚    â”‚  Agent   â”‚    â”‚  Agent   â”‚               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
    â”‚                  â”‚                  â”‚                 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
                       â”‚ enriched_data                      â”‚
                       â–¼                                    â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
              â”‚  Budget Critic    â”‚                         â”‚
              â”‚  é¢„ç®—å®¡è®¡          â”‚                         â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
                       â”‚                                    â”‚
                       â–¼                                    â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    è¶…é¢„ç®—?              â”‚
              â”‚     åˆ¤æ–­æ˜¯å¦      â”‚ â”€â”€â”€â”€Yesâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
              â”‚     é€šè¿‡å®¡è®¡      â”‚      feedback_loop      â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
                       â”‚ No                                 â”‚
                       â–¼                                    â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  æœ€ç»ˆè¡Œç¨‹è¾“å‡º      â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## LangGraph æ ¸å¿ƒè®¾è®¡

### ä¸ºä»€ä¹ˆé€‰æ‹© LangGraph

| éœ€æ±‚ | æ‰‹åŠ¨å®ç° | LangGraph |
|------|---------|-----------|
| å¤š Agent åä½œ | è‡ªå·±å†™è°ƒåº¦é€»è¾‘ | StateGraph èŠ‚ç‚¹ç¼–æ’ |
| é¢„ç®—è¶…æ”¯é‡è¯• | while å¾ªç¯ + çŠ¶æ€ç®¡ç† | æ¡ä»¶è¾¹ + å¾ªç¯è¾¹ |
| å¹¶è¡Œæ‰§è¡Œ | Promise.all | å¹¶è¡ŒèŠ‚ç‚¹ (Fan-out/Fan-in) |
| çŠ¶æ€ä¼ é€’ | æ‰‹åŠ¨ç®¡ç†å¯¹è±¡ | å†…ç½® State Channel |
| æ‰§è¡Œè¿½è¸ª | è‡ªå·±å®ç°æ—¥å¿— | å†…ç½® Tracing |
| ä¸­æ–­æ¢å¤ | å¤æ‚ | å†…ç½® Checkpointer |

### çŠ¶æ€å›¾å®šä¹‰

```typescript
import { StateGraph, END, START } from "@langchain/langgraph";
import { Annotation } from "@langchain/langgraph";

// 1. å®šä¹‰å…±äº«çŠ¶æ€ Schema (ä½¿ç”¨ Annotation)
const TripStateAnnotation = Annotation.Root({
  // ç”¨æˆ·è¾“å…¥
  userInput: Annotation<TripFormData>,

  // å¤©æ°”ä¸Šä¸‹æ–‡
  weather: Annotation<WeatherOutput | null>({
    default: () => null,
    reducer: (_, new_val) => new_val,
  }),

  // è¡Œç¨‹è‰ç¨¿
  draftItinerary: Annotation<DraftItinerary | null>({
    default: () => null,
    reducer: (_, new_val) => new_val,
  }),

  // èµ„æºæ•°æ® (å¹¶è¡Œ Agent ç»“æœåˆå¹¶)
  accommodation: Annotation<AccommodationResult | null>({
    default: () => null,
  }),
  transport: Annotation<TransportResult | null>({
    default: () => null,
  }),
  dining: Annotation<DiningResult | null>({
    default: () => null,
  }),

  // é¢„ç®—å®¡è®¡
  budgetResult: Annotation<BudgetResult | null>({
    default: () => null,
  }),
  retryCount: Annotation<number>({
    default: () => 0,
    reducer: (current, delta) => current + delta,
  }),

  // æœ€ç»ˆè¾“å‡º
  finalItinerary: Annotation<Itinerary | null>({
    default: () => null,
  }),
});

type TripState = typeof TripStateAnnotation.State;
```

### å·¥ä½œæµæ„å»º

```typescript
// 2. åˆ›å»ºçŠ¶æ€å›¾
const workflow = new StateGraph(TripStateAnnotation);

// 3. æ·»åŠ èŠ‚ç‚¹ (æ¯ä¸ªèŠ‚ç‚¹æ˜¯ä¸€ä¸ª Agent å‡½æ•°)
workflow
  .addNode("weather_scout", weatherScoutAgent)
  .addNode("itinerary_planner", itineraryPlannerAgent)
  .addNode("accommodation", accommodationAgent)
  .addNode("transport", transportAgent)
  .addNode("dining", diningAgent)
  .addNode("budget_critic", budgetCriticAgent)
  .addNode("finalize", finalizeAgent);

// 4. å®šä¹‰è¾¹ (æ‰§è¡Œé¡ºåº)
workflow
  // å…¥å£ â†’ å¤©æ°”
  .addEdge(START, "weather_scout")
  // å¤©æ°” â†’ è§„åˆ’
  .addEdge("weather_scout", "itinerary_planner")
  // è§„åˆ’ â†’ èµ„æº (å¹¶è¡Œæ‰‡å‡º)
  .addEdge("itinerary_planner", "accommodation")
  .addEdge("itinerary_planner", "transport")
  .addEdge("itinerary_planner", "dining")
  // èµ„æº â†’ é¢„ç®— (æ‰‡å…¥æ±‡åˆ)
  .addEdge("accommodation", "budget_critic")
  .addEdge("transport", "budget_critic")
  .addEdge("dining", "budget_critic");

// 5. æ¡ä»¶è¾¹ï¼šé¢„ç®—å®¡è®¡åçš„å†³ç­–
workflow.addConditionalEdges(
  "budget_critic",
  (state: TripState) => {
    // é€šè¿‡å®¡è®¡
    if (state.budgetResult?.isWithinBudget) {
      return "finalize";
    }
    // è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œå¼ºåˆ¶ç»“æŸ
    if (state.retryCount >= 3) {
      return "finalize";
    }
    // è¶…é¢„ç®—ï¼Œè¿”å›é‡æ–°è§„åˆ’
    return "retry";
  },
  {
    finalize: "finalize",
    retry: "itinerary_planner",  // å¾ªç¯å›è§„åˆ’èŠ‚ç‚¹
  }
);

// 6. ç»“æŸè¾¹
workflow.addEdge("finalize", END);

// 7. ç¼–è¯‘å·¥ä½œæµ
const app = workflow.compile();
```

### Agent èŠ‚ç‚¹å®ç°ç¤ºä¾‹

```typescript
/**
 * å¤©æ°”æ„ŸçŸ¥ Agent
 * è°ƒç”¨ MCP å·¥å…·è·å–å¤©æ°”ï¼Œè¾“å‡ºç­–ç•¥æ ‡ç­¾
 */
async function weatherScoutAgent(state: TripState): Promise<Partial<TripState>> {
  const { userInput } = state;

  // è°ƒç”¨ MCP å·¥å…·è·å–å¤©æ°”
  const weatherData = await mcpClient.callTool("get_weather_forecast", {
    city: userInput.destination,
  });

  // è°ƒç”¨ AI åˆ†æå¤©æ°”ï¼Œç”Ÿæˆç­–ç•¥æ ‡ç­¾
  const aiClient = createAIClient({ apiKey, baseURL });
  const analysis = await aiClient.chat.completions.create({
    model: "deepseek-chat",
    messages: [{
      role: "system",
      content: WEATHER_SCOUT_PROMPT,
    }, {
      role: "user",
      content: JSON.stringify(weatherData),
    }],
  });

  const weather = JSON.parse(analysis.choices[0].message.content);

  // è¿”å›çŠ¶æ€æ›´æ–° (åªè¿”å›è¦æ›´æ–°çš„å­—æ®µ)
  return { weather };
}

/**
 * é¢„ç®—å®¡è®¡ Agent
 * æ±‡æ€»æˆæœ¬ï¼Œåˆ¤æ–­æ˜¯å¦é€šè¿‡
 */
async function budgetCriticAgent(state: TripState): Promise<Partial<TripState>> {
  const { userInput, accommodation, transport, dining, draftItinerary } = state;

  // æ±‡æ€»æˆæœ¬
  const totalCost =
    (accommodation?.totalCost || 0) +
    (transport?.totalCost || 0) +
    (dining?.totalCost || 0) +
    (draftItinerary?.estimatedAttractionCost || 0);

  const isWithinBudget = totalCost <= userInput.budget * 1.1; // å…è®¸ 10% æº¢ä»·

  const budgetResult: BudgetResult = {
    totalCost,
    budgetUtilization: totalCost / userInput.budget,
    isWithinBudget,
    feedback: isWithinBudget ? undefined : {
      action: "downgrade_hotel",
      targetReduction: totalCost - userInput.budget,
      suggestion: "å»ºè®®é€‰æ‹©æ›´ç»æµçš„ä½å®¿",
    },
  };

  return {
    budgetResult,
    retryCount: isWithinBudget ? 0 : 1, // è§¦å‘ reducer ç´¯åŠ 
  };
}
```

### æ‰§è¡Œå·¥ä½œæµ

```typescript
// åœ¨ API Route ä¸­è°ƒç”¨
export async function POST(request: NextRequest) {
  const formData = await request.json();

  // åˆå§‹çŠ¶æ€
  const initialState = {
    userInput: formData,
  };

  // æ‰§è¡Œå·¥ä½œæµ
  const result = await app.invoke(initialState);

  // è¿”å›æœ€ç»ˆè¡Œç¨‹
  return Response.json({
    success: true,
    data: result.finalItinerary,
  });
}
```

### æµå¼æ‰§è¡Œä¸è¿›åº¦åé¦ˆ

```typescript
// ä½¿ç”¨ stream æ–¹æ³•è·å–å®æ—¶è¿›åº¦
const stream = await app.stream(initialState);

for await (const event of stream) {
  // event åŒ…å«å½“å‰æ‰§è¡Œçš„èŠ‚ç‚¹å’ŒçŠ¶æ€æ›´æ–°
  console.log("Current node:", event);

  // å¯ä»¥é€šè¿‡ SSE æ¨é€ç»™å‰ç«¯
  // res.write(`data: ${JSON.stringify(event)}\n\n`);
}
```

### æ£€æŸ¥ç‚¹ä¸ä¸­æ–­æ¢å¤

```typescript
import { MemorySaver } from "@langchain/langgraph";

// æ·»åŠ æ£€æŸ¥ç‚¹å­˜å‚¨
const checkpointer = new MemorySaver();
const app = workflow.compile({ checkpointer });

// æ‰§è¡Œæ—¶æŒ‡å®š thread_id
const config = { configurable: { thread_id: "trip-123" } };
const result = await app.invoke(initialState, config);

// å¦‚æœä¸­æ–­ï¼Œå¯ä»¥ä»æ£€æŸ¥ç‚¹æ¢å¤
const resumedResult = await app.invoke(null, config);
```

---

## å®æ–½é˜¶æ®µ

### Phase 1: MCP åŸºç¡€è®¾æ–½æ­å»º
**çŠ¶æ€**: [x] å·²å®Œæˆ (2025-11-26)

#### ç›®æ ‡
- æ­å»º AMap MCP Server
- å®ç°æ ¸å¿ƒ MCP å·¥å…·é›†
- æœ¬åœ°è°ƒè¯•éªŒè¯

#### ä»»åŠ¡æ¸…å•
- [x] 1.1 åˆ›å»º MCP Server é¡¹ç›®ç»“æ„ (`mcp-servers/amap/`)
- [x] 1.2 å®ç°å¤©æ°”æŸ¥è¯¢å·¥å…· (`get_weather_forecast`)
- [x] 1.3 å®ç° POI æœç´¢å·¥å…· (`search_poi`, `search_nearby`)
- [x] 1.4 å®ç°è·¯çº¿è§„åˆ’å·¥å…· (`get_driving_route`, `get_transit_route`, `get_walking_route`)
- [x] 1.5 å®ç°åœ°ç†ç¼–ç å·¥å…· (`geocode`, `reverse_geocode`)
- [x] 1.6 å®ç°è·ç¦»è®¡ç®—å·¥å…· (`calculate_distance`)
- [x] 1.7 ç¼–å†™ MCP Server å•å…ƒæµ‹è¯•
- [x] 1.8 é…ç½® SSE/stdio ä¸¤ç§è¿æ¥æ¨¡å¼
- [x] 1.9 ç¼–å†™ MCP Server æ–‡æ¡£

#### æŠ€æœ¯è¦ç‚¹
- ä½¿ç”¨ `@modelcontextprotocol/sdk` å®˜æ–¹ SDK
- æ”¯æŒ SSE æ¨¡å¼ (å¼€å‘) å’Œ stdio æ¨¡å¼ (ç”Ÿäº§)
- å¤ç”¨ç°æœ‰çš„ `lib/amap-weather.ts` é€»è¾‘

#### å®Œæˆæƒ…å†µ
å·²å®Œæˆ AMap MCP Server çš„å®Œæ•´å®ç°ï¼Œä½äº `mcp-servers/amap/` ç›®å½•ï¼š
- 9 ä¸ª MCP å·¥å…·ï¼šå¤©æ°”æŸ¥è¯¢ã€POI æœç´¢ã€å‘¨è¾¹æœç´¢ã€é©¾è½¦è·¯çº¿ã€æ­¥è¡Œè·¯çº¿ã€å…¬äº¤è·¯çº¿ã€åœ°ç†ç¼–ç ã€é€†åœ°ç†ç¼–ç ã€è·ç¦»è®¡ç®—
- å®Œæ•´çš„ TypeScript ç±»å‹å®šä¹‰
- 24 ä¸ªå•å…ƒæµ‹è¯•å…¨éƒ¨é€šè¿‡
- æ”¯æŒ stdio å’Œ SSE ä¸¤ç§è¿æ¥æ¨¡å¼
- è¯¦ç»†çš„ README æ–‡æ¡£

---

### Phase 2: LangGraph æ¡†æ¶æ­å»º
**çŠ¶æ€**: [x] å·²å®Œæˆ (2025-11-26)

#### ç›®æ ‡
- å®‰è£…é…ç½® LangGraph
- å®šä¹‰çŠ¶æ€ Schema
- æ„å»ºå·¥ä½œæµå›¾
- å®ç°åŸºç¡€ Agent èŠ‚ç‚¹

#### ä»»åŠ¡æ¸…å•
- [x] 2.1 å®‰è£… LangGraph ä¾èµ– (`@langchain/langgraph`, `@langchain/core`)
- [x] 2.2 å®šä¹‰ TripState Annotation Schema (`lib/agents/state.ts`)
- [x] 2.3 åˆ›å»º StateGraph å·¥ä½œæµ (`lib/agents/workflow.ts`)
- [x] 2.4 å®ç° MCP å®¢æˆ·ç«¯å°è£… (`lib/agents/mcp-client.ts`)
- [x] 2.5 å®ç°ç®€å•çš„çº¿æ€§æµç¨‹ (Weather â†’ Planner â†’ End)
- [x] 2.6 æ·»åŠ æ¡ä»¶è¾¹å’Œå¾ªç¯è¾¹ (Budget é‡è¯•)
- [x] 2.7 å®ç°å¹¶è¡ŒèŠ‚ç‚¹ (Resource Agents Fan-out/Fan-in)
- [x] 2.8 é…ç½® Checkpointer æ£€æŸ¥ç‚¹å­˜å‚¨
- [ ] 2.9 ç¼–å†™å·¥ä½œæµå•å…ƒæµ‹è¯•

#### æŠ€æœ¯è¦ç‚¹
- ä½¿ç”¨ `Annotation.Root` å®šä¹‰ç±»å‹å®‰å…¨çš„çŠ¶æ€
- ä½¿ç”¨ `addConditionalEdges` å®ç°é¢„ç®—å®¡è®¡å†³ç­–
- å¹¶è¡ŒèŠ‚ç‚¹ï¼šä» Planner å‘å‡ºå¤šæ¡è¾¹åˆ°èµ„æº Agent
- çŠ¶æ€æ›´æ–°ä½¿ç”¨ Partial è¿”å›ï¼ŒLangGraph è‡ªåŠ¨åˆå¹¶

#### å®Œæˆæƒ…å†µ
å·²å®Œæˆ LangGraph æ¡†æ¶çš„å®Œæ•´æ­å»ºï¼Œä½äº `lib/agents/` ç›®å½•ï¼š
- **çŠ¶æ€å®šä¹‰** (`state.ts`): å®Œæ•´çš„ TripState Annotationï¼ŒåŒ…å«å¤©æ°”ã€è‰ç¨¿è¡Œç¨‹ã€èµ„æºæ•°æ®ã€é¢„ç®—å®¡è®¡ç­‰æ‰€æœ‰çŠ¶æ€å­—æ®µ
- **å·¥ä½œæµå®šä¹‰** (`workflow.ts`): StateGraph å·¥ä½œæµï¼ŒåŒ…å«æ‰€æœ‰ Agent èŠ‚ç‚¹ã€è¾¹å®šä¹‰ã€æ¡ä»¶è¾¹ã€å¹¶è¡Œæ‰§è¡Œã€æ£€æŸ¥ç‚¹é…ç½®
- **MCP å®¢æˆ·ç«¯** (`mcp-client.ts`): å°è£…æ‰€æœ‰é«˜å¾·åœ°å›¾ API è°ƒç”¨ï¼ŒåŒ…å«å¤©æ°”ã€POI æœç´¢ã€è·¯çº¿è§„åˆ’ã€åœ°ç†ç¼–ç ã€è·ç¦»è®¡ç®—ç­‰ 9 ä¸ªå·¥å…·
- **ç»Ÿä¸€å¯¼å‡º** (`index.ts`): ç»Ÿä¸€çš„æ¨¡å—å¯¼å‡ºæ¥å£

**æ³¨**: Agent èŠ‚ç‚¹å‡½æ•°ç›®å‰ä¸ºå ä½ç¬¦å®ç°ï¼Œå®Œæ•´çš„ AI é€»è¾‘å°†åœ¨ Phase 3 å®ç°

---

### Phase 3: ä¸“å®¶ Agent å®ç°
**çŠ¶æ€**: [x] å·²å®Œæˆ (2025-11-26)

#### ç›®æ ‡
- å®ç°æ‰€æœ‰ä¸“å®¶ Agent èŠ‚ç‚¹å‡½æ•°
- é›†æˆ MCP å·¥å…·è°ƒç”¨
- ç¼–å†™ Agent Prompts

#### ä»»åŠ¡æ¸…å•
- [x] 3.1 å®ç° Weather Scout Agent (`lib/agents/nodes/weather-scout.ts`)
- [x] 3.2 å®ç° Itinerary Planner Agent (`lib/agents/nodes/itinerary-planner.ts`)
- [x] 3.3 å®ç° Accommodation Specialist Agent (`lib/agents/nodes/accommodation.ts`)
- [x] 3.4 å®ç° Transport Logistician Agent (`lib/agents/nodes/transport.ts`)
- [x] 3.5 å®ç° Dining Recommender Agent (`lib/agents/nodes/dining.ts`)
- [x] 3.6 å®ç° Budget Critic Agent (`lib/agents/nodes/budget-critic.ts`)
- [x] 3.7 å®ç° Finalize Agent (æ±‡æ€»è¾“å‡º) (`lib/agents/nodes/finalize.ts`)
- [x] 3.8 ç¼–å†™å„ Agent çš„ System Prompts (`lib/agents/prompts/`)
- [ ] 3.9 ç¼–å†™å„ Agent å•å…ƒæµ‹è¯•

#### æŠ€æœ¯è¦ç‚¹
- æ¯ä¸ª Agent æ˜¯ä¸€ä¸ª `async (state: TripState) => Partial<TripState>` å‡½æ•°
- Agent å†…éƒ¨å¯è°ƒç”¨ MCP å·¥å…·å’Œ AI æ¨¡å‹
- Prompt è®¾è®¡è¦æ˜ç¡®è¾“å…¥è¾“å‡ºæ ¼å¼
- å¤ç”¨ç°æœ‰ `createAIClient` å‡½æ•°

#### å®Œæˆæƒ…å†µ
å·²å®Œæˆæ‰€æœ‰ä¸“å®¶ Agent çš„å®ç°ï¼Œä½äº `lib/agents/nodes/` ç›®å½•ï¼š

**Agent èŠ‚ç‚¹**ï¼š
- `weather-scout.ts`: å¤©æ°”æ„ŸçŸ¥ Agentï¼Œè·å–å¤©æ°”é¢„æŠ¥å¹¶ç”Ÿæˆç­–ç•¥æ ‡ç­¾
- `itinerary-planner.ts`: æ ¸å¿ƒè§„åˆ’ Agentï¼Œç”Ÿæˆè¡Œç¨‹éª¨æ¶
- `accommodation.ts`: ä½å®¿ä¸“å®¶ Agentï¼Œæ¨èé…’åº—
- `transport.ts`: äº¤é€šè°ƒåº¦ Agentï¼Œè®¡ç®—è·¯çº¿å’Œè´¹ç”¨
- `dining.ts`: é¤é¥®æ¨è Agentï¼Œæ¨èé¤å…
- `budget-critic.ts`: é¢„ç®—å®¡è®¡ Agentï¼Œæ±‡æ€»æˆæœ¬åˆ¤æ–­æ˜¯å¦é€šè¿‡
- `finalize.ts`: æ±‡æ€»è¾“å‡º Agentï¼Œæ•´åˆæ‰€æœ‰æ•°æ®ç”Ÿæˆæœ€ç»ˆè¡Œç¨‹

**Agent Prompts**ï¼ˆ`lib/agents/prompts/`ï¼‰ï¼š
- æ¯ä¸ª Agent éƒ½æœ‰å¯¹åº”çš„ System Prompt
- åŒ…å«è¾“å…¥è¾“å‡ºæ ¼å¼è¯´æ˜
- æä¾›ç”¨æˆ·æ¶ˆæ¯æ„å»ºå‡½æ•°

**ç‰¹æ€§**ï¼š
- æ”¯æŒè‡ªå®šä¹‰ AI é…ç½®ï¼ˆapiKey, baseURL, modelï¼‰
- é›†æˆ MCP å®¢æˆ·ç«¯è·å–å®æ—¶æ•°æ®
- æ”¯æŒé¢„ç®—è¶…æ”¯è‡ªåŠ¨é‡è¯•
- å®Œæ•´çš„ç±»å‹å®šä¹‰å’Œé”™è¯¯å¤„ç†

---

### Phase 4: API é›†æˆä¸è¿ç§»
**çŠ¶æ€**: [x] å·²å®Œæˆ (2025-11-27)

#### ç›®æ ‡
- é‡æ„ç°æœ‰ API ä½¿ç”¨ LangGraph å·¥ä½œæµ
- å®ç°æµå¼è¿›åº¦åé¦ˆ
- ä¿æŒå‘åå…¼å®¹

#### ä»»åŠ¡æ¸…å•
- [x] 4.1 åˆ›å»ºæ–° API ç«¯ç‚¹ (`/api/v2/generate-itinerary`)
- [x] 4.2 é›†æˆ LangGraph å·¥ä½œæµåˆ° API Route
- [x] 4.3 å®ç° Feature Flag åˆ‡æ¢ (`NEXT_PUBLIC_USE_LANGGRAPH`)
- [x] 4.4 å®ç° SSE æµå¼å“åº” (ä½¿ç”¨ `app.stream()`)
- [x] 4.5 æ›´æ–°å‰ç«¯è°ƒç”¨é€»è¾‘ï¼Œæ”¯æŒè¿›åº¦æ˜¾ç¤º
- [x] 4.6 æ·»åŠ  Agent æ‰§è¡Œè¿›åº¦ UI ç»„ä»¶ (`hooks/useLangGraphProgress.ts`)
- [x] 4.7 ç¼–å†™é›†æˆæµ‹è¯•
- [ ] 4.8 æ€§èƒ½å¯¹æ¯”æµ‹è¯• (å•ä½“ vs LangGraph) - å»¶ååˆ° Phase 5

#### æŠ€æœ¯è¦ç‚¹
- ä½¿ç”¨ `app.stream()` è·å–å®æ—¶æ‰§è¡ŒçŠ¶æ€
- é€šè¿‡ SSE æ¨é€ Agent æ‰§è¡Œè¿›åº¦ç»™å‰ç«¯
- Feature Flag æ§åˆ¶æ–°æ—§æ¶æ„åˆ‡æ¢
- æ—§ API ä¿æŒä¸å˜ï¼Œç¡®ä¿å‘åå…¼å®¹

#### å·²å®Œæˆçš„å®ç°
- **v2 API** (`app/api/v2/generate-itinerary/route.ts`): æ”¯æŒ SSE æµå¼å“åº”
- **Feature Flag** (`NEXT_PUBLIC_USE_LANGGRAPH`): åœ¨ `.env.example` å’Œ `lib/config/app.config.ts` ä¸­é…ç½®
- **SSE è¿›åº¦ç›‘å¬ Hook** (`hooks/useLangGraphProgress.ts`): ä½¿ç”¨ fetch + ReadableStream å®ç°
- **å‰ç«¯é›†æˆ** (`app/dashboard/create/page.tsx`): æ ¹æ® Feature Flag è‡ªåŠ¨åˆ‡æ¢ v1/v2 API
- **é›†æˆæµ‹è¯•** (`__tests__/lib/agents/`): workflow.test.ts (15 tests) + mcp-client.test.ts (11 tests)

---

### Phase 5: ä¼˜åŒ–ä¸æ‰©å±•
**çŠ¶æ€**: ğŸ”„ è¿›è¡Œä¸­

#### ç›®æ ‡
- æ€§èƒ½ä¼˜åŒ–
- æŒä¹…åŒ–å­˜å‚¨
- å¯è§‚æµ‹æ€§æå‡

#### ä»»åŠ¡æ¸…å•
- [x] 5.1 å®ç° Agent æ‰§è¡Œç»“æœç¼“å­˜
- [x] 5.2 é…ç½® PostgreSQL Checkpointer (æ›¿æ¢ MemorySaver)
- [x] 5.3 å®ç° LangGraph Tracing (é›†æˆ LangSmith æˆ–è‡ªå®šä¹‰)
- [x] 5.4 æ·»åŠ æ‰§è¡ŒæŒ‡æ ‡ç›‘æ§ (Prometheus/Grafana)
- [x] 5.5 å®ç°å·¥ä½œæµå¯è§†åŒ–è°ƒè¯•é¡µé¢
- [ ] 5.6 æ·»åŠ æ›´å¤šä¸“å®¶ Agent (å¦‚æ™¯ç‚¹è¯¦æƒ… Agent)
- [ ] 5.7 ç¼–å†™æ€§èƒ½ä¼˜åŒ–æ–‡æ¡£
- [x] 5.8 æ›´æ–° CLAUDE.md å’Œ README
- [ ] 5.9 å®Œæ•´ E2E æµ‹è¯•

#### 5.2 PostgreSQL Checkpointer å®ç°è¯¦æƒ…
**å®Œæˆæ—¥æœŸ**: 2025-11-27

å®ç°å†…å®¹ï¼š
- å®‰è£… `@langchain/langgraph-checkpoint-postgres` å’Œ `pg` ä¾èµ–
- åˆ›å»º checkpointer æ¨¡å— (`lib/agents/checkpointer.ts`)
- æ·»åŠ æ•°æ®åº“è¿ç§»è„šæœ¬ (`database/langgraph-checkpointer.sql`)
- ä¿®æ”¹ workflow.ts æ”¯æŒå¼‚æ­¥ PostgreSQL checkpointer
- æ·»åŠ æ–°çš„å·¥ä½œæµæ‰§è¡Œå‡½æ•°ï¼š
  - `createTripPlanningWorkflowAsync` - å¼‚æ­¥åˆ›å»ºå·¥ä½œæµ
  - `executeTripPlanningWorkflowWithPersistence` - æ”¯æŒæŒä¹…åŒ–çš„æ‰§è¡Œ
  - `streamTripPlanningWorkflowWithPersistence` - æ”¯æŒæŒä¹…åŒ–çš„æµå¼æ‰§è¡Œ
- æ›´æ–°ç¯å¢ƒå˜é‡é…ç½® (`.env.example`)
- æ·»åŠ  16 ä¸ªå•å…ƒæµ‹è¯•

ç‰¹æ€§ï¼š
- å¼€å‘ç¯å¢ƒé»˜è®¤ä½¿ç”¨ MemorySaverï¼Œç”Ÿäº§ç¯å¢ƒå¯åˆ‡æ¢ä¸º PostgreSQL
- æ”¯æŒä¸­æ–­æ¢å¤ï¼šé€šè¿‡ thread_id å¯ä»¥æ¢å¤ä¸­æ–­çš„å·¥ä½œæµ
- è‡ªåŠ¨æ¸…ç†ï¼šæä¾› `cleanupOldCheckpoints` å‡½æ•°å®šæœŸæ¸…ç†è¿‡æœŸæ•°æ®
- ä¼˜é›…é™çº§ï¼šPostgreSQL åˆå§‹åŒ–å¤±è´¥æ—¶è‡ªåŠ¨å›é€€åˆ° MemorySaver

é…ç½®æ–¹å¼ï¼š
```bash
# åœ¨ .env.local ä¸­é…ç½®
LANGGRAPH_CHECKPOINTER=postgres
DATABASE_URL=postgresql://user:password@host:port/database
# æˆ–ä½¿ç”¨ Supabase
SUPABASE_DB_URL=postgresql://postgres:[PASSWORD]@db.[REF].supabase.co:5432/postgres
```

#### 5.3 LangGraph Tracing å®ç°è¯¦æƒ…
**å®Œæˆæ—¥æœŸ**: 2025-11-27

å®ç°å†…å®¹ï¼š
- åˆ›å»ºè¿½è¸ªå™¨æ¨¡å— (`lib/agents/tracer.ts`)
- æ”¯æŒå¤šç§è¿½è¸ªåç«¯ï¼š
  - **Console**: è¾“å‡ºåˆ°æ§åˆ¶å°ï¼ˆé»˜è®¤ï¼Œé€‚åˆå¼€å‘è°ƒè¯•ï¼‰
  - **JSON**: è¾“å‡ºåˆ° JSON æ–‡ä»¶ï¼ˆé€‚åˆæœ¬åœ°åˆ†æï¼‰
  - **LangSmith**: é›†æˆ LangSmith å¹³å°ï¼ˆéœ€è¦ API Keyï¼‰
  - **None**: ç¦ç”¨è¿½è¸ª
- é›†æˆåˆ°æ‰€æœ‰å·¥ä½œæµæ‰§è¡Œå‡½æ•°
- æ›´æ–°ç¯å¢ƒå˜é‡é…ç½®

ç‰¹æ€§ï¼š
- **ç»Ÿä¸€æ¥å£**: æ‰€æœ‰è¿½è¸ªå™¨å®ç°ç›¸åŒçš„ `Tracer` æ¥å£
- **å±‚çº§è¿½è¸ª**: æ”¯æŒ Traceï¼ˆå·¥ä½œæµçº§åˆ«ï¼‰å’Œ Spanï¼ˆèŠ‚ç‚¹çº§åˆ«ï¼‰
- **å¯é…ç½®æ€§**: é€šè¿‡ç¯å¢ƒå˜é‡æˆ–ä»£ç é…ç½®è¿½è¸ªè¡Œä¸º
- **æ€§èƒ½å‹å¥½**: å¯é€‰è®°å½•è¾“å…¥è¾“å‡ºè¯¦æƒ…å’Œ Token ä½¿ç”¨
- **ä¼˜é›…é™çº§**: LangSmith ä¸å¯ç”¨æ—¶è‡ªåŠ¨å›é€€åˆ° Console

é…ç½®æ–¹å¼ï¼š
```bash
# åœ¨ .env.local ä¸­é…ç½®
LANGGRAPH_TRACER=console          # console | json | langsmith | none
LANGGRAPH_TRACING_ENABLED=true    # æ˜¯å¦å¯ç”¨è¿½è¸ª
LANGGRAPH_TRACE_LOG_DETAILS=false # æ˜¯å¦è®°å½•è¾“å…¥è¾“å‡ºè¯¦æƒ…
LANGGRAPH_TRACE_LOG_TOKENS=true   # æ˜¯å¦è®°å½• Token ä½¿ç”¨

# LangSmith é…ç½®ï¼ˆå¯é€‰ï¼‰
LANGSMITH_API_KEY=your_api_key
LANGSMITH_PROJECT=ai-travel-planner
```

ä»£ç ä½¿ç”¨ï¼š
```typescript
import { getTracer, withTracing } from '@/lib/agents'

// è·å–å…¨å±€è¿½è¸ªå™¨
const tracer = getTracer()

// æ‰‹åŠ¨è¿½è¸ª
const traceId = tracer.startTrace('MyWorkflow', input)
const spanId = tracer.startSpan(traceId, 'MyNode', 'node')
// ... æ‰§è¡Œé€»è¾‘
tracer.endSpan(spanId, output)
tracer.endTrace(traceId, finalOutput)

// ä½¿ç”¨è£…é¥°å™¨
const tracedFn = withTracing('MyWorkflow', myAsyncFn)
await tracedFn(input)
```

#### 5.4 æ‰§è¡ŒæŒ‡æ ‡ç›‘æ§å®ç°è¯¦æƒ…
**å®Œæˆæ—¥æœŸ**: 2025-11-28

å®ç°å†…å®¹ï¼š
- åˆ›å»ºæŒ‡æ ‡æ”¶é›†æ¨¡å— (`lib/agents/metrics.ts`)
- åˆ›å»º Prometheus æ ¼å¼æŒ‡æ ‡ç«¯ç‚¹ (`app/api/metrics/route.ts`)
- é›†æˆæŒ‡æ ‡æ”¶é›†åˆ°å·¥ä½œæµæ‰§è¡Œå‡½æ•°
- æä¾› Grafana ä»ªè¡¨æ¿é…ç½® (`monitoring/grafana-dashboard.json`)
- æä¾› Prometheus é…ç½®ç¤ºä¾‹ (`monitoring/prometheus.yml`)
- æ›´æ–°ç¯å¢ƒå˜é‡é…ç½®

æ”¶é›†çš„æŒ‡æ ‡ï¼š
- **å·¥ä½œæµæŒ‡æ ‡**:
  - `langgraph_workflow_executions_total` - å·¥ä½œæµæ‰§è¡Œæ¬¡æ•°ï¼ˆæŒ‰çŠ¶æ€åˆ†ç»„ï¼‰
  - `langgraph_workflow_duration_milliseconds` - å·¥ä½œæµæ‰§è¡ŒæŒç»­æ—¶é—´ï¼ˆç›´æ–¹å›¾ï¼‰
  - `langgraph_workflow_agents_count` - æ¯æ¬¡å·¥ä½œæµæ‰§è¡Œçš„ Agent æ•°é‡
  - `langgraph_workflow_retries_total` - é¢„ç®—é‡è¯•æ¬¡æ•°
  - `langgraph_workflow_errors_total` - å·¥ä½œæµé”™è¯¯æ¬¡æ•°
  - `langgraph_active_workflows` - å½“å‰æ´»è·ƒå·¥ä½œæµæ•°é‡

- **Agent æŒ‡æ ‡**:
  - `langgraph_agent_executions_total` - Agent æ‰§è¡Œæ¬¡æ•°ï¼ˆæŒ‰ Agent ç±»å‹å’ŒçŠ¶æ€åˆ†ç»„ï¼‰
  - `langgraph_agent_duration_milliseconds` - Agent æ‰§è¡ŒæŒç»­æ—¶é—´
  - `langgraph_agent_errors_total` - Agent é”™è¯¯æ¬¡æ•°

- **MCP å·¥å…·æŒ‡æ ‡**:
  - `langgraph_mcp_tool_calls_total` - MCP å·¥å…·è°ƒç”¨æ¬¡æ•°
  - `langgraph_mcp_tool_duration_milliseconds` - å·¥å…·è°ƒç”¨æŒç»­æ—¶é—´
  - `langgraph_mcp_cache_hits_total` - ç¼“å­˜å‘½ä¸­æ¬¡æ•°
  - `langgraph_mcp_tool_errors_total` - å·¥å…·è°ƒç”¨é”™è¯¯æ¬¡æ•°

é…ç½®æ–¹å¼ï¼š
```bash
# åœ¨ .env.local ä¸­é…ç½®
LANGGRAPH_METRICS_ENABLED=true       # æ˜¯å¦å¯ç”¨æŒ‡æ ‡æ”¶é›†
LANGGRAPH_METRICS_PREFIX=langgraph   # æŒ‡æ ‡åç§°å‰ç¼€
LANGGRAPH_METRICS_DETAILED=false     # æ˜¯å¦è®°å½•è¯¦ç»†æ ‡ç­¾
LANGGRAPH_METRICS_AUTH_TOKEN=        # å¯é€‰çš„è®¤è¯ä»¤ç‰Œ
```

ä½¿ç”¨æ–¹å¼ï¼š
1. å¯åŠ¨åº”ç”¨åè®¿é—® `http://localhost:3008/api/metrics` æŸ¥çœ‹ Prometheus æ ¼å¼æŒ‡æ ‡
2. è®¿é—® `http://localhost:3008/api/metrics?format=json` æŸ¥çœ‹ JSON æ ¼å¼æŒ‡æ ‡
3. é…ç½® Prometheus æŠ“å–æ­¤ç«¯ç‚¹ï¼ˆå‚è€ƒ `monitoring/prometheus.yml`ï¼‰
4. å¯¼å…¥ `monitoring/grafana-dashboard.json` åˆ° Grafana

ä»£ç ä½¿ç”¨ï¼š
```typescript
import { getMetricsCollector, createTimer, withAgentMetrics } from '@/lib/agents'

// è·å–å…¨å±€æŒ‡æ ‡æ”¶é›†å™¨
const metrics = getMetricsCollector()

// è®°å½•å·¥ä½œæµæ‰§è¡Œ
metrics.recordWorkflowExecution({
  workflowName: 'TripPlanningWorkflow',
  status: 'success',
  durationMs: 15000,
  agentCount: 7,
  retryCount: 0,
})

// ä½¿ç”¨è£…é¥°å™¨åŒ…è£… Agent å‡½æ•°
const trackedAgent = withAgentMetrics('weather_scout', weatherScoutAgent)
await trackedAgent(state)

// è·å– Prometheus æ ¼å¼æŒ‡æ ‡
const prometheusMetrics = metrics.getMetrics()
```

#### 5.5 å·¥ä½œæµå¯è§†åŒ–è°ƒè¯•é¡µé¢å®ç°è¯¦æƒ…
**å®Œæˆæ—¥æœŸ**: 2025-11-28

å®ç°å†…å®¹ï¼š
- åˆ›å»ºè°ƒè¯• API ç«¯ç‚¹ (`app/api/workflow-debug/route.ts`)
- åˆ›å»ºè°ƒè¯•é¡µé¢ (`app/dashboard/debug/page.tsx`)
- åœ¨ Dashboard æ·»åŠ è°ƒè¯•å…¥å£ï¼ˆä»…å¼€å‘ç¯å¢ƒæ˜¾ç¤ºï¼‰

åŠŸèƒ½ç‰¹æ€§ï¼š
- **å·¥ä½œæµçŠ¶æ€å›¾**:
  - SVG å¯è§†åŒ–å±•ç¤º LangGraph å·¥ä½œæµç»“æ„
  - æ˜¾ç¤ºæ‰€æœ‰èŠ‚ç‚¹ï¼ˆå¼€å§‹ã€Agentã€æ¡ä»¶ã€ç»“æŸï¼‰
  - æ˜¾ç¤ºè¾¹å’Œæ¡ä»¶åˆ†æ”¯ï¼ˆåŒ…æ‹¬é¢„ç®—é‡è¯•å¾ªç¯ï¼‰
  - æ”¯æŒèŠ‚ç‚¹çŠ¶æ€é«˜äº®ï¼ˆå¾…æ‰§è¡Œ/æ‰§è¡Œä¸­/å·²å®Œæˆï¼‰

- **è¿½è¸ªè®°å½•åˆ—è¡¨**:
  - æ˜¾ç¤ºæœ€è¿‘ 50 æ¡è¿½è¸ªè®°å½•
  - çŠ¶æ€æ ‡ç­¾ï¼ˆè¿è¡Œä¸­/å®Œæˆ/é”™è¯¯ï¼‰
  - æ‰§è¡Œæ—¶é—´å’ŒæŒç»­æ—¶é—´
  - æ”¯æŒé€‰æ‹©æŸ¥çœ‹è¯¦æƒ…

- **æ‰§è¡Œæ—¶é—´çº¿**:
  - æŒ‰æ—¶é—´é¡ºåºæ˜¾ç¤º Span æ‰§è¡Œ
  - å¯è§†åŒ–è¿›åº¦æ¡å¯¹æ¯”å„ Span è€—æ—¶
  - æ˜¾ç¤º Token ä½¿ç”¨ç»Ÿè®¡
  - é”™è¯¯ä¿¡æ¯é«˜äº®

- **çŠ¶æ€æ•°æ®æŸ¥çœ‹å™¨**:
  - å¯æŠ˜å çš„ JSON æ•°æ®æŸ¥çœ‹
  - æ”¯æŒæŸ¥çœ‹ç”¨æˆ·è¾“å…¥ã€æœ€ç»ˆè¾“å‡ºã€å…ƒæ•°æ®
  - ä»£ç é«˜äº®æ˜¾ç¤º

- **ç»Ÿè®¡å¡ç‰‡**:
  - æ€»æ‰§è¡Œæ¬¡æ•°ã€æˆåŠŸ/å¤±è´¥æ•°
  - å¹³å‡æ‰§è¡Œæ—¶é—´

è®¿é—®æ–¹å¼ï¼š
1. å¼€å‘ç¯å¢ƒä¸‹ï¼Œåœ¨ Dashboard é¡¶éƒ¨å¯¼èˆªæ ç‚¹å‡»ã€Œè°ƒè¯•ã€æŒ‰é’®
2. ç›´æ¥è®¿é—® `/dashboard/debug`

API ç«¯ç‚¹ï¼š
- `GET /api/workflow-debug` - è·å–è¿½è¸ªæ•°æ®å’Œç»Ÿè®¡
- `GET /api/workflow-debug?type=graph` - è·å–å·¥ä½œæµå›¾ç»“æ„
- `GET /api/workflow-debug?id=xxx` - è·å–ç‰¹å®šè¿½è¸ªè¯¦æƒ…
- `DELETE /api/workflow-debug` - æ¸…é™¤è¿½è¸ªæ•°æ®ï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰

#### æŠ€æœ¯è¦ç‚¹
- ä½¿ç”¨ `@langchain/langgraph-checkpoint-postgres` æŒä¹…åŒ–
- LangSmith æä¾›å¼€ç®±å³ç”¨çš„ Tracing
- å¯¼å‡ºå·¥ä½œæµå›¾ç”¨äºå¯è§†åŒ–

---

## Agent è¯¦ç»†è®¾è®¡

### 1. ä¸»æ§ç¼–æ’ Agent (Orchestrator)

**èŒè´£**ï¼šé¡¹ç›®ç»ç†è§’è‰²ï¼Œè´Ÿè´£çŠ¶æ€ç®¡ç†å’Œä»»åŠ¡åˆ†å‘

```typescript
interface OrchestratorAgent {
  // åˆå§‹åŒ–å…±äº«çŠ¶æ€
  initializeState(userInput: TripFormData): SharedState

  // åˆ†å‘ä»»åŠ¡ç»™ä¸“å®¶ Agent
  dispatch(agent: AgentType, context: AgentContext): Promise<AgentResult>

  // å¤„ç†åé¦ˆå¾ªç¯
  handleFeedback(feedback: BudgetFeedback): void

  // æœ€ç»ˆæ±‡æ€»
  finalize(): Itinerary
}
```

**Prompt è®¾è®¡æ€è·¯**ï¼š
- ä¸ç”Ÿæˆå…·ä½“è¡Œç¨‹ï¼Œåªç”Ÿæˆ"ä»»åŠ¡æŒ‡ä»¤"
- æŒæœ‰å®Œæ•´çš„ JSON State
- æ ¹æ®å„ Agent è¿”å›ç»“æœåšå†³ç­–

**å†³ç­–é€»è¾‘ç¤ºä¾‹**ï¼š
```
IF weather_agent.returns("æš´é›¨") THEN
  instruct_planner("ä¼˜å…ˆå®¤å†…æ™¯ç‚¹")

IF budget_agent.returns("è¶…æ”¯") THEN
  instruct_hotel_agent("å¯»æ‰¾æ›´ä¾¿å®œçš„ä½å®¿")
  retry_budget_check()
```

---

### 2. å¤©æ°”æ„ŸçŸ¥ Agent (Weather Scout)

**èŒè´£**ï¼šå‰ç½®é¢„å¤„ç†ï¼Œè·å–ç¯å¢ƒä¸Šä¸‹æ–‡

**MCP å·¥å…·**ï¼š
- `amap_mcp.get_weather_forecast(city, date)`

**è¾“å…¥**ï¼š
```typescript
interface WeatherInput {
  destination: string
  startDate: string
  endDate: string
}
```

**è¾“å‡º**ï¼š
```typescript
interface WeatherOutput {
  forecasts: DayForecast[]
  strategyTags: StrategyTag[]
  clothingAdvice: string
  warnings: string[]
}

type StrategyTag =
  | 'indoor_priority'      // ä¼˜å…ˆå®¤å†…æ´»åŠ¨
  | 'outdoor_friendly'     // é€‚åˆæˆ·å¤–
  | 'rain_prepared'        // éœ€å¸¦é›¨å…·
  | 'cold_weather'         // å¤©æ°”å¯’å†·
  | 'hot_weather'          // å¤©æ°”ç‚çƒ­
```

**Prompt æ ¸å¿ƒ**ï¼š
```
ä½ æ˜¯å¤©æ°”åˆ†æä¸“å®¶ã€‚åˆ†æç›®çš„åœ°å¤©æ°”é¢„æŠ¥å¹¶è¾“å‡ºç­–ç•¥å»ºè®®ã€‚

æ ¹æ®å¤©æ°”æƒ…å†µè¾“å‡ºä»¥ä¸‹ç­–ç•¥æ ‡ç­¾ï¼š
- å¦‚æœæœ‰é›¨ï¼šæ·»åŠ  "indoor_priority" å’Œ "rain_prepared"
- å¦‚æœæ¸©åº¦ < 10Â°Cï¼šæ·»åŠ  "cold_weather"
- å¦‚æœæ¸©åº¦ > 30Â°Cï¼šæ·»åŠ  "hot_weather"
- å¦‚æœæ™´æœ—æ— é£ï¼šæ·»åŠ  "outdoor_friendly"

è¾“å‡ºæ ¼å¼ä¸º JSONã€‚
```

---

### 3. æ ¸å¿ƒè§„åˆ’ Agent (Itinerary Planner)

**èŒè´£**ï¼šç”Ÿæˆè¡Œç¨‹éª¨æ¶ï¼ˆæ™¯ç‚¹é¡ºåºï¼‰

**MCP å·¥å…·**ï¼š
- `amap_mcp.search_poi(keywords, city)` - ç¡®è®¤æ™¯ç‚¹å­˜åœ¨
- `amap_mcp.geocode(address)` - è·å–åæ ‡

**è¾“å…¥**ï¼š
```typescript
interface PlannerInput {
  userRequest: TripFormData
  weatherContext: WeatherOutput
}
```

**è¾“å‡º**ï¼š
```typescript
interface DraftItinerary {
  days: DraftDay[]
  totalAttractions: number
  totalMeals: number
}

interface DraftDay {
  day: number
  date: string
  attractions: AttractionSlot[]  // åªæœ‰åç§°å’Œæ—¶é—´ï¼Œæ— è¯¦ç»†ä¿¡æ¯
  mealSlots: MealSlot[]
}
```

**Prompt æ ¸å¿ƒ**ï¼š
```
ä½ æ˜¯ä¸“ä¸šæ—…è¡Œè§„åˆ’å¸ˆã€‚æ ¹æ®ç”¨æˆ·éœ€æ±‚å’Œå¤©æ°”ç­–ç•¥ç”Ÿæˆè¡Œç¨‹æ¡†æ¶ã€‚

å¤©æ°”ç­–ç•¥ï¼š{strategy_tags}
- å¦‚æœåŒ…å« "indoor_priority"ï¼šæ¯å¤©è‡³å°‘å®‰æ’ 1 ä¸ªå®¤å†…æ™¯ç‚¹
- å¦‚æœåŒ…å« "hot_weather"ï¼šé¿å…ä¸­åˆ 12-14 ç‚¹å®‰æ’æˆ·å¤–æ´»åŠ¨

è¾“å‡ºæ™¯ç‚¹é¡ºåºé“¾è¡¨ï¼Œè€ƒè™‘ï¼š
1. åœ°ç†ä½ç½®ç›¸è¿‘æ€§
2. å¼€æ”¾æ—¶é—´
3. æ¸¸ç©æ—¶é•¿
4. é¤é¥®æ—¶é—´åˆç†æ€§
```

---

### 4. é…’åº—ä¸“å®¶ Agent (Accommodation Specialist)

**èŒè´£**ï¼šæ¨èä½å®¿

**MCP å·¥å…·**ï¼š
- `amap_mcp.search_hotels(location, radius, keywords)`
- `amap_mcp.search_nearby(location, type: 'hotel')`

**æ™ºèƒ½é€»è¾‘**ï¼š
1. è®¡ç®—æ¯æ—¥è¡Œç¨‹çš„åœ°ç†ä¸­å¿ƒç‚¹ (Centroid)
2. åœ¨ä¸­å¿ƒç‚¹é™„è¿‘æœç´¢é…’åº—
3. æ ¹æ®ç”¨æˆ·åå¥½è¿‡æ»¤ï¼ˆå®‰é™ã€è¿‘åœ°é“ã€ä»·æ ¼ï¼‰

**è¾“å‡º**ï¼š
```typescript
interface AccommodationResult {
  recommendations: HotelRecommendation[]
  totalCost: number
  centroidLocation: Location
}
```

---

### 5. äº¤é€šè°ƒåº¦ Agent (Transport Logistician)

**èŒè´£**ï¼šè®¡ç®—äº¤é€šè·¯çº¿å’Œè´¹ç”¨

**MCP å·¥å…·**ï¼š
- `amap_mcp.get_driving_route(origin, destination)`
- `amap_mcp.get_transit_route(origin, destination, city)`
- `amap_mcp.get_walking_route(origin, destination)`
- `amap_mcp.calculate_distance(origins, destinations)`

**è¾“å‡º**ï¼š
```typescript
interface TransportResult {
  segments: TransportSegment[]
  totalTime: number      // åˆ†é’Ÿ
  totalCost: number      // å…ƒ
  recommendedModes: TransportMode[]
}

interface TransportSegment {
  from: Location
  to: Location
  mode: 'driving' | 'transit' | 'walking'
  duration: number
  distance: number
  cost: number
  polyline?: string      // è·¯çº¿è½¨è¿¹
}
```

---

### 6. é¢„ç®—å®¡è®¡ Agent (Budget Critic)

**èŒè´£**ï¼šåç½®æ ¡éªŒï¼Œæ±‡æ€»æˆæœ¬

**å·¥å…·**ï¼šæ— ï¼ˆçº¯è®¡ç®—é€»è¾‘ï¼‰

**è¾“å…¥**ï¼š
```typescript
interface BudgetInput {
  userBudget: number
  accommodationCost: number
  transportCost: number
  mealCost: number
  attractionCost: number
  miscCost: number
}
```

**è¾“å‡º**ï¼š
```typescript
interface BudgetResult {
  totalCost: number
  budgetUtilization: number    // 0-1
  isWithinBudget: boolean
  feedback?: BudgetFeedback
}

interface BudgetFeedback {
  action: 'downgrade_hotel' | 'reduce_attractions' | 'cheaper_transport' | 'adjust_meals'
  targetReduction: number
  suggestion: string
}
```

**åˆ¤å®šé€»è¾‘**ï¼š
```
IF Total > Budget * 1.1 THEN
  è¿”å› feedback è§¦å‘åé¦ˆå¾ªç¯
ELSE
  é€šè¿‡å®¡è®¡
```

---

## MCP Server è®¾è®¡

### ç›®å½•ç»“æ„

```
mcp-servers/
â””â”€â”€ amap/
    â”œâ”€â”€ package.json
    â”œâ”€â”€ tsconfig.json
    â”œâ”€â”€ src/
    â”‚   â”œâ”€â”€ index.ts           # å…¥å£
    â”‚   â”œâ”€â”€ server.ts          # MCP Server ä¸»ç±»
    â”‚   â”œâ”€â”€ tools/
    â”‚   â”‚   â”œâ”€â”€ weather.ts     # å¤©æ°”æŸ¥è¯¢
    â”‚   â”‚   â”œâ”€â”€ poi.ts         # POI æœç´¢
    â”‚   â”‚   â”œâ”€â”€ route.ts       # è·¯çº¿è§„åˆ’
    â”‚   â”‚   â”œâ”€â”€ geocode.ts     # åœ°ç†ç¼–ç 
    â”‚   â”‚   â””â”€â”€ distance.ts    # è·ç¦»è®¡ç®—
    â”‚   â”œâ”€â”€ utils/
    â”‚   â”‚   â”œâ”€â”€ http.ts        # HTTP è¯·æ±‚å°è£…
    â”‚   â”‚   â””â”€â”€ transform.ts   # æ•°æ®è½¬æ¢
    â”‚   â””â”€â”€ types.ts           # ç±»å‹å®šä¹‰
    â””â”€â”€ tests/
        â””â”€â”€ *.test.ts
```

### å·¥å…·å®šä¹‰ Schema

```typescript
// å¤©æ°”æŸ¥è¯¢
const weatherTool = {
  name: 'get_weather_forecast',
  description: 'è·å–åŸå¸‚å¤©æ°”é¢„æŠ¥ï¼ˆæœªæ¥ 3 å¤©ï¼‰',
  inputSchema: {
    type: 'object',
    properties: {
      city: { type: 'string', description: 'åŸå¸‚åç§°' },
      date: { type: 'string', description: 'æŸ¥è¯¢æ—¥æœŸ (YYYY-MM-DD)' }
    },
    required: ['city']
  }
}

// POI æœç´¢
const poiSearchTool = {
  name: 'search_poi',
  description: 'å…³é”®è¯æœç´¢ POI åœ°ç‚¹',
  inputSchema: {
    type: 'object',
    properties: {
      keywords: { type: 'string', description: 'æœç´¢å…³é”®è¯' },
      city: { type: 'string', description: 'åŸå¸‚åç§°' },
      types: { type: 'string', description: 'POI ç±»å‹ä»£ç ' },
      page_size: { type: 'number', description: 'è¿”å›æ•°é‡', default: 10 }
    },
    required: ['keywords']
  }
}

// è·¯çº¿è§„åˆ’
const drivingRouteTool = {
  name: 'get_driving_route',
  description: 'è·å–é©¾è½¦è·¯çº¿è§„åˆ’',
  inputSchema: {
    type: 'object',
    properties: {
      origin: { type: 'string', description: 'èµ·ç‚¹åæ ‡ (lng,lat)' },
      destination: { type: 'string', description: 'ç»ˆç‚¹åæ ‡ (lng,lat)' },
      strategy: { type: 'number', description: 'è·¯çº¿ç­–ç•¥', default: 0 }
    },
    required: ['origin', 'destination']
  }
}
```

### é…ç½®æ–¹å¼

**SSE æ¨¡å¼ (å¼€å‘/æµ‹è¯•)**ï¼š
```json
{
  "mcpServers": {
    "amap-sse": {
      "url": "http://localhost:3009/sse"
    }
  }
}
```

**Node.js stdio æ¨¡å¼ (ç”Ÿäº§)**ï¼š
```json
{
  "mcpServers": {
    "amap": {
      "command": "node",
      "args": ["./mcp-servers/amap/dist/index.js"],
      "env": {
        "AMAP_API_KEY": "${AMAP_WEB_SERVICE_KEY}"
      }
    }
  }
}
```

---

## æ•°æ®æµä¸çŠ¶æ€ç®¡ç†

### å…±äº«çŠ¶æ€ç»“æ„

```typescript
interface SharedState {
  // ç”¨æˆ·è¾“å…¥
  userInput: TripFormData

  // ç¯å¢ƒä¸Šä¸‹æ–‡
  environment: {
    weather: WeatherOutput | null
    strategyTags: StrategyTag[]
  }

  // è‰ç¨¿è¡Œç¨‹
  draftItinerary: DraftItinerary | null

  // èµ„æºå¡«å……ç»“æœ
  resources: {
    accommodation: AccommodationResult | null
    transport: TransportResult | null
    dining: DiningResult | null
  }

  // é¢„ç®—å®¡è®¡
  budget: {
    result: BudgetResult | null
    feedbackHistory: BudgetFeedback[]
    retryCount: number
  }

  // æœ€ç»ˆè¾“å‡º
  finalItinerary: Itinerary | null

  // å…ƒä¿¡æ¯
  meta: {
    startTime: number
    agentExecutions: AgentExecution[]
    errors: AgentError[]
  }
}

interface AgentExecution {
  agent: string
  startTime: number
  endTime: number
  status: 'success' | 'failed' | 'skipped'
  toolCalls: ToolCall[]
}
```

### çŠ¶æ€æµè½¬

```
Initial State
    â”‚
    â–¼ [Weather Scout]
State.environment.weather = {...}
State.environment.strategyTags = [...]
    â”‚
    â–¼ [Itinerary Planner]
State.draftItinerary = {...}
    â”‚
    â–¼ [Resource Agents - Parallel]
State.resources.accommodation = {...}
State.resources.transport = {...}
State.resources.dining = {...}
    â”‚
    â–¼ [Budget Critic]
State.budget.result = {...}
    â”‚
    â”œâ”€â–º [Pass] â†’ State.finalItinerary = {...}
    â”‚
    â””â”€â–º [Fail] â†’ State.budget.feedbackHistory.push(feedback)
                State.budget.retryCount++
                â†’ è¿”å› Orchestrator é‡æ–°è°ƒåº¦
```

---

## æŠ€æœ¯é€‰å‹

### æ ¸å¿ƒä¾èµ–

| ç”¨é€” | é€‰å‹ | ç†ç”± |
|------|------|------|
| **Agent ç¼–æ’** | `@langchain/langgraph` | çŠ¶æ€å›¾ç¼–æ’ï¼ŒåŸç”Ÿå¾ªç¯/å¹¶è¡Œæ”¯æŒ |
| **LangChain æ ¸å¿ƒ** | `@langchain/core` | LangGraph ä¾èµ– |
| MCP SDK | `@modelcontextprotocol/sdk` | å®˜æ–¹ SDKï¼ŒTypeScript æ”¯æŒ |
| AI è°ƒç”¨ | `openai` (ç°æœ‰) | å…¼å®¹ DeepSeek/ModelScope |
| æ£€æŸ¥ç‚¹å­˜å‚¨ | `MemorySaver` â†’ `PostgresSaver` | å¼€å‘ç”¨å†…å­˜ï¼Œç”Ÿäº§ç”¨ PG |
| HTTP è¯·æ±‚ | `node:https` (ç°æœ‰) | ç»•è¿‡ä»£ç†é—®é¢˜ |
| æµ‹è¯• | `vitest` (ç°æœ‰) | é¡¹ç›®å·²é…ç½® |

### æ–°å¢ä¾èµ–å®‰è£…

```bash
npm install @langchain/langgraph @langchain/core
# å¯é€‰ï¼šç”Ÿäº§ç¯å¢ƒæŒä¹…åŒ–
npm install @langchain/langgraph-checkpoint-postgres
```

### æ–‡ä»¶ç»“æ„

```
lib/
â”œâ”€â”€ agents/                         # LangGraph Agent æ¨¡å—
â”‚   â”œâ”€â”€ state.ts                   # TripState Annotation å®šä¹‰
â”‚   â”œâ”€â”€ workflow.ts                # StateGraph å·¥ä½œæµå®šä¹‰
â”‚   â”œâ”€â”€ mcp-client.ts              # MCP å®¢æˆ·ç«¯å°è£…
â”‚   â”œâ”€â”€ nodes/                     # Agent èŠ‚ç‚¹å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ weather-scout.ts
â”‚   â”‚   â”œâ”€â”€ itinerary-planner.ts
â”‚   â”‚   â”œâ”€â”€ accommodation.ts
â”‚   â”‚   â”œâ”€â”€ transport.ts
â”‚   â”‚   â”œâ”€â”€ dining.ts
â”‚   â”‚   â”œâ”€â”€ budget-critic.ts
â”‚   â”‚   â””â”€â”€ finalize.ts
â”‚   â”œâ”€â”€ prompts/                   # Agent System Prompts
â”‚   â”‚   â”œâ”€â”€ weather-scout.ts
â”‚   â”‚   â”œâ”€â”€ itinerary-planner.ts
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ index.ts                   # ç»Ÿä¸€å¯¼å‡º
â”‚
mcp-servers/                        # MCP Server ç‹¬ç«‹é¡¹ç›®
â””â”€â”€ amap/
    â”œâ”€â”€ package.json
    â”œâ”€â”€ src/
    â””â”€â”€ tests/
```

### LangGraph ä¸ç°æœ‰ä»£ç é›†æˆ

```typescript
// lib/agents/nodes/weather-scout.ts
import { createAIClient } from '@/app/api/_utils/ai-helper';
import { getWeatherByCityName } from '@/lib/amap-weather';
import type { TripState } from '../state';

export async function weatherScoutAgent(
  state: TripState
): Promise<Partial<TripState>> {
  // å¤ç”¨ç°æœ‰çš„å¤©æ°” API å°è£…
  const weatherData = await getWeatherByCityName(state.userInput.destination);

  // å¤ç”¨ç°æœ‰çš„ AI å®¢æˆ·ç«¯
  const aiClient = createAIClient({ apiKey, baseURL });

  // ... AI åˆ†æé€»è¾‘

  return { weather: result };
}
```

---

## é£é™©ä¸æŒ‘æˆ˜

### æŠ€æœ¯é£é™©

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|----------|
| LangGraph å­¦ä¹ æ›²çº¿ | å¼€å‘é€Ÿåº¦ä¸‹é™ | å‚è€ƒå®˜æ–¹æ•™ç¨‹ï¼Œä»ç®€å•æµç¨‹å¼€å§‹ |
| MCP åè®®å¤æ‚åº¦ | é›†æˆå›°éš¾ | å‚è€ƒå®˜æ–¹ç¤ºä¾‹ï¼Œé€æ­¥å®ç° |
| Agent æ‰§è¡Œæ—¶é—´é•¿ | ç”¨æˆ·ä½“éªŒå·® | ä½¿ç”¨ `stream()` + SSE è¿›åº¦åé¦ˆ |
| åé¦ˆå¾ªç¯æ­»å¾ªç¯ | æ— æ³•ç”Ÿæˆç»“æœ | é™åˆ¶ `retryCount <= 3` |
| é«˜å¾· API é™æµ | è¯·æ±‚å¤±è´¥ | æ·»åŠ è¯·æ±‚é—´éš” + é‡è¯•æœºåˆ¶ |
| ä¾èµ–ä½“ç§¯å¢åŠ  | æ„å»ºå˜æ…¢ | LangGraph ä»…æœåŠ¡ç«¯ä½¿ç”¨ï¼Œä¸å½±å“å‰ç«¯ |

### LangGraph ç‰¹å®šæ³¨æ„äº‹é¡¹

1. **çŠ¶æ€ä¸å¯å˜æ€§**ï¼šä½¿ç”¨ Annotation reducer ç¡®ä¿çŠ¶æ€æ­£ç¡®åˆå¹¶
2. **å¹¶è¡ŒèŠ‚ç‚¹ç­‰å¾…**ï¼šFan-in èŠ‚ç‚¹éœ€ç­‰å¾…æ‰€æœ‰ä¸Šæ¸¸èŠ‚ç‚¹å®Œæˆ
3. **ç±»å‹å®‰å…¨**ï¼šä½¿ç”¨ TypeScript æ³›å‹ç¡®ä¿çŠ¶æ€ç±»å‹æ­£ç¡®
4. **è°ƒè¯•**ï¼šä½¿ç”¨ `console.log` æˆ– LangSmith è¿½è¸ªæ‰§è¡Œæµç¨‹

### å…¼å®¹æ€§è€ƒè™‘

1. **å‘åå…¼å®¹**ï¼šä¿ç•™ `/api/generate-itinerary` åŸæœ‰å®ç°
2. **æ¸è¿›è¿ç§»**ï¼šä½¿ç”¨ Feature Flag æ§åˆ¶æ–°æ¶æ„å¯ç”¨
3. **é™çº§ç­–ç•¥**ï¼šæ–°æ¶æ„å¤±è´¥æ—¶å›é€€åˆ°å•ä½“è°ƒç”¨

---

## è¿›åº¦è¿½è¸ª

### Phase 1: MCP åŸºç¡€è®¾æ–½
| ä»»åŠ¡ | çŠ¶æ€ | å®Œæˆæ—¥æœŸ |
|------|------|----------|
| 1.1 åˆ›å»º MCP Server é¡¹ç›®ç»“æ„ | [x] | 2025-11-26 |
| 1.2 å®ç°å¤©æ°”æŸ¥è¯¢å·¥å…· | [x] | 2025-11-26 |
| 1.3 å®ç° POI æœç´¢å·¥å…· | [x] | 2025-11-26 |
| 1.4 å®ç°è·¯çº¿è§„åˆ’å·¥å…· | [x] | 2025-11-26 |
| 1.5 å®ç°åœ°ç†ç¼–ç å·¥å…· | [x] | 2025-11-26 |
| 1.6 å®ç°è·ç¦»è®¡ç®—å·¥å…· | [x] | 2025-11-26 |
| 1.7 ç¼–å†™å•å…ƒæµ‹è¯• | [x] | 2025-11-26 |
| 1.8 é…ç½®è¿æ¥æ¨¡å¼ | [x] | 2025-11-26 |
| 1.9 ç¼–å†™æ–‡æ¡£ | [x] | 2025-11-26 |

### Phase 2: LangGraph æ¡†æ¶æ­å»º
| ä»»åŠ¡ | çŠ¶æ€ | å®Œæˆæ—¥æœŸ |
|------|------|----------|
| 2.1 å®‰è£… LangGraph ä¾èµ– | [x] | 2025-11-26 |
| 2.2 å®šä¹‰ TripState Annotation | [x] | 2025-11-26 |
| 2.3 åˆ›å»º StateGraph å·¥ä½œæµ | [x] | 2025-11-26 |
| 2.4 å®ç° MCP å®¢æˆ·ç«¯å°è£… | [x] | 2025-11-26 |
| 2.5 å®ç°çº¿æ€§æµç¨‹ | [x] | 2025-11-26 |
| 2.6 æ·»åŠ æ¡ä»¶è¾¹å’Œå¾ªç¯è¾¹ | [x] | 2025-11-26 |
| 2.7 å®ç°å¹¶è¡ŒèŠ‚ç‚¹ | [x] | 2025-11-26 |
| 2.8 é…ç½® Checkpointer | [x] | 2025-11-26 |
| 2.9 ç¼–å†™å·¥ä½œæµæµ‹è¯• | [ ] | - |

### Phase 3: ä¸“å®¶ Agent å®ç°
| ä»»åŠ¡ | çŠ¶æ€ | å®Œæˆæ—¥æœŸ |
|------|------|----------|
| 3.1 Weather Scout Agent | [x] | 2025-11-26 |
| 3.2 Itinerary Planner Agent | [x] | 2025-11-26 |
| 3.3 Accommodation Agent | [x] | 2025-11-26 |
| 3.4 Transport Agent | [x] | 2025-11-26 |
| 3.5 Dining Agent | [x] | 2025-11-26 |
| 3.6 Budget Critic Agent | [x] | 2025-11-26 |
| 3.7 Finalize Agent | [x] | 2025-11-26 |
| 3.8 ç¼–å†™ Agent Prompts | [x] | 2025-11-26 |
| 3.9 ç¼–å†™ Agent æµ‹è¯• | [ ] | - |

### Phase 4: API é›†æˆä¸è¿ç§»
| ä»»åŠ¡ | çŠ¶æ€ | å®Œæˆæ—¥æœŸ |
|------|------|----------|
| 4.1 åˆ›å»º v2 API | [x] | 2025-11-27 |
| 4.2 é›†æˆ LangGraph å·¥ä½œæµ | [x] | 2025-11-27 |
| 4.3 Feature Flag | [x] | 2025-11-27 |
| 4.4 SSE æµå¼å“åº” | [x] | 2025-11-27 |
| 4.5 æ›´æ–°å‰ç«¯ | [x] | 2025-11-27 |
| 4.6 è¿›åº¦ UI ç»„ä»¶ | [x] | 2025-11-27 |
| 4.7 é›†æˆæµ‹è¯• | [x] | 2025-11-27 |
| 4.8 æ€§èƒ½æµ‹è¯• | [ ] | - (å»¶ååˆ° Phase 5) |

### Phase 5: ä¼˜åŒ–ä¸æ‰©å±•
| ä»»åŠ¡ | çŠ¶æ€ | å®Œæˆæ—¥æœŸ |
|------|------|----------|
| 5.1 ç»“æœç¼“å­˜ | [x] | 2025-11-27 |
| 5.2 PostgreSQL Checkpointer | [x] | 2025-11-27 |
| 5.3 LangGraph Tracing | [x] | 2025-11-27 |
| 5.4 æŒ‡æ ‡ç›‘æ§ | [x] | 2025-11-28 |
| 5.5 å·¥ä½œæµå¯è§†åŒ– | [x] | 2025-11-28 |
| 5.6 æ‰©å±• Agent | [ ] | - |
| 5.7 ä¼˜åŒ–æ–‡æ¡£ | [ ] | - |
| 5.8 æ›´æ–° README | [x] | 2025-11-27 |
| 5.9 E2E æµ‹è¯• | [ ] | - |

---

## å‚è€ƒèµ„æº

### LangGraph å­¦ä¹ èµ„æº
- [LangGraph å®˜æ–¹æ–‡æ¡£](https://langchain-ai.github.io/langgraph/)
- [LangGraph å¿«é€Ÿå…¥é—¨](https://langchain-ai.github.io/langgraph/tutorials/introduction/)
- [LangGraph TypeScript API](https://langchain-ai.github.io/langgraphjs/)
- [LangGraph çŠ¶æ€å›¾æ¦‚å¿µ](https://langchain-ai.github.io/langgraph/concepts/)
- [LangGraph æ£€æŸ¥ç‚¹ä¸æŒä¹…åŒ–](https://langchain-ai.github.io/langgraph/concepts/persistence/)

### MCP ç›¸å…³èµ„æº
- [Model Context Protocol å®˜æ–¹æ–‡æ¡£](https://modelcontextprotocol.io/)
- [é«˜å¾·åœ°å›¾ MCP Server æ•™ç¨‹](https://blog.csdn.net/Dontla/article/details/147577827)
- [é«˜å¾·åœ°å›¾ Web æœåŠ¡ API](https://lbs.amap.com/api/webservice/summary)
- [MCP å¼€å‘å®æˆ˜æ•™ç¨‹](https://www.cnblogs.com/hogwarts/p/19050887)

### å…¶ä»–èµ„æº
- [LangSmith è¿½è¸ªå¹³å°](https://smith.langchain.com/)
- [é«˜å¾·å¼€æ”¾å¹³å°æ§åˆ¶å°](https://console.amap.com/)

---

*æœ€åæ›´æ–°: 2025-11-28*
*æŠ€æœ¯é€‰å‹: LangGraph + MCP*
*Phase 1 å®Œæˆ: 2025-11-26*
*Phase 2 å®Œæˆ: 2025-11-26*
*Phase 3 å®Œæˆ: 2025-11-26*
*Phase 4 å®Œæˆ: 2025-11-27*
*Phase 5 è¿›è¡Œä¸­: 5.1, 5.2, 5.3, 5.4, 5.5, 5.8 å·²å®Œæˆ*
